{% extends 'base.html' %}
{% load static %}
{% load message_card_filters %}

{% block title %}{{ page_title }} - Celio{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/emergency_card_themes.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block extra_css %}
    <style>
        /* Removed inline CSS variables and body styles to avoid conflicts with external CSS */
    
    /* Enhanced Mobile Responsiveness */
    @media (max-width: 1024px) {
        .order-1 {
            order: 2;
        }
        
        .order-2 {
            order: 1;
        }
    }
    
    /* Mobile-first improvements */
    @media (max-width: 640px) {
        .primary-gradient-bg {
            background-attachment: scroll;
        }
        
        /* Improve card visibility on mobile */
        .editable-card {
            max-width: 100%;
            margin: 0 auto;
        }
        
        /* Better spacing for mobile */
        .form-section {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Optimize text sizes for mobile */
        h1 {
            line-height: 1.2;
        }
        
        /* Improve button accessibility on mobile */
        button, .btn {
            min-height: 44px;
            padding: 0.75rem 1rem;
        }
    }
    
    /* Tablet optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
        .max-w-4xl {
            max-width: 90%;
        }
    }
    
    /* Section styling */
    .form-section {
        background-color: rgba(20, 50, 42, 0.3);
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        padding: 1.75rem;
        border: 1px solid rgba(150, 150, 150, 0.7);
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        padding: 0;
        border-bottom: 1px solid rgba(26, 66, 55, 0.7);
        background-color: transparent;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header h2 {
        color: white;
        font-weight: 600;
    }
    
    /* Improved form controls */
    .form-group {
        margin-bottom: 2.25rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        color: white;
        margin-bottom: 0.75rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        background-color: rgba(20, 50, 42, 0.2);
        color: white;
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--teal-400);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
    }
    
    .form-textarea {
        min-height: 8rem;
    }
    
    .form-hint {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--teal-200);
    }
    
    .error-text {
        color: #f87171;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Action buttons with improved styling and green animations */
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        animation: green-pulse 2s infinite;
    }
    
    .action-button-primary {
        background-color: var(--teal-600);
        color: white;
        border: none;
        animation: green-pulse 2s infinite;
        box-shadow: 0 0 10px rgba(45, 212, 191, 0.3);
    }
    
    .action-button-primary:hover {
        background-color: var(--teal-500);
        animation-play-state: paused;
        box-shadow: 0 0 15px rgba(45, 212, 191, 0.5);
    }
    
    .action-button-secondary {
        background-color: rgba(20, 50, 42, 0.4);
        color: white;
        border: 1px solid var(--spruce-700);
        animation: green-pulse 2.5s infinite;
    }

    .action-button-secondary:hover {
        background-color: rgba(20, 50, 42, 0.6);
        animation-play-state: paused;
    }
    
    /* Intro panel */
    .intro-panel {
        background-color: rgba(20, 50, 42, 0.25);
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(200, 200, 200, 0.5);
        margin-bottom: 2rem;
        backdrop-filter: blur(8px);
    }
    
    .intro-panel h3 {
        color: white;
    }
    
    .intro-panel p {
        color: var(--teal-200);
    }
    
    .dismiss-intro {
        color: var(--teal-400);
    }
    
    .dismiss-intro:hover {
        color: var(--teal-300);
    }
    
    /* Language tabs */
    .language-tab {
        color: var(--teal-300);
        border-bottom-color: transparent;
    }
    
    .language-tab[aria-selected="true"] {
        color: white;
        border-bottom-color: var(--teal-400);
    }
    
    .language-tab:hover:not([aria-selected="true"]) {
        color: var(--teal-200);
    }
    
    /* Card preview style */
    #card-preview {
        background-color: var(--primary-900);
        border: 1px solid var(--primary-700);
        border-radius: 0.5rem;
    }
    
    /* Travel-themed gradient background */
    .primary-gradient-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -10;
        background: var(--spruce-950);
        overflow: hidden;
    }
    
    .primary-gradient-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(45, 212, 191, 0.03) 0%, rgba(16, 185, 129, 0.02) 100%);
        z-index: -2;
    }
    
    .gradient-accent {
        position: absolute;
        border-radius: 50%;
        animation: float 12s ease-in-out infinite;
        z-index: -1;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-15px) rotate(90deg); }
    }
    
    @media (max-width: 768px) {
        .gradient-accent {
            animation: floatMobile 8s ease-in-out infinite;
        }
        
        @keyframes floatMobile {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(45deg); }
        }
    }
    
    .gradient-accent-1 {
        width: 50vw;
        height: 50vw;
        background: radial-gradient(circle, rgba(34, 197, 94, 0.25) 0%, rgba(16, 185, 129, 0.15) 50%, transparent 70%);
        top: -15%;
        right: -15%;
        animation-delay: -2s;
    }
    
    .gradient-accent-2 {
        width: 35vw;
        height: 35vw;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(34, 197, 94, 0.12) 50%, transparent 70%);
        bottom: -15%;
        left: -15%;
        animation-delay: -4s;
    }
    
    /* Star emoji animations */
    .star-emoji {
        display: inline-block;
        animation: starTwinkle 2s ease-in-out infinite;
    }
    
    @keyframes starTwinkle {
        0%, 100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
        25% {
            transform: scale(1.2) rotate(5deg);
            opacity: 0.8;
        }
        50% {
            transform: scale(1.1) rotate(-5deg);
            opacity: 1;
        }
        75% {
            transform: scale(1.3) rotate(3deg);
            opacity: 0.9;
        }
    }
    
    /* Stagger the animation for the second star */
    .star-emoji:last-child {
        animation-delay: 1s;
    }
    
    /* Floating orbs for CTA background animation */
    .floating-orb {
        position: absolute;
        border-radius: 50%;
        background: linear-gradient(45deg, rgba(45, 212, 191, 0.3), rgba(16, 185, 129, 0.2));
        animation: floatOrb 8s ease-in-out infinite;
        filter: blur(1px);
    }
    
    .floating-orb-1 {
        width: 60px;
        height: 60px;
        top: 10%;
        left: 15%;
        animation-delay: 0s;
    }
    
    .floating-orb-2 {
        width: 40px;
        height: 40px;
        top: 60%;
        right: 20%;
        animation-delay: -3s;
    }
    
    .floating-orb-3 {
        width: 30px;
        height: 30px;
        bottom: 20%;
        left: 70%;
        animation-delay: -6s;
    }
    
    @keyframes floatOrb {
        0%, 100% {
            transform: translateY(0px) translateX(0px) scale(1);
            opacity: 0.3;
        }
        25% {
            transform: translateY(-20px) translateX(10px) scale(1.1);
            opacity: 0.5;
        }
        50% {
            transform: translateY(-10px) translateX(-15px) scale(0.9);
            opacity: 0.4;
        }
        75% {
            transform: translateY(-30px) translateX(5px) scale(1.05);
            opacity: 0.6;
        }
    }
    
    /* Enhanced mobile-friendly green background animations */
    .primary-gradient-bg::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(45, 212, 191, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(34, 197, 94, 0.06) 0%, transparent 50%);
        animation: subtleBackgroundShift 20s ease-in-out infinite;
        z-index: -1;
    }
    
    .primary-gradient-bg::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 60% 30%, rgba(45, 212, 191, 0.04) 0%, transparent 60%),
            radial-gradient(circle at 30% 70%, rgba(16, 185, 129, 0.04) 0%, transparent 60%);
        animation: subtleBackgroundShift 25s ease-in-out infinite reverse;
        z-index: -1;
    }
    
    @keyframes subtleBackgroundShift {
        0%, 100% {
            transform: translateX(0) translateY(0) scale(1);
            opacity: 0.8;
        }
        25% {
            transform: translateX(-15px) translateY(-8px) scale(1.03);
            opacity: 0.9;
        }
        50% {
            transform: translateX(8px) translateY(-12px) scale(0.97);
            opacity: 1;
        }
        75% {
            transform: translateX(-8px) translateY(8px) scale(1.02);
            opacity: 0.85;
        }
    }
    
    /* Enhanced floating green particles */
    .green-particle {
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(45, 212, 191, 0.8) 0%, rgba(45, 212, 191, 0.4) 50%, transparent 100%);
        animation: floatParticle 12s ease-in-out infinite;
        pointer-events: none;
        z-index: -1;
        box-shadow: 0 0 10px rgba(45, 212, 191, 0.3);
    }
    
    .green-particle-1 {
        width: 6px;
        height: 6px;
        top: 15%;
        left: 10%;
        animation-delay: 0s;
    }
    
    .green-particle-2 {
        width: 8px;
        height: 8px;
        top: 25%;
        right: 15%;
        animation-delay: -3s;
    }
    
    .green-particle-3 {
        width: 5px;
        height: 5px;
        bottom: 30%;
        left: 20%;
        animation-delay: -6s;
    }
    
    .green-particle-4 {
        width: 7px;
        height: 7px;
        top: 60%;
        right: 25%;
        animation-delay: -9s;
    }
    
    @keyframes floatParticle {
        0%, 100% {
            transform: translateY(0px) translateX(0px) scale(1);
            opacity: 0.4;
        }
        25% {
            transform: translateY(-25px) translateX(15px) scale(1.2);
            opacity: 0.8;
        }
        50% {
            transform: translateY(-15px) translateX(-20px) scale(0.8);
            opacity: 0.6;
        }
        75% {
            transform: translateY(-35px) translateX(10px) scale(1.1);
            opacity: 0.9;
        }
    }
    
    /* Green pulse animation for buttons */
    .green-pulse {
        animation: greenPulse 2s ease-in-out infinite;
    }
    
    @keyframes greenPulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(45, 212, 191, 0.7);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(45, 212, 191, 0);
        }
    }
    
    /* Green glow effect for cards */
    .green-glow {
        box-shadow: 0 0 20px rgba(45, 212, 191, 0.3), 0 0 40px rgba(45, 212, 191, 0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .green-glow:hover {
        box-shadow: 0 0 30px rgba(45, 212, 191, 0.5), 0 0 60px rgba(45, 212, 191, 0.2);
    }
    
    .green-particle-2 {
        width: 6px;
        height: 6px;
        top: 45%;
        right: 15%;
        animation-delay: -3s;
    }
    
    .green-particle-3 {
        width: 3px;
        height: 3px;
        bottom: 25%;
        left: 25%;
        animation-delay: -6s;
    }
    
    .green-particle-4 {
        width: 5px;
        height: 5px;
        top: 70%;
        right: 30%;
        animation-delay: -9s;
    }
    
    .green-particle-5 {
        width: 4px;
        height: 4px;
        bottom: 40%;
        right: 10%;
        animation-delay: -12s;
    }
    
    @keyframes floatParticle {
        0%, 100% {
            transform: translateY(0px) translateX(0px) scale(1);
            opacity: 0.3;
        }
        25% {
            transform: translateY(-30px) translateX(15px) scale(1.2);
            opacity: 0.6;
        }
        50% {
            transform: translateY(-15px) translateX(-20px) scale(0.8);
            opacity: 0.4;
        }
        75% {
            transform: translateY(-45px) translateX(10px) scale(1.1);
            opacity: 0.7;
        }
    }
    
    /* Mobile optimizations for particles */
    @media (max-width: 768px) {
        .green-particle {
            animation-duration: 15s;
        }
        
        @keyframes floatParticle {
            0%, 100% {
                transform: translateY(0px) translateX(0px) scale(1);
                opacity: 0.2;
            }
            25% {
                transform: translateY(-20px) translateX(10px) scale(1.1);
                opacity: 0.4;
            }
            50% {
                transform: translateY(-10px) translateX(-15px) scale(0.9);
                opacity: 0.3;
            }
            75% {
                transform: translateY(-30px) translateX(8px) scale(1.05);
                opacity: 0.5;
            }
        }
    }
    
    /* Enhanced CTA hover effects */
    .cta-soft-box:hover .floating-orb {
        animation-duration: 6s;
        filter: blur(0.5px);
    }
    
    .feature-item {
        transition: all 0.3s ease;
    }
    
    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
        .floating-orb,
        .primary-gradient-bg::before,
        .star-emoji {
            animation: none;
        }
        
        .cta-soft-box:hover .floating-orb {
            animation: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Soft CTA Box Section -->
<div class="max-w-4xl mx-auto px-6 py-8 relative">
    <div class="cta-soft-box bg-black/40 backdrop-blur-md rounded-2xl p-8 border border-white/10 shadow-2xl relative overflow-hidden group hover:bg-black/50 transition-all duration-500">
        <!-- Subtle animated background elements -->
        <div class="absolute inset-0 opacity-20">
            <div class="floating-orb floating-orb-1"></div>
            <div class="floating-orb floating-orb-2"></div>
            <div class="floating-orb floating-orb-3"></div>
        </div>
        
        <div class="relative z-10 text-center">
            <div class="mb-6">
                <div class="flex items-center justify-center mb-4">
                    <span class="star-emoji text-2xl mr-3 group-hover:scale-110 transition-transform duration-300">üåü</span>
                    <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white group-hover:text-teal-200 transition-colors duration-300">Celio E-Card! Try it yourself!</h1>
                    <span class="star-emoji text-2xl ml-3 group-hover:scale-110 transition-transform duration-300">üåü</span>
                </div>
                <p class="text-base sm:text-lg text-gray-300 mb-6 group-hover:text-gray-200 transition-colors duration-300">Create your personalized medical card in minutes</p>
            </div>
            
            <div class="flex flex-wrap items-center justify-center gap-6 text-gray-300">
                <div class="flex items-center space-x-3 feature-item group-hover:scale-105 transition-transform duration-300">
                    <div class="w-7 h-7 bg-blue-500/80 rounded-lg flex items-center justify-center group-hover:bg-blue-400 transition-colors duration-300">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <span class="text-sm font-medium">Quick Setup</span>
                </div>
                <div class="flex items-center space-x-3 feature-item group-hover:scale-105 transition-transform duration-300">
                    <div class="w-7 h-7 bg-green-500/80 rounded-lg flex items-center justify-center group-hover:bg-green-400 transition-colors duration-300">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                    </div>
                    <span class="text-sm font-medium">Multi-Language</span>
                </div>
                <div class="flex items-center space-x-3 feature-item group-hover:scale-105 transition-transform duration-300">
                    <div class="w-7 h-7 bg-purple-500/80 rounded-lg flex items-center justify-center group-hover:bg-purple-400 transition-colors duration-300">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <span class="text-sm font-medium">Always Secure</span>
                </div>
            </div>
            
            <p class="text-gray-400 mt-6 text-sm max-w-2xl mx-auto group-hover:text-gray-300 transition-colors duration-300">Perfect for travelers, people with allergies, and anyone who wants to communicate their medical needs clearly</p>
        </div>
    </div>
</div>

<!-- Primary gradient background -->
<div class="primary-gradient-bg">
        <div class="primary-gradient-overlay"></div>
    <div class="gradient-accent gradient-accent-1"></div>
    <div class="gradient-accent gradient-accent-2"></div>
    
    <!-- Floating green particles for subtle animation -->
    <div class="green-particle green-particle-1"></div>
    <div class="green-particle green-particle-2"></div>
    <div class="green-particle green-particle-3"></div>
    <div class="green-particle green-particle-4"></div>
    <div class="green-particle green-particle-5"></div>
</div>

<div class="min-h-screen py-4 sm:py-6 lg:py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header - Mobile Optimized -->
        <div class="mb-6 sm:mb-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-2 sm:mb-4 tracking-tight">{{ page_title }}</h1>
                <p class="text-sm sm:text-base lg:text-lg text-teal-300 px-4">Create your personalized e-card for safe travel and dining</p>
            </div>
            
            <!-- Interactive E-Card Section -->
            <div class="mb-6">
                <!-- Card Container with Mobile-First Design -->
                <div class="flex justify-center px-4">
                    <div class="w-full max-w-sm sm:max-w-md green-glow">
                        {% include "emergency_cards/partials/editable_card.html" with card=card preview_theme=preview_theme language_choices=language_choices current_lang=current_lang is_preview=True %}
                    </div>
                </div>
                
                <!-- Quick Action Hint -->
                <div class="text-center mt-4">
                    <p class="text-xs sm:text-sm text-teal-400 flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.122 2.122"></path>
                        </svg>
                        <span>Tap any field above to start editing</span>
                    </p>
                </div>
            </div>
                
                <!-- Quick Guide - Mobile Optimized -->
                <div class="max-w-4xl mx-auto mb-8">
                    <!-- Collapsible Guide Section -->
                    <div class="bg-gradient-to-br from-spruce-700/50 to-spruce-800/30 rounded-xl border border-spruce-600/30 backdrop-blur-sm overflow-hidden">
                        <button type="button" 
                                onclick="toggleGuide()" 
                                class="w-full p-4 sm:p-6 flex items-center justify-between text-left hover:bg-spruce-700/30 transition-all duration-300 green-pulse">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg sm:text-xl font-semibold text-white">How to Use Your E-Card</h3>
                                    <p class="text-sm text-purple-300 mt-1">Quick setup guide ‚Ä¢ Tap to expand</p>
                                </div>
                            </div>
                            <svg id="guide-chevron" class="w-5 h-5 text-purple-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div id="guide-content" class="hidden border-t border-spruce-600/50">
                            <div class="p-4 sm:p-6">
                                <!-- Mobile-First Step Cards -->
                                <div class="space-y-4">
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            1
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Edit Your Information</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Tap any field on the card above to customize your medical details</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            2
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Choose Language & Theme</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Select your preferred language and visual style</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            3
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Save & Use</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Save your card and show it to restaurants, medical staff, or anyone who needs to understand your dietary restrictions</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Benefits -->
                                <div class="mt-6 pt-4 border-t border-spruce-600/30">
                                    <h4 class="text-white font-medium text-sm mb-3">Why Use an E-Card?</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs sm:text-sm">
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Clear communication in any language</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Always accessible on your phone</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Professional medical format</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Perfect for travel & dining</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>

        
        <form method="POST" enctype="multipart/form-data" id="card-form" hx-post="{% url 'message_cards:unified_card_management' %}" hx-swap="none" hx-trigger="none">
            {% csrf_token %}
            
            <!-- Hidden inputs to track active language and theme -->
            <input type="hidden" name="active_language" id="active_language" value="{{ current_lang }}">
            {% with current_theme=preview_theme %}
                {% if not current_theme and card and card.theme %}
                    {% with current_theme=card.theme %}
                        <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                    {% endwith %}
                {% elif not current_theme %}
                    {% with current_theme='light' %}
                        <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                    {% endwith %}
                {% else %}
                    <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                {% endif %}
            {% endwith %}
            <input type="hidden" name="save_card" id="save_card_input" value="false">
            

                </div> <!-- End of hidden sections -->

                <!-- Hidden sections that were previously visible -->
                <div class="hidden">
                    <!-- Hidden file input to maintain form functionality -->
                    <input type="file" name="{{ form.profile_picture.name }}" id="{{ form.profile_picture.id_for_label }}" hidden>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Removed fetch-based preview update JS for language and theme switching; now handled by HTMX.

    document.addEventListener('DOMContentLoaded', function() {
        // Prevent form submission which causes page refresh
        const cardForm = document.getElementById('card-form');
        cardForm.addEventListener('submit', function(e) {
            const isSubmitButton = e.submitter && e.submitter.type === 'submit' && e.submitter.classList.contains('action-button-primary');
            if (!isSubmitButton) {
                e.preventDefault(); // Only let the form submit when using the save button
            }
        });
        
        // Store the current scroll position
        function saveScrollPosition() {
            window.sessionStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        }
        
        // Restore the scroll position
        function restoreScrollPosition() {
            const savedPosition = window.sessionStorage.getItem('scrollPosition');
            if (savedPosition) {
                window.scrollTo(0, savedPosition);
            }
        }
        
        // Get CSRF token from cookie
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            if (!cookieValue) {
                console.error('CSRF token not found in cookies');
            }
            
            return cookieValue;
        }
        
        // Function to update the card preview with HTMX
        function updateCardPreview() {
            const currentLang = document.getElementById('active_language').value;
            const selectedTheme = document.getElementById('theme-selector').value;
            const messageTextarea = document.getElementById('message');
            
            console.log('Updating preview with theme:', selectedTheme, 'and language:', currentLang);
            
            // Create form data for the update
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', currentLang);
            formData.append('preview_theme', selectedTheme);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message 
            if (messageTextarea) {
                formData.append('message_' + currentLang.toLowerCase(), messageTextarea.value);
            }
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating preview...</div></div>';
            }
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with theme:', selectedTheme);
                    
                    // Update the hidden theme input
                    document.getElementById('selected-theme').value = selectedTheme;
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up language selector handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup for all dropdowns that might be in the DOM
            setupLanguageDropdowns();
            setupThemeDropdowns();
            
            // Set up live preview updates for message changes
            setupMessageTextareaListeners();
            
            // Set up save button handler
            const saveButton = document.getElementById('save-card-button');
            if (saveButton) {
                saveButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('card-form');
                    if (!form) return;
                    
                    // Create a hidden input for save_card if it doesn't exist
                    let saveCardInput = document.getElementById('save_card_input');
                    if (!saveCardInput) {
                        saveCardInput = document.createElement('input');
                        saveCardInput.type = 'hidden';
                        saveCardInput.name = 'save_card';
                        saveCardInput.id = 'save_card_input';
                        form.appendChild(saveCardInput);
                    }
                    saveCardInput.value = 'true';
                    
                    // Show saving indicator
                    const saveText = document.querySelector('.save-text');
                    const originalText = saveText.textContent;
                    saveText.textContent = 'Saving...';
                    document.querySelector('.autosave-status').textContent = 'Saving your E-Card...';
                    
                    // Submit the form
                    form.submit();
                });
            }
            
            // Set up theme dropdowns
            setupThemeDropdowns();
            
            // Apply initial translations based on the current language
            let currentLang = document.getElementById('active_language').value;
            // Ensure language code is lowercase
            currentLang = currentLang.toLowerCase();
            document.getElementById('active_language').value = currentLang;
            console.log('Initial language (lowercase):', currentLang);
            translateUIElements(currentLang);
        });
        
        // Function to set up all language dropdowns in the DOM
        function setupLanguageDropdowns() {
            const dropdowns = document.querySelectorAll('.language-selector-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', handleLanguageChange);
            });
        }
        
        // Function to set up all theme dropdowns
        function setupThemeDropdowns() {
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                selector.addEventListener('change', handleThemeChange);
            });
        }
        
        // Translation dictionary for UI elements
        const translations = {
            'en': {
                'Medical Information': 'Dietary Information',
                'Message': 'Message',
                'Contact': 'Contact',
                'No contact listed.': 'No contact listed.',
                'No message available.': 'No message available.',
                'Autoimmune disorder triggered by gluten': 'Autoimmune disorder triggered by gluten',
                'Can cause severe intestinal damage': 'Can cause severe intestinal damage',
                'Requires strict gluten-free diet': 'Requires strict gluten-free diet',
                'Non-celiac gluten sensitivity': 'Non-celiac gluten sensitivity',
                'Causes discomfort but not intestinal damage': 'Causes discomfort but not intestinal damage',
                'Requires gluten-free diet for symptom control': 'Requires gluten-free diet for symptom control',
                'Immune system reaction to wheat proteins': 'Immune system reaction to wheat proteins',
                'Can cause immediate allergy symptoms': 'Can cause immediate allergy symptoms',
                'May require assistance if severe': 'May require assistance if severe',
                'Requires avoidance of gluten-containing foods': 'Requires avoidance of gluten-containing foods',
                'Needs careful meal preparation': 'Needs careful meal preparation',
                'Profile Picture': 'Profile Picture'
            },
            'es': {
                'Medical Information': 'Informaci√≥n Diet√©tica',
                'Message': 'Mensaje',
                'Contact': 'Contacto',
                'No contact listed.': 'No hay contacto registrado.',
                'No message available.': 'No hay mensaje disponible.',
                'Autoimmune disorder triggered by gluten': 'Trastorno autoinmune desencadenado por el gluten',
                'Can cause severe intestinal damage': 'Puede causar da√±o intestinal severo',
                'Requires strict gluten-free diet': 'Requiere dieta estricta sin gluten',
                'Non-celiac gluten sensitivity': 'Sensibilidad al gluten no cel√≠aca',
                'Causes discomfort but not intestinal damage': 'Causa malestar pero no da√±o intestinal',
                'Requires gluten-free diet for symptom control': 'Requiere dieta sin gluten para controlar los s√≠ntomas',
                'Immune system reaction to wheat proteins': 'Reacci√≥n del sistema inmunol√≥gico a las prote√≠nas del trigo',
                'Can cause immediate allergy symptoms': 'Puede causar s√≠ntomas al√©rgicos inmediatos',
                'May require assistance if severe': 'Puede requerir asistencia si es grave',
                'Requires avoidance of gluten-containing foods': 'Requiere evitar alimentos con gluten',
                'Needs careful meal preparation': 'Necesita preparaci√≥n cuidadosa de comidas',
                'Profile Picture': 'Foto de Perfil'
            },
            'fr': {
                'Medical Information': 'Informations Di√©t√©tiques',
                'Message': 'Message',
                'Contact': 'Contact',
                'No contact listed.': 'Aucun contact indiqu√©.',
                'No message available.': 'Aucun message disponible.',
                'Autoimmune disorder triggered by gluten': 'Trouble auto-immun d√©clench√© par le gluten',
                'Can cause severe intestinal damage': 'Peut causer de graves l√©sions intestinales',
                'Requires strict gluten-free diet': 'N√©cessite un r√©gime strict sans gluten',
                'Non-celiac gluten sensitivity': 'Sensibilit√© au gluten non c≈ìliaque',
                'Causes discomfort but not intestinal damage': 'Provoque de l\'inconfort mais pas de l√©sions intestinales',
                'Requires gluten-free diet for symptom control': 'N√©cessite un r√©gime sans gluten pour contr√¥ler les sympt√¥mes',
                'Immune system reaction to wheat proteins': 'R√©action du syst√®me immunitaire aux prot√©ines de bl√©',
                'Can cause immediate allergy symptoms': 'Peut provoquer des sympt√¥mes allergiques imm√©diats',
                'May require assistance if severe': 'Peut n√©cessiter une assistance si grave',
                'Requires avoidance of gluten-containing foods': 'Exige d\'√©viter les aliments contenant du gluten',
                'Needs careful meal preparation': 'N√©cessite une pr√©paration soign√©e des repas',
                'Profile Picture': 'Photo de Profil'
            },
            'de': {
                'Medical Information': 'Di√§tetische Informationen',
                'Message': 'Nachricht',
                'Contact': 'Kontakt',
                'No contact listed.': 'Kein Kontakt angegeben.',
                'No message available.': 'Keine Nachricht verf√ºgbar.',
                'Autoimmune disorder triggered by gluten': 'Durch Gluten ausgel√∂ste Autoimmunerkrankung',
                'Can cause severe intestinal damage': 'Kann schwere Darmsch√§den verursachen',
                'Requires strict gluten-free diet': 'Erfordert strenge glutenfreie Di√§t',
                'Non-celiac gluten sensitivity': 'Nicht-Z√∂liakie-Glutensensitivit√§t',
                'Causes discomfort but not intestinal damage': 'Verursacht Beschwerden, aber keine Darmsch√§den',
                'Requires gluten-free diet for symptom control': 'Erfordert glutenfreie Di√§t zur Symptomkontrolle',
                'Immune system reaction to wheat proteins': 'Immunsystemreaktion auf Weizenproteine',
                'Can cause immediate allergy symptoms': 'Kann sofortige allergische Symptome verursachen',
                'May require assistance if severe': 'Kann bei schweren F√§llen Hilfe erfordern',
                'Requires avoidance of gluten-containing foods': 'Erfordert die Vermeidung glutenhaltiger Lebensmittel',
                'Needs careful meal preparation': 'Erfordert sorgf√§ltige Mahlzeitenzubereitung',
                'Profile Picture': 'Profilbild'
            },
            'it': {
                'Medical Information': 'Informazioni Dietetiche',
                'Message': 'Messaggio',
                'Contact': 'Contatto',
                'No contact listed.': 'Nessun contatto elencato.',
                'No message available.': 'Nessun messaggio disponibile.',
                'Autoimmune disorder triggered by gluten': 'Disturbo autoimmune scatenato dal glutine',
                'Can cause severe intestinal damage': 'Pu√≤ causare gravi danni intestinali',
                'Requires strict gluten-free diet': 'Richiede dieta rigorosamente senza glutine',
                'Non-celiac gluten sensitivity': 'Sensibilit√† al glutine non celiaca',
                'Causes discomfort but not intestinal damage': 'Causa disagio ma non danni intestinali',
                'Requires gluten-free diet for symptom control': 'Richiede dieta senza glutine per il controllo dei sintomi',
                'Immune system reaction to wheat proteins': 'Reazione del sistema immunitario alle proteine del grano',
                'Can cause immediate allergy symptoms': 'Pu√≤ causare sintomi allergici immediati',
                'May require assistance if severe': 'Pu√≤ richiedere assistenza se grave',
                'Requires avoidance of gluten-containing foods': 'Richiede di evitare cibi contenenti glutine',
                'Needs careful meal preparation': 'Richiede preparazione attenta dei pasti',
                'Profile Picture': 'Foto del Profilo'
            },
            'pt': {
                'Medical Information': 'Informa√ß√µes Diet√©ticas',
                'Message': 'Mensagem',
                'Contact': 'Contato',
                'No contact listed.': 'Nenhum contato listado.',
                'No message available.': 'Nenhuma mensagem dispon√≠vel.',
                'Autoimmune disorder triggered by gluten': 'Dist√∫rbio autoimune desencadeado pelo gl√∫ten',
                'Can cause severe intestinal damage': 'Pode causar danos intestinais graves',
                'Requires strict gluten-free diet': 'Requer dieta rigorosamente sem gl√∫ten',
                'Non-celiac gluten sensitivity': 'Sensibilidade ao gl√∫ten n√£o cel√≠aca',
                'Causes discomfort but not intestinal damage': 'Causa desconforto mas n√£o danos intestinais',
                'Requires gluten-free diet for symptom control': 'Requer dieta sem gl√∫ten para controle dos sintomas',
                'Immune system reaction to wheat proteins': 'Rea√ß√£o do sistema imunol√≥gico √†s prote√≠nas do trigo',
                'Can cause immediate allergy symptoms': 'Pode causar sintomas al√©rgicos imediatos',
                'May require assistance if severe': 'Pode requerer assist√™ncia se grave',
                'Requires avoidance of gluten-containing foods': 'Requer evitar alimentos contendo gl√∫ten',
                'Needs careful meal preparation': 'Necessita prepara√ß√£o cuidadosa das refei√ß√µes',
                'Profile Picture': 'Foto do Perfil'
            },
            'ja': {
                'Medical Information': 'È£ü‰∫ãÊÉÖÂ†±',
                'Message': '„É°„ÉÉ„Çª„Éº„Ç∏',
                'Contact': 'ÈÄ£Áµ°ÂÖà',
                'No contact listed.': 'ÈÄ£Áµ°ÂÖà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ',
                'No message available.': '„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                'Autoimmune disorder triggered by gluten': '„Ç∞„É´„ÉÜ„É≥„Å´„Çà„Å£„Å¶Âºï„ÅçËµ∑„Åì„Åï„Çå„ÇãËá™Â∑±ÂÖçÁñ´ÁñæÊÇ£',
                'Can cause severe intestinal damage': 'ÈáçÁØ§„Å™ËÖ∏„ÅÆÊêçÂÇ∑„ÇíÂºï„ÅçËµ∑„Åì„ÅôÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô',
                'Requires strict gluten-free diet': 'Âé≥Ê†º„Å™„Ç∞„É´„ÉÜ„É≥„Éï„É™„ÉºÈ£ü‰∫ã„ÅåÂøÖË¶Å',
                'Non-celiac gluten sensitivity': 'Èùû„Çª„É™„Ç¢„ÉÉ„ÇØÊÄß„Ç∞„É´„ÉÜ„É≥ÈÅéÊïèÁóá',
                'Causes discomfort but not intestinal damage': '‰∏çÂø´ÊÑü„ÇíÂºï„ÅçËµ∑„Åì„Åó„Åæ„Åô„ÅåËÖ∏„ÅÆÊêçÂÇ∑„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì',
                'Requires gluten-free diet for symptom control': 'ÁóáÁä∂ÁÆ°ÁêÜ„ÅÆ„Åü„ÇÅ„Ç∞„É´„ÉÜ„É≥„Éï„É™„ÉºÈ£ü‰∫ã„ÅåÂøÖË¶Å',
                'Immune system reaction to wheat proteins': 'Â∞èÈ∫¶„Çø„É≥„Éë„ÇØË≥™„Å´ÂØæ„Åô„ÇãÂÖçÁñ´Á≥ª„ÅÆÂèçÂøú',
                'Can cause immediate allergy symptoms': 'Âç≥Â∫ß„Å´„Ç¢„É¨„É´„ÇÆ„ÉºÁóáÁä∂„ÇíÂºï„ÅçËµ∑„Åì„ÅôÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô',
                'May require assistance if severe': 'ÈáçÁØ§„Å™Â†¥Âêà„ÅØÊè¥Âä©„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô',
                'Requires avoidance of gluten-containing foods': '„Ç∞„É´„ÉÜ„É≥„ÇíÂê´„ÇÄÈ£üÂìÅ„ÅÆÂõûÈÅø„ÅåÂøÖË¶Å',
                'Needs careful meal preparation': 'Ê≥®ÊÑèÊ∑±„ÅÑÈ£ü‰∫ã„ÅÆÊ∫ñÂÇô„ÅåÂøÖË¶Å',
                'Profile Picture': '„Éó„É≠„Éï„Ç£„Éº„É´ÂÜôÁúü'
            },
            'zh': {
                'Medical Information': 'È•ÆÈ£ü‰ø°ÊÅØ',
                'Message': 'Ê∂àÊÅØ',
                'Contact': 'ËÅîÁ≥ª‰∫∫',
                'No contact listed.': 'Êú™ÂàóÂá∫ËÅîÁ≥ª‰∫∫„ÄÇ',
                'No message available.': 'Ê≤°ÊúâÂèØÁî®ÁöÑÊ∂àÊÅØ„ÄÇ',
                'Autoimmune disorder triggered by gluten': 'Áî±È∫∏Ë¥®ÂºïÂèëÁöÑËá™Ë∫´ÂÖçÁñ´ÊÄßÁñæÁóÖ',
                'Can cause severe intestinal damage': 'ÂèØËÉΩÂØºËá¥‰∏•ÈáçÁöÑËÇ†ÈÅìÊçü‰º§',
                'Requires strict gluten-free diet': 'ÈúÄË¶Å‰∏•Ê†ºÁöÑÊó†È∫∏Ë¥®È•ÆÈ£ü',
                'Non-celiac gluten sensitivity': 'Èùû‰π≥Á≥úÊ≥ªÈ∫∏Ë¥®ÊïèÊÑüÊÄß',
                'Causes discomfort but not intestinal damage': 'ÂºïËµ∑‰∏çÈÄÇ‰ΩÜ‰∏ç‰ºöÈÄ†ÊàêËÇ†ÈÅìÊçü‰º§',
                'Requires gluten-free diet for symptom control': 'ÈúÄË¶ÅÊó†È∫∏Ë¥®È•ÆÈ£üÊù•ÊéßÂà∂ÁóáÁä∂',
                'Immune system reaction to wheat proteins': 'ÂÖçÁñ´Á≥ªÁªüÂØπÂ∞èÈ∫¶ËõãÁôΩÁöÑÂèçÂ∫î',
                'Can cause immediate allergy symptoms': 'ÂèØËÉΩÂºïËµ∑Âç≥Êó∂ËøáÊïèÁóáÁä∂',
                'May require assistance if severe': 'Â¶ÇÊûú‰∏•ÈáçÂèØËÉΩÈúÄË¶ÅÂçèÂä©',
                'Requires avoidance of gluten-containing foods': 'ÈúÄË¶ÅÈÅøÂÖçÂê´È∫∏Ë¥®ÁöÑÈ£üÁâ©',
                'Needs careful meal preparation': 'ÈúÄË¶Å‰ªîÁªÜÁöÑËÜ≥È£üÂáÜÂ§á',
                'Profile Picture': '‰∏™‰∫∫ÁÖßÁâá'
            },
            'ko': {
                'Medical Information': 'ÏùòÎ£å Ï†ïÎ≥¥',
                'Message': 'Î©îÏãúÏßÄ',
                'Contact': 'Ïó∞ÎùΩÏ≤ò',
                'No contact listed.': 'Îì±Î°ùÎêú Ïó∞ÎùΩÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.',
                'No message available.': 'ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Î©îÏãúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.',
                'Autoimmune disorder triggered by gluten': 'Í∏ÄÎ£®ÌÖêÏóê ÏùòÌï¥ Ïú†Î∞úÎêòÎäî ÏûêÍ∞ÄÎ©¥Ïó≠ ÏßàÌôò',
                'Can cause severe intestinal damage': 'Ïã¨Í∞ÅÌïú Ïû• ÏÜêÏÉÅÏùÑ ÏùºÏúºÌÇ¨ Ïàò ÏûàÏäµÎãàÎã§',
                'Requires strict gluten-free diet': 'ÏóÑÍ≤©Ìïú Í∏ÄÎ£®ÌÖê ÌîÑÎ¶¨ ÏãùÎã®Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§',
                'Non-celiac gluten sensitivity': 'ÎπÑÏÖÄÎ¶¨ÏïÖ Í∏ÄÎ£®ÌÖê ÎØºÍ∞êÏÑ±',
                'Causes discomfort but not intestinal damage': 'Î∂àÌé∏Ìï®ÏùÑ Ïú†Î∞úÌïòÏßÄÎßå Ïû• ÏÜêÏÉÅÏùÄ ÏóÜÏäµÎãàÎã§',
                'Requires gluten-free diet for symptom control': 'Ï¶ùÏÉÅ Ï°∞Ï†àÏùÑ ÏúÑÌï¥ Í∏ÄÎ£®ÌÖê ÌîÑÎ¶¨ ÏãùÎã®Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§',
                'Immune system reaction to wheat proteins': 'Î∞Ä Îã®Î∞±ÏßàÏóê ÎåÄÌïú Î©¥Ïó≠Í≥Ñ Î∞òÏùë',
                'Can cause immediate allergy symptoms': 'Ï¶âÍ∞ÅÏ†ÅÏù∏ ÏïåÎ†àÎ•¥Í∏∞ Ï¶ùÏÉÅÏùÑ ÏùºÏúºÌÇ¨ Ïàò ÏûàÏäµÎãàÎã§',
                'May require assistance if severe': 'Ïã¨Í∞ÅÌïú Í≤ΩÏö∞ ÎèÑÏõÄÏù¥ ÌïÑÏöîÌï† Ïàò ÏûàÏäµÎãàÎã§',
                'Requires avoidance of gluten-containing foods': 'Í∏ÄÎ£®ÌÖê Ìï®Ïú† ÏãùÌíàÏùò ÌöåÌîºÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§',
                'Needs careful meal preparation': 'Ïã†Ï§ëÌïú ÏãùÏÇ¨ Ï§ÄÎπÑÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§',
                'Profile Picture': 'ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ'
            },
            'ar': {
                'Medical Information': 'ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ©',
                'Message': 'ÿ±ÿ≥ÿßŸÑÿ©',
                'Contact': 'ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ',
                'No contact listed.': 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ŸÖÿØÿ±ÿ¨ÿ©.',
                'No message available.': 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ™ÿßÿ≠ÿ©.',
                'Autoimmune disorder triggered by gluten': 'ÿßÿ∂ÿ∑ÿ±ÿßÿ® ÿßŸÑŸÖŸÜÿßÿπÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© ÿßŸÑŸÜÿßÿ¨ŸÖ ÿπŸÜ ÿßŸÑÿ∫ŸÑŸàÿ™ŸäŸÜ',
                'Can cause severe intestinal damage': 'ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿ≥ÿ®ÿ® ÿ∂ÿ±ÿ±Ÿãÿß ŸÖÿπŸàŸäŸãÿß ÿ¥ÿØŸäÿØŸãÿß',
                'Requires strict gluten-free diet': 'Ÿäÿ™ÿ∑ŸÑÿ® ŸÜÿ∏ÿßŸÖŸãÿß ÿ∫ÿ∞ÿßÿ¶ŸäŸãÿß ÿµÿßÿ±ŸÖŸãÿß ÿÆÿßŸÑŸäŸãÿß ŸÖŸÜ ÿßŸÑÿ∫ŸÑŸàÿ™ŸäŸÜ',
                'Non-celiac gluten sensitivity': 'ÿ≠ÿ≥ÿßÿ≥Ÿäÿ© ÿßŸÑÿ∫ŸÑŸàÿ™ŸäŸÜ ÿ∫Ÿäÿ± ÿßŸÑÿ≥ŸäŸÑŸäÿßŸÉ',
                'Causes discomfort but not intestinal damage': 'Ÿäÿ≥ÿ®ÿ® ÿπÿØŸÖ ÿßŸÑÿ±ÿßÿ≠ÿ© ŸàŸÑŸÉŸÜ ŸÑŸäÿ≥ ÿ∂ÿ±ÿ±Ÿãÿß ŸÖÿπŸàŸäŸãÿß',
                'Requires gluten-free diet for symptom control': 'Ÿäÿ™ÿ∑ŸÑÿ® ŸÜÿ∏ÿßŸÖŸãÿß ÿ∫ÿ∞ÿßÿ¶ŸäŸãÿß ÿÆÿßŸÑŸäŸãÿß ŸÖŸÜ ÿßŸÑÿ∫ŸÑŸàÿ™ŸäŸÜ ŸÑŸÑÿ≥Ÿäÿ∑ÿ±ÿ© ÿπŸÑŸâ ÿßŸÑÿ£ÿπÿ±ÿßÿ∂',
                'Immune system reaction to wheat proteins': 'ÿ±ÿØ ŸÅÿπŸÑ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑŸÖŸÜÿßÿπŸä ŸÑÿ®ÿ±Ÿàÿ™ŸäŸÜÿßÿ™ ÿßŸÑŸÇŸÖÿ≠',
                'Can cause immediate allergy symptoms': 'ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿ≥ÿ®ÿ® ÿ£ÿπÿ±ÿßÿ∂ ÿ≠ÿ≥ÿßÿ≥Ÿäÿ© ŸÅŸàÿ±Ÿäÿ©',
                'May require assistance if severe': 'ŸÇÿØ Ÿäÿ™ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ¥ÿØŸäÿØŸãÿß',
                'Requires avoidance of gluten-containing foods': 'Ÿäÿ™ÿ∑ŸÑÿ® ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ÿ∑ÿπŸÖÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿ∫ŸÑŸàÿ™ŸäŸÜ',
                'Needs careful meal preparation': 'Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ•ÿπÿØÿßÿØ Ÿàÿ¨ÿ®ÿßÿ™ ÿ®ÿπŸÜÿßŸäÿ©',
                'Profile Picture': 'ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä'
            },
            'ru': {
                'Medical Information': '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                'Message': '–°–æ–æ–±—â–µ–Ω–∏–µ',
                'Contact': '–ö–æ–Ω—Ç–∞–∫—Ç',
                'No contact listed.': '–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω.',
                'No message available.': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.',
                'Autoimmune disorder triggered by gluten': '–ê—É—Ç–æ–∏–º–º—É–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –≤—ã–∑–≤–∞–Ω–Ω–æ–µ –≥–ª—é—Ç–µ–Ω–æ–º',
                'Can cause severe intestinal damage': '–ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Å–µ—Ä—å–µ–∑–Ω–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–∏—à–µ—á–Ω–∏–∫–∞',
                'Requires strict gluten-free diet': '–¢—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–æ–≥–æ–π –±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤–æ–π –¥–∏–µ—Ç—ã',
                'Non-celiac gluten sensitivity': '–ù–µ—Ü–µ–ª–∏–∞–∫–∞–ª—å–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≥–ª—é—Ç–µ–Ω—É',
                'Causes discomfort but not intestinal damage': '–í—ã–∑—ã–≤–∞–µ—Ç –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç, –Ω–æ –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–∏—à–µ—á–Ω–∏–∫–∞',
                'Requires gluten-free diet for symptom control': '–¢—Ä–µ–±—É–µ—Ç –±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤–æ–π –¥–∏–µ—Ç—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–∏–º–ø—Ç–æ–º–æ–≤',
                'Immune system reaction to wheat proteins': '–†–µ–∞–∫—Ü–∏—è –∏–º–º—É–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –±–µ–ª–∫–∏ –ø—à–µ–Ω–∏—Ü—ã',
                'Can cause immediate allergy symptoms': '–ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –∞–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∏–µ —Å–∏–º–ø—Ç–æ–º—ã',
                'May require assistance if severe': '–ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–æ–º–æ—â—å –ø—Ä–∏ —Ç—è–∂–µ–ª–æ–º —Ç–µ—á–µ–Ω–∏–∏',
                'Requires avoidance of gluten-containing foods': '–¢—Ä–µ–±—É–µ—Ç –∏–∑–±–µ–≥–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –≥–ª—é—Ç–µ–Ω',
                'Needs careful meal preparation': '–¢—Ä–µ–±—É–µ—Ç —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –ø–∏—â–∏',
                'Profile Picture': '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ—Ñ–∏–ª—è'
            },
            'hi': {
                'Medical Information': '‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä',
                'Message': '‡§∏‡§Ç‡§¶‡•á‡§∂',
                'Contact': '‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï',
                'No contact listed.': '‡§ï‡•ã‡§à ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§',
                'No message available.': '‡§ï‡•ã‡§à ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§',
                'Autoimmune disorder triggered by gluten': '‡§ó‡•ç‡§≤‡•Ç‡§ü‡•á‡§® ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§ë‡§ü‡•ã‡§á‡§Æ‡•ç‡§Ø‡•Ç‡§® ‡§µ‡§ø‡§ï‡§æ‡§∞',
                'Can cause severe intestinal damage': '‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§Ü‡§Ç‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§§‡§ø ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§¨‡§® ‡§∏‡§ï‡§§‡§æ ‡§π‡•à',
                'Requires strict gluten-free diet': '‡§∏‡§ñ‡•ç‡§§ ‡§ó‡•ç‡§≤‡•Ç‡§ü‡•á‡§®-‡§´‡•ç‡§∞‡•Ä ‡§Ü‡§π‡§æ‡§∞ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à',
                'Non-celiac gluten sensitivity': '‡§ó‡•à‡§∞-‡§∏‡•Ä‡§≤‡§ø‡§è‡§ï ‡§ó‡•ç‡§≤‡•Ç‡§ü‡•á‡§® ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤‡§§‡§æ',
                'Causes discomfort but not intestinal damage': '‡§Ö‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§¨‡§®‡§§‡§æ ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§Ç‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç',
                'Requires gluten-free diet for symptom control': '‡§≤‡§ï‡•ç‡§∑‡§£ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡•ç‡§≤‡•Ç‡§ü‡•á‡§®-‡§´‡•ç‡§∞‡•Ä ‡§Ü‡§π‡§æ‡§∞ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à',
                'Immune system reaction to wheat proteins': '‡§ó‡•á‡§π‡•Ç‡§Ç ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§§‡§ø‡§∞‡§ï‡•ç‡§∑‡§æ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ',
                'Can cause immediate allergy symptoms': '‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä ‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§™‡•à‡§¶‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à',
                'May require assistance if severe': '‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à',
                'Requires avoidance of gluten-containing foods': '‡§ó‡•ç‡§≤‡•Ç‡§ü‡•á‡§® ‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ñ‡§æ‡§¶‡•ç‡§Ø ‡§™‡§¶‡§æ‡§∞‡•ç‡§•‡•ã‡§Ç ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à',
                'Needs careful meal preparation': '‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≠‡•ã‡§ú‡§® ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à',
                'Profile Picture': '‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡§ø‡§§‡•ç‡§∞'
            }
        };
        
        // Function to translate UI elements based on selected language
        function translateUIElements(langCode) {
            // If translations for this language don't exist, use English as fallback
            const langDict = translations[langCode.toLowerCase()] || translations['en'];
            console.log('Translating UI elements to', langCode, 'with dictionary:', langDict);
            
            // Find all elements with data-i18n attribute and translate them
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langDict[key]) {
                    element.textContent = langDict[key];
                }
            });
            
            console.log('UI elements translated to', langCode);
        }
        
        // Handle language change from dropdown
        function handleLanguageChange(e) {
            // Ensure language is lowercase
            const lang = this.value.toLowerCase();
            const prevLang = document.getElementById('active_language').value.toLowerCase();
            console.log('Language selected:', lang, 'Previous language:', prevLang);
            
            // Don't do anything if the language hasn't changed
            if (lang === prevLang) {
                return;
            }
            
            // For debugging
            console.log('Switching language from', prevLang, 'to', lang);
            
            // Update hidden input
            document.getElementById('active_language').value = lang;
            
            // Update all language selectors to match
            const langSelectors = document.querySelectorAll('.language-selector-dropdown');
            langSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = lang;
                }
            });
            
            // Update language display
            const displayElement = document.getElementById('current-language-display');
            if (displayElement) {
                displayElement.textContent = this.options[this.selectedIndex].text;
            }
                
            // Apply translations immediately for better UX
            translateUIElements(lang);
            
            // Show loading indicator in the card preview
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Translating...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data for language switch
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', lang);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Language switch failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                console.log('Received language switch response');
                
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with language:', lang);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Update the language tabs if they exist
                const languageTabs = document.querySelectorAll('.language-tab');
                if (languageTabs.length > 0) {
                    languageTabs.forEach(tab => {
                        const tabLang = tab.getAttribute('data-lang');
                        if (tabLang === lang) {
                            tab.setAttribute('aria-selected', 'true');
                            tab.classList.add('active-language');
                        } else {
                            tab.setAttribute('aria-selected', 'false');
                            tab.classList.remove('active-language');
                        }
                    });
                }
                
                // Restore scroll position
                window.scrollTo(0, scrollPosition);
            })
            .catch(error => {
                console.error('Error switching language:', error);
                // Restore original content if there was an error
                alert('There was an error switching languages. Please try again.');
            });
            
            // Store the language preference in localStorage for persistence
            localStorage.setItem('preferred_language', lang);
        }
        
        // Handle global language change (from top controls)
        function handleGlobalLanguageChange(lang) {
            // Update all language selectors including the one on the card
            const cardLanguageSelector = document.getElementById('language-selector');
            if (cardLanguageSelector) {
                cardLanguageSelector.value = lang;
                // Trigger the card's language change handler
                const event = new Event('change');
                cardLanguageSelector.dispatchEvent(event);
            } else {
                // Fallback if card selector doesn't exist
                handleLanguageChange.call({value: lang});
            }
        }
        
        // Handle theme change
        function handleThemeChange(e) {
            const theme = this.value;
            console.log('Theme selected:', theme);
            
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Get the current language
            const currentLang = document.getElementById('active_language').value;
            
            // Update all theme selectors to match
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = theme;
                }
            });
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating theme...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data specifically for theme update
            const formData = new FormData();
            formData.append('switch_theme', 'true'); // Changed from switch_language to switch_theme
            formData.append('active_language', currentLang);
            formData.append('preview_theme', theme);
            formData.append('selected_theme', theme); // Add this to ensure the theme is properly saved
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Theme update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Theme updated successfully to:', theme);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                    
                    // Update theme preview buttons
                    updateThemeButtonStates(theme);
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating theme:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Theme update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up message textarea listeners
        function setupMessageTextareaListeners() {
            // Set up real-time message updates on typing
            const messageTextarea = document.getElementById('message');
            if (messageTextarea) {
                // Use input event for immediate feedback
                messageTextarea.addEventListener('input', debounce(function() {
                    const currentLang = document.getElementById('active_language').value;
                    console.log('Message updated for ' + currentLang + ':', this.value.substring(0, 20) + '...');
                    
                    // Create form data specifically for this update
                    const formData = new FormData();
                    formData.append('switch_language', 'true');
                    formData.append('active_language', document.getElementById('active_language').value);
                    formData.append('preview_theme', document.getElementById('selected-theme').value);
                    formData.append('csrfmiddlewaretoken', getCsrfToken());
                    
                    // Add the message content using the correct field name format
                    formData.append('message_' + currentLang.toLowerCase(), this.value);
                    
                    // Send the update request
                    fetch('{% url "message_cards:unified_card_management" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Message update failed: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Create a temporary element to parse the HTML response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract just the card preview content
                        const cardContent = tempDiv.querySelector('.card-inner');
                        if (cardContent) {
                            document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                            console.log('Message updated successfully in preview');
                            
                            // Make sure the dropdown has the correct value
                            const newDropdown = document.querySelector('.language-selector-dropdown');
                            if (newDropdown) {
                                newDropdown.value = currentLang;
                                setupLanguageDropdowns(); // Re-setup events for the new dropdown
                            }
                        } else {
                            console.error('Could not find card preview content in response');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating message in preview:', error);
                    });
                }, 300)); // 300ms debounce is good for typing
                
                // Auto-resize the textarea
                messageTextarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                
                // Initial height adjustment
                messageTextarea.style.height = 'auto';
                messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
            }
        }
        
        // Initialize responsive layout handling
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth < 1024; // lg breakpoint in Tailwind
            const previewSection = document.querySelector('.card-preview-section');
            const formSection = document.querySelector('.form-section:not(.card-preview-section)');
            
            if (previewSection && formSection) {
                if (isMobile) {
                    previewSection.parentNode.parentNode.classList.add('order-2');
                    formSection.parentNode.parentNode.classList.add('order-1');
                } else {
                    previewSection.parentNode.parentNode.classList.remove('order-2');
                    formSection.parentNode.parentNode.classList.remove('order-1');
                    previewSection.parentNode.parentNode.classList.add('order-1');
                    formSection.parentNode.parentNode.classList.add('order-2');
                }
            }
        }
        
        // Initial call
        handleResponsiveLayout();
        
        // Listen for resize events
        window.addEventListener('resize', debounce(function() {
            handleResponsiveLayout();
        }, 250));
        
        // Debounce helper function to limit how often a function runs
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Set theme from global theme buttons
        function setGlobalTheme(theme) {
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Update theme selector on card if it exists
            const cardThemeSelector = document.getElementById('theme-selector');
            if (cardThemeSelector) {
                cardThemeSelector.value = theme;
                // Trigger the card's theme change handler
                const event = new Event('change');
                cardThemeSelector.dispatchEvent(event);
            } else {
                // Fallback if card selector doesn't exist
                handleThemeChange.call({value: theme});
            }
            
            // Update theme button states
            updateThemeButtonStates(theme);
        }
        
        // Update theme preview button states
        function updateThemeButtonStates(activeTheme) {
            const themeButtons = document.querySelectorAll('.theme-button');
            themeButtons.forEach(button => {
                const themeName = button.getAttribute('onclick').match(/setGlobalTheme\('(.+?)'\)/)[1];
                if (themeName === activeTheme) {
                    button.classList.remove('border-transparent', 'hover:border-teal-700');
                    button.classList.add('border-teal-400');
                } else {
                    button.classList.remove('border-teal-400');
                    button.classList.add('border-transparent', 'hover:border-teal-700');
                }
            });
        }
        
        // Setup global selectors functionality
        function setupGlobalSelectors() {
            // Set save button action
            const saveButton = document.getElementById('save-card-button');
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    document.getElementById('save_card_input').value = 'true';
                    document.querySelector('form').submit();
                });
            }
            
            // Initialize hex copy buttons
            initializeHexCopyButtons();
            
            // Fix theme button previews with correct theme colors
            document.querySelectorAll('.theme-preview').forEach(preview => {
                const parent = preview.closest('.theme-button');
                if (!parent) return;
                
                const theme = parent.getAttribute('onclick').match(/setGlobalTheme\('(.+?)'\)/)[1];
                if (theme === 'celio') {
                    preview.style.backgroundColor = 'var(--spruce-950)';
                    preview.querySelector('span').style.color = 'var(--teal-200)';
                } else if (theme === 'dark') {
                    preview.style.backgroundColor = '#1a1a1a';
                    preview.querySelector('span').style.color = 'white';
                } else if (theme === 'minimal') {
                    preview.style.backgroundColor = '#f5f5f5';
                    preview.querySelector('span').style.color = '#333333';
                }
            });
            
            // Initialize theme button states
            const currentTheme = document.getElementById('selected-theme').value || 'celio';
            updateThemeButtonStates(currentTheme);
        }
        
        // Hex copy functionality
        function initializeHexCopyButtons() {
            const hexCopyButtons = document.querySelectorAll('.hex-copy-btn');
            const notification = document.getElementById('copy-notification');
            const message = document.getElementById('copy-message');
            
            hexCopyButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent theme selection when clicking hex buttons
                    const hexCode = this.getAttribute('data-hex');
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(hexCode).then(() => {
                        // Show notification
                        message.textContent = `Hex code ${hexCode} copied to clipboard!`;
                        notification.classList.remove('hidden');
                        
                        // Hide notification after 2 seconds
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy hex code:', err);
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = hexCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            message.textContent = `Hex code ${hexCode} copied to clipboard!`;
                        } catch (fallbackErr) {
                            message.textContent = 'Failed to copy hex code';
                        }
                        document.body.removeChild(textArea);
                        notification.classList.remove('hidden');
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    });
                });
            });
        }
        
        // Toggle guide function for mobile-optimized collapsible section
        window.toggleGuide = function() {
            const content = document.getElementById('guide-content');
            const chevron = document.getElementById('guide-chevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        };
        
        // Call setupGlobalSelectors to initialize everything
        setupGlobalSelectors();
    });
</script>
{% endblock %}
