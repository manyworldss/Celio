{% extends 'base.html' %}
{% load static %}
{% load emergency_card_filters %}

{% block title %}{{ page_title }} - Celio{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --spruce-950: #0a1613;
        --spruce-900: #0f211c;
        --spruce-800: #14322a;
        --spruce-700: #1a4237;
        --teal-600: #0d9488;
        --teal-500: #14b8a6;
        --teal-400: #2dd4bf;
        --teal-300: #5eead4;
        --teal-200: #99f6e4;
        --teal-100: #ccfbf1;
    }
    
    body {
        background-color: var(--spruce-950);
        color: white;
    }
    
    /* Responsive order */
    @media (max-width: 1024px) {
        .order-1 {
            order: 2;
        }
        
        .order-2 {
            order: 1;
        }
    }
    
    /* Section styling */
    .form-section {
        background-color: var(--spruce-800);
        background-color: rgba(20, 50, 42, 0.2);
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.75rem;
        border: 1px solid rgba(26, 66, 55, 0.5);
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        padding: 0;
        border-bottom: 1px solid rgba(26, 66, 55, 0.7);
        background-color: transparent;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header h2 {
        color: white;
        font-weight: 600;
    }
    
    /* Improved form controls */
    .form-group {
        margin-bottom: 2.25rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--teal-100);
        margin-bottom: 0.75rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        background-color: rgba(20, 50, 42, 0.2);
        color: white;
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
        color: rgba(94, 234, 212, 0.5);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--teal-400);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
    }
    
    .form-textarea {
        min-height: 8rem;
    }
    
    .form-hint {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--teal-300);
    }
    
    .error-text {
        color: #f87171;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Action buttons with improved styling */
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .action-button-primary {
        background-color: var(--teal-600);
        color: white;
        border: none;
    }
    
    .action-button-primary:hover {
        background-color: var(--teal-500);
    }
    
    .action-button-secondary {
        background-color: rgba(20, 50, 42, 0.4);
        color: white;
        border: 1px solid var(--spruce-700);
    }
    
    .action-button-secondary:hover {
        background-color: rgba(20, 50, 42, 0.6);
    }
    
    /* Intro panel */
    .intro-panel {
        background-color: rgba(20, 50, 42, 0.25);
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(26, 66, 55, 0.5);
        margin-bottom: 2rem;
        backdrop-filter: blur(8px);
    }
    
    .intro-panel h3 {
        color: white;
    }
    
    .intro-panel p {
        color: var(--teal-200);
    }
    
    .dismiss-intro {
        color: var(--teal-400);
    }
    
    .dismiss-intro:hover {
        color: var(--teal-300);
    }
    
    /* Language tabs */
    .language-tab {
        color: var(--teal-300);
        border-bottom-color: transparent;
    }
    
    .language-tab[aria-selected="true"] {
        color: white;
        border-bottom-color: var(--teal-400);
    }
    
    .language-tab:hover:not([aria-selected="true"]) {
        color: var(--teal-200);
    }
    
    /* Card preview style */
    #card-preview {
        background-color: var(--spruce-900);
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
    }
    
    /* Spruce gradient background */
    .spruce-gradient-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -10;
        background: var(--spruce-950);
        overflow: hidden;
    }
    
    .spruce-gradient-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.6;
        background: radial-gradient(ellipse at center, var(--spruce-900) 0%, transparent 70%);
    }
    
    .gradient-accent {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
    }
    
    .gradient-accent-1 {
        width: 60vw;
        height: 60vw;
        background: rgba(20, 184, 166, 0.15);
        top: -10%;
        right: -10%;
    }
    
    .gradient-accent-2 {
        width: 40vw;
        height: 40vw;
        background: rgba(45, 212, 191, 0.1);
        bottom: -10%;
        left: -10%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Spruce gradient background -->
<div class="spruce-gradient-bg">
    <div class="spruce-gradient-overlay"></div>
    <div class="gradient-accent gradient-accent-1"></div>
    <div class="gradient-accent gradient-accent-2"></div>
</div>

<div class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white">{{ page_title }}</h1>
            <p class="mt-1 text-sm text-teal-300">Create and customize your emergency medical card.</p>
            
            <!-- Action buttons -->
            <div class="mt-3 flex flex-wrap gap-3">
                <a href="{% url 'emergency_cards:fullscreen_card' %}" class="action-button action-button-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
                    </svg>
                    View Fullscreen
                </a>
                <a href="{% url 'emergency_cards:download_card' %}" class="action-button action-button-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download Card
                </a>
            </div>
        </div>
        
        <!-- Introduction Panel for First-Time Users -->
        <div class="intro-panel bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-8">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-deep-teal mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Welcome to Your Emergency Card Manager</h3>
                    <p class="text-sm text-gray-700">
                        This page lets you create and customize your emergency medical card. Follow the form sections below to set up your card. Your changes will update in real-time as you make them.
                    </p>
                    <div class="mt-3 flex justify-end">
                        <button type="button" class="dismiss-intro text-sm text-deep-teal hover:text-deep-teal-2 font-medium flex items-center">
                            Got it
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <form method="POST" enctype="multipart/form-data" id="card-form">
            {% csrf_token %}
            
            <!-- Hidden input to track active language -->
            <input type="hidden" name="active_language" id="active_language" value="{{ current_lang }}">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Card Preview (Left Side) -->
                <div class="lg:col-span-5 xl:col-span-4 order-2 lg:order-1">
                    <div class="lg:sticky lg:top-6">
                        <!-- Card Preview Section -->
                        <div class="form-section card-preview-section">
                            <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                                <h2 class="text-lg font-medium text-white">Preview Your Card</h2>
                            </div>
                            <div class="p-6 bg-gray-50 rounded-lg" id="card-preview">
                                {% include 'emergency_cards/partials/card_preview.html' %}
                            </div>
                        </div>
                        
                        <!-- Theme Selection -->
                        <div class="form-section mt-6">
                            <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                                <h2 class="text-lg font-medium text-white">Choose a Theme</h2>
                            </div>
                            <div class="form-section-body">
                                <div class="form-group">
                                    <label for="theme-selector" class="form-label">Select a card theme that matches your style:</label>
                                    <select name="theme" id="theme-selector" 
                                            class="form-select"
                                            hx-post="{% url 'emergency_cards:unified_card_management' %}"
                                            hx-trigger="change"
                                            hx-target="#card-preview"
                                            hx-include="#active_language"
                                            hx-vals='{"preview_theme": "true"}'>
                                        {% for theme_value, theme_name in card.get_theme_choices %}
                                            <option value="{{ theme_value }}" {% if card.theme == theme_value %}selected{% endif %}>
                                                {{ theme_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <p class="form-hint">Your theme affects the colors and style of your emergency card.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Panels (Right Side) -->
                <div class="lg:col-span-7 xl:col-span-8 space-y-6 order-1 lg:order-2">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                            <h2 class="text-lg font-medium text-white">Basic Information</h2>
                        </div>
                        <div class="form-section-body">
                            <!-- Medical Condition -->
                            <div class="form-group">
                                <label for="{{ form.condition.id_for_label }}" class="form-label">
                                    What is your medical condition?
                                </label>
                                <select name="{{ form.condition.name }}" id="{{ form.condition.id_for_label }}"
                                        class="form-select"
                                        hx-post="{% url 'emergency_cards:unified_card_management' %}"
                                        hx-trigger="change"
                                        hx-target="#card-preview"
                                        hx-include="#active_language">
                                    {% for value, text in form.condition.field.choices %}
                                        <option value="{{ value }}" {% if form.condition.value == value %}selected{% endif %}>
                                            {{ text }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <p class="form-hint">This will be prominently displayed on your emergency card.</p>
                                {% if form.condition.errors %}
                                    <p class="error-text">{{ form.condition.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <!-- Profile Picture -->
                            <div class="form-group mt-8">
                                <h3 class="form-label mb-3">Do you want to add a profile picture? (Optional)</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        {% if card and card.profile_picture %}
                                            <div class="mb-6">
                                                <img src="{{ card.profile_picture.url }}" alt="Current Profile Picture" class="w-32 h-32 rounded-full object-cover border-2 border-deep-teal">
                                            </div>
                                        {% else %}
                                            <div class="mb-6 w-32 h-32 rounded-full bg-gray-100 flex items-center justify-center border border-gray-200">
                                                <svg class="h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                </svg>
                                            </div>
                                        {% endif %}
                                        
                                        <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                                            Upload or Replace Picture
                                        </label>
                                        <input type="file" name="{{ form.profile_picture.name }}" id="{{ form.profile_picture.id_for_label }}" accept="image/*" 
                                               class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-deep-teal file:text-white hover:file:bg-deep-teal-2">
                                        {% if form.profile_picture.errors %}
                                            <p class="error-text">{{ form.profile_picture.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <div>
                                            <label class="inline-flex items-center mb-3">
                                                <input type="checkbox" name="{{ form.show_profile_pic.name }}" 
                                                       {% if form.show_profile_pic.value %}checked{% endif %}
                                                       class="rounded border-teal-300 text-teal-500 focus:ring-teal-400 h-5 w-5">
                                                <span class="ml-3 text-base text-teal-500 font-medium">Show profile picture on my card</span>
                                            </label>
                                            {% if form.show_profile_pic.errors %}
                                                <p class="error-text">{{ form.show_profile_pic.errors.0 }}</p>
                                            {% endif %}
                                            <p class="text-sm text-teal-200">
                                                A profile picture can help medical personnel identify you in an emergency situation.
                                                Your picture will only appear if you check this option.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medical Message -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-4 flex justify-between items-center">
                            <h2 class="text-lg font-medium text-white">Emergency Message</h2>
                            
                            <!-- Enhanced Language Selector -->
                            <div class="relative">
                                <div class="flex items-center gap-2 celio-btn celio-btn-secondary" 
                                     x-data="{ open: false }" 
                                     @click="open = !open" 
                                     @click.away="open = false">
                                    <!-- Language icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="text-teal-300">
                                        <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
                                        <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14v-.691h-2.36V5h-.538v.867H8.854v.691h3.368c-.438 1.327-1.023 2.177-1.734 2.783-.422-.4-.83-.805-1.242-1.209a17.995 17.995 0 0 1-1.238 1.21c.166.175.34.35.52.525z"/>
                                    </svg>
                                    
                                    <!-- Current language display -->
                                    <span class="text-sm font-medium">
                                        {% for lang_code, lang_name in language_choices %}
                                            {% if current_lang == lang_code %}{{ lang_name }}{% endif %}
                                        {% endfor %}
                                    </span>
                                    
                                    <!-- Dropdown arrow -->
                                    <svg class="w-4 h-4 text-teal-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path x-show="!open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        <path x-show="open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                    </svg>
                                    
                                    <!-- Dropdown Menu -->
                                    <div x-show="open" 
                                         class="absolute right-0 mt-2 py-2 w-48 bg-spruce-700 rounded-md shadow-xl z-20 border border-spruce-600"
                                         style="top: 100%; display: none;" 
                                         x-transition:enter="transition ease-out duration-100" 
                                         x-transition:enter-start="transform opacity-0 scale-95" 
                                         x-transition:enter-end="transform opacity-100 scale-100">
                                        {% for lang_code, lang_name in language_choices %}
                                            <button type="button"
                                                   data-target="card-message-{{ lang_code|lower }}" 
                                                   data-lang="{{ lang_code }}" 
                                                   class="language-selector-item block w-full text-left px-4 py-2 text-sm {% if current_lang == lang_code %}bg-teal-800 text-white{% else %}text-teal-200 hover:bg-spruce-600 hover:text-white{% endif %}">
                                                {{ lang_name }}
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Hidden select element for form submission -->
                                <select id="language-selector" 
                                        name="language"
                                        class="hidden"
                                        hx-post="{% url 'emergency_cards:unified_card_management' %}"
                                        hx-trigger="change"
                                        hx-target="#card-preview"
                                        hx-vals='{"switch_language": "true"}'
                                        hx-swap="outerHTML">
                                    {% for lang_code, lang_name in language_choices %}
                                        <option value="{{ lang_code }}" {% if current_lang == lang_code %}selected{% endif %}>
                                            {{ lang_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-section-body">
                            <p class="text-base text-teal-200 mb-4">
                                What should medical personnel know about your condition in an emergency? 
                                You can provide this information in multiple languages.
                            </p>
                            
                            <!-- Message Content for each language -->
                            {% for lang_code, lang_name in language_choices %}
                                <div id="card-message-{{ lang_code|lower }}" class="language-content {% if current_lang != lang_code %}hidden{% endif %}">
                                    <div class="form-group">
                                        <label for="message-{{ lang_code|lower }}" class="form-label flex items-center">
                                            <span>Message in {{ lang_name }}</span>
                                            {% if lang_code != 'EN' %}
                                                <span class="text-xs text-teal-300 ml-2">(Optional)</span>
                                            {% endif %}
                                        </label>
                                        <textarea id="message-{{ lang_code|lower }}" 
                                                  name="message_{{ lang_code|lower }}" 
                                                  class="form-textarea"
                                                  placeholder="Example: I have Celiac Disease and cannot eat any food containing gluten. In case of emergency, please ensure all food and medication is gluten-free."
                                                  rows="6">{{ translations|get_dict_value:lang_code|default:'' }}</textarea>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Emergency Contact -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-6">
                            <h2 class="text-lg font-medium text-white">Emergency Contact Information</h2>
                        </div>
                        <div class="form-section-body">
                            <p class="text-base text-teal-200 mb-8">
                                Who should be contacted in case of an emergency? This information will be displayed on your card.
                            </p>
                            
                            <div class="space-y-12">
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label">
                                        Contact Name
                                    </label>
                                    <input type="text" name="{{ form.emergency_contact_name.name }}" id="{{ form.emergency_contact_name.id_for_label }}" 
                                           value="{{ form.emergency_contact_name.value|default:'' }}"
                                           placeholder="Enter the full name of your emergency contact"
                                           class="form-input"
                                           hx-post="{% url 'emergency_cards:validate_field' %}"
                                           hx-trigger="blur"
                                           hx-target="#emergency_contact_name_error"
                                           hx-swap="innerHTML"
                                           hx-vals='{"field_name": "emergency_contact_name"}'>
                                    <div id="emergency_contact_name_error" class="error-text">
                                        {% if form.emergency_contact_name.errors %}
                                            {{ form.emergency_contact_name.errors.0 }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_relationship.id_for_label }}" class="form-label">
                                        Relationship to You
                                    </label>
                                    <input type="text" name="{{ form.emergency_contact_relationship.name }}" id="{{ form.emergency_contact_relationship.id_for_label }}" 
                                           value="{{ form.emergency_contact_relationship.value|default:'' }}"
                                           placeholder="Example: Spouse, Parent, Sibling, Friend"
                                           class="form-input"
                                           hx-post="{% url 'emergency_cards:validate_field' %}"
                                           hx-trigger="blur"
                                           hx-target="#emergency_contact_relationship_error"
                                           hx-swap="innerHTML"
                                           hx-vals='{"field_name": "emergency_contact_relationship"}'>
                                    <div id="emergency_contact_relationship_error" class="error-text">
                                        {% if form.emergency_contact_relationship.errors %}
                                            {{ form.emergency_contact_relationship.errors.0 }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label">
                                        Phone Number
                                    </label>
                                    <input type="tel" name="{{ form.emergency_contact_phone.name }}" id="{{ form.emergency_contact_phone.id_for_label }}" 
                                           value="{{ form.emergency_contact_phone.value|default:'' }}"
                                           placeholder="+1 (555) 123-4567"
                                           class="form-input"
                                           hx-post="{% url 'emergency_cards:validate_field' %}"
                                           hx-trigger="blur"
                                           hx-target="#emergency_contact_phone_error"
                                           hx-swap="innerHTML"
                                           hx-vals='{"field_name": "emergency_contact_phone"}'>
                                    <div id="emergency_contact_phone_error" class="error-text">
                                        {% if form.emergency_contact_phone.errors %}
                                            {{ form.emergency_contact_phone.errors.0 }}
                                        {% endif %}
                                    </div>
                                    <p class="form-hint">Include country code if needed (e.g., +1 for US and Canada)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex justify-end pt-6 pb-12">
                        <button type="submit" class="action-button action-button-primary text-base px-8 py-4">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save My Emergency Card
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Language selection handling
        const languageSelector = document.getElementById('language-selector');
        const languageSelectorItems = document.querySelectorAll('.language-selector-item');
        const activeLanguageInput = document.getElementById('active_language');
        
        function activateLanguage(lang) {
            // Update hidden input
            if (activeLanguageInput) {
                activeLanguageInput.value = lang;
            }
            
            // Hide all language content and show the selected one
            document.querySelectorAll('.language-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const targetContent = document.getElementById('card-message-' + lang.toLowerCase());
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
            
            // Update the language selector
            if (languageSelector) {
                languageSelector.value = lang;
                languageSelector.dispatchEvent(new Event('change'));
            }
        }
        
        // Set up event listeners for language selector items
        languageSelectorItems.forEach(item => {
            item.addEventListener('click', function() {
                const lang = this.getAttribute('data-lang');
                activateLanguage(lang);
            });
        });
        
        // Tab functionality
        const tabButtons = document.querySelectorAll('.language-tab');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        function activateTab(target, lang) {
            // Hide all panels
            tabPanels.forEach(panel => {
                panel.classList.add('hidden');
                panel.classList.remove('block');
            });
            
            // Show the target panel
            const panel = document.getElementById(target);
            if (panel) {
                panel.classList.remove('hidden');
                panel.classList.add('block');
            }
            
            // Update tab styles
            tabButtons.forEach(button => {
                if (button.getAttribute('data-target') === target) {
                    button.classList.add('border-b-2', 'border-deep-teal', 'text-deep-teal');
                    button.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    button.setAttribute('aria-selected', 'true');
                } else {
                    button.classList.remove('border-b-2', 'border-deep-teal', 'text-deep-teal');
                    button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    button.setAttribute('aria-selected', 'false');
                }
            });
            
            // Update the hidden active language input and dropdown
            if (activeLanguageInput && lang) {
                activeLanguageInput.value = lang;
                
                // Also update the language dropdown to match
                if (languageSelector) {
                    languageSelector.value = lang;
                }
            }
        }
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                const lang = this.getAttribute('data-lang');
                activateTab(target, lang);
                
                // Also trigger live preview update for the selected language
                if (languageSelector) {
                    const event = new Event('change');
                    languageSelector.dispatchEvent(event);
                }
            });
        });
        
        // Sync changes to the message fields with the preview
        const messageFields = document.querySelectorAll('textarea[name^="message_"]');
        messageFields.forEach(field => {
            field.addEventListener('input', debounce(function() {
                // Only update if this is the currently active language
                const langCode = field.name.replace('message_', '').toUpperCase();
                if (activeLanguageInput.value.toUpperCase() === langCode) {
                    // Trigger the language selector to update the preview
                    if (languageSelector) {
                        const event = new Event('change');
                        languageSelector.dispatchEvent(event);
                    }
                }
            }, 500));
        });
        
        // Debounce helper function to limit how often a function runs
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Make sure dropdown and language tabs stay in sync
        if (languageSelector) {
            languageSelector.addEventListener('change', function() {
                const lang = this.value;
                const target = `card-message-${lang.toLowerCase()}`;
                
                // First update the hidden input
                activeLanguageInput.value = lang;
                
                // Then find and activate the matching tab
                const matchingTab = document.querySelector(`.language-tab[data-target="${target}"]`);
                if (matchingTab) {
                    activateTab(target, lang);
                }
            });
        }
        
        // Remove scrollbar but keep functionality
        document.querySelectorAll('.no-scrollbar').forEach(element => {
            element.style.cssText = 'scrollbar-width: none; -ms-overflow-style: none;';
            const style = document.createElement('style');
            style.textContent = `.no-scrollbar::-webkit-scrollbar { display: none; }`;
            document.head.appendChild(style);
        });
        
        // Introduction panel dismiss functionality
        const introPanel = document.querySelector('.intro-panel');
        if (introPanel && localStorage.getItem('hiddenIntroPanel') === 'true') {
            introPanel.classList.add('hidden');
        }
        
        const dismissButton = document.querySelector('.dismiss-intro');
        if (dismissButton) {
            dismissButton.addEventListener('click', function() {
                introPanel.classList.add('hidden');
                localStorage.setItem('hiddenIntroPanel', 'true');
            });
        }
        
        // On mobile, switch the order of elements to show preview at top
        function handleResponsiveLayout() {
            const previewContainer = document.querySelector('.order-2.lg\\:order-1');
            const formContainer = document.querySelector('.order-1.lg\\:order-2');
            
            if (window.innerWidth < 1024) {
                // On mobile: preview first, then form
                if (previewContainer) previewContainer.classList.replace('order-2', 'order-1');
                if (formContainer) formContainer.classList.replace('order-1', 'order-2');
            } else {
                // On desktop: form on right, preview on left
                if (previewContainer) previewContainer.classList.replace('order-1', 'order-2');
                if (formContainer) formContainer.classList.replace('order-2', 'order-1');
            }
        }
        
        // Initial call
        handleResponsiveLayout();
        
        // Listen for resize events
        window.addEventListener('resize', handleResponsiveLayout);
    });
</script>
{% endblock %}
