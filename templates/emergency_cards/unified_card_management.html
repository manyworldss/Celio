{% extends 'base.html' %}
{% load static %}
{% load message_card_filters %}

{% block title %}{{ page_title }} - Celio{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/emergency_card_themes.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block extra_css %}
    <style>
        /* Removed inline CSS variables and body styles to avoid conflicts with external CSS */
    
    /* Enhanced Mobile Responsiveness */
    @media (max-width: 1024px) {
        .order-1 {
            order: 2;
        }
        
        .order-2 {
            order: 1;
        }
    }
    
    /* Mobile-first improvements */
    @media (max-width: 640px) {
        .primary-gradient-bg {
            background-attachment: scroll;
        }
        
        /* Improve card visibility on mobile */
        .editable-card {
            max-width: 100%;
            margin: 0 auto;
        }
        
        /* Better spacing for mobile */
        .form-section {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Optimize text sizes for mobile */
        h1 {
            line-height: 1.2;
        }
        
        /* Improve button accessibility on mobile */
        button, .btn {
            min-height: 44px;
            padding: 0.75rem 1rem;
        }
    }
    
    /* Tablet optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
        .max-w-4xl {
            max-width: 90%;
        }
    }
    
    /* Section styling */
    .form-section {
        background-color: #d3d3d3;
        border-radius: 0.75rem;
        padding: 1.75rem;
        border: 1px solid rgba(34, 197, 94, 0.3);
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        padding: 0;
        border-bottom: 1px solid rgba(26, 66, 55, 0.7);
        background-color: transparent;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header h2 {
        color: white;
        font-weight: 600;
    }
    
    /* Improved form controls */
    .form-group {
        margin-bottom: 2.25rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        color: white;
        margin-bottom: 0.75rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        background-color: rgba(20, 50, 42, 0.2);
        color: white;
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--teal-400);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
    }
    
    .form-textarea {
        min-height: 8rem;
    }
    
    .form-hint {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--teal-200);
    }
    
    .error-text {
        color: #f87171;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Action buttons with improved styling */
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .action-button-primary {
        background-color: var(--teal-600);
        color: white;
        border: none;
    }
    
    .action-button-primary:hover {
        background-color: var(--teal-500);
    }
    
    .action-button-secondary {
        background-color: rgba(20, 50, 42, 0.4);
        color: white;
        border: 1px solid var(--spruce-700);
    }

    .action-button-secondary:hover {
        background-color: rgba(20, 50, 42, 0.6);
    }
    
    /* Intro panel */
    .intro-panel {
        background-color: #d3d3d3;
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(34, 197, 94, 0.3);
        margin-bottom: 2rem;
    }
    
    .intro-panel h3 {
        color: white;
    }
    
    .intro-panel p {
        color: var(--teal-200);
    }
    
    .dismiss-intro {
        color: var(--teal-400);
    }
    
    .dismiss-intro:hover {
        color: var(--teal-300);
    }
    
    /* Language tabs */
    .language-tab {
        color: var(--teal-300);
        border-bottom-color: transparent;
    }
    
    .language-tab[aria-selected="true"] {
        color: white;
        border-bottom-color: var(--teal-400);
    }
    
    .language-tab:hover:not([aria-selected="true"]) {
        color: var(--teal-200);
    }
    
    /* Card preview style */
    #card-preview {
        background-color: var(--primary-900);
        border: 1px solid var(--primary-700);
        border-radius: 0.5rem;
    }
    
    /* Travel-themed gradient background */
    .primary-gradient-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -10;
        background: #e8f5e8;
        overflow: hidden;
    }
    
    .primary-gradient-overlay {
        display: none;
    }
    
    .gradient-accent {
        display: none;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-15px) rotate(90deg); }
    }
    
    @media (max-width: 768px) {
        .gradient-accent {
            animation: floatMobile 8s ease-in-out infinite;
        }
        
        @keyframes floatMobile {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(45deg); }
        }
    }
    
    .gradient-accent-1 {
        width: 50vw;
        height: 50vw;
        background: radial-gradient(circle, rgba(34, 197, 94, 0.25) 0%, rgba(16, 185, 129, 0.15) 50%, transparent 70%);
        top: -15%;
        right: -15%;
        animation-delay: -2s;
    }
    
    .gradient-accent-2 {
        width: 35vw;
        height: 35vw;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(34, 197, 94, 0.12) 50%, transparent 70%);
        bottom: -15%;
        left: -15%;
        animation-delay: -4s;
    }
</style>
{% endblock %}

{% block content %}
<!-- Primary gradient background -->
<div class="primary-gradient-bg">
        <div class="primary-gradient-overlay"></div>
    <div class="gradient-accent gradient-accent-1"></div>
    <div class="gradient-accent gradient-accent-2"></div>
</div>

<div class="min-h-screen py-4 sm:py-6 lg:py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header - Mobile Optimized -->
        <div class="mb-6 sm:mb-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-2 sm:mb-4 tracking-tight">{{ page_title }}</h1>
                <p class="text-sm sm:text-base lg:text-lg text-teal-300 px-4">Create your personalized e-card for safe travel and dining</p>
            </div>
            
            <!-- Interactive E-Card Section -->
            <div class="mb-6">
                <!-- Card Container with Mobile-First Design -->
                <div class="flex justify-center px-4">
                    <div class="w-full max-w-sm sm:max-w-md">
                        {% include "emergency_cards/partials/editable_card.html" with card=card preview_theme=preview_theme language_choices=language_choices current_lang=current_lang is_preview=True %}
                    </div>
                </div>
                
                <!-- Quick Action Hint -->
                <div class="text-center mt-4">
                    <p class="text-xs sm:text-sm text-teal-400 flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.122 2.122"></path>
                        </svg>
                        <span>Tap any field above to start editing</span>
                    </p>
                </div>
            </div>
                
                <!-- Quick Guide - Mobile Optimized -->
                <div class="max-w-4xl mx-auto mb-8">
                    <!-- Collapsible Guide Section -->
                    <div class="bg-gradient-to-br from-spruce-700/50 to-spruce-800/30 rounded-xl border border-spruce-600/30 backdrop-blur-sm overflow-hidden">
                        <button type="button" 
                                onclick="toggleGuide()" 
                                class="w-full p-4 sm:p-6 flex items-center justify-between text-left hover:bg-spruce-700/30 transition-all duration-300">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg sm:text-xl font-semibold text-white">How to Use Your E-Card</h3>
                                    <p class="text-sm text-purple-300 mt-1">Quick setup guide • Tap to expand</p>
                                </div>
                            </div>
                            <svg id="guide-chevron" class="w-5 h-5 text-purple-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div id="guide-content" class="hidden border-t border-spruce-600/50">
                            <div class="p-4 sm:p-6">
                                <!-- Mobile-First Step Cards -->
                                <div class="space-y-4">
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            1
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Edit Your Information</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Tap any field on the card above to customize your medical details</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            2
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Choose Language & Theme</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Select your preferred language and visual style</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            3
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Save & Use</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Save your card and show it to restaurants, medical staff, or anyone who needs to understand your dietary restrictions</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Benefits -->
                                <div class="mt-6 pt-4 border-t border-spruce-600/30">
                                    <h4 class="text-white font-medium text-sm mb-3">Why Use an E-Card?</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs sm:text-sm">
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Clear communication in any language</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Always accessible on your phone</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Professional medical format</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Perfect for travel & dining</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>

        
        <form method="POST" enctype="multipart/form-data" id="card-form" hx-post="{% url 'message_cards:unified_card_management' %}" hx-swap="none" hx-trigger="none">
            {% csrf_token %}
            
            <!-- Hidden inputs to track active language and theme -->
            <input type="hidden" name="active_language" id="active_language" value="{{ current_lang }}">
            {% with current_theme=preview_theme %}
                {% if not current_theme and card and card.theme %}
                    {% with current_theme=card.theme %}
                        <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                    {% endwith %}
                {% elif not current_theme %}
                    {% with current_theme='light' %}
                        <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                    {% endwith %}
                {% else %}
                    <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                {% endif %}
            {% endwith %}
            <input type="hidden" name="save_card" id="save_card_input" value="false">
            

                </div> <!-- End of hidden sections -->

                <!-- Card Container (Full Screen) -->
                <div class="card-fullscreen-container max-w-4xl mx-auto">
                    
                    <!-- Card Preview Container (full-width) -->
                    <div id="card-preview-container" class="relative overflow-hidden bg-white bg-opacity-5 rounded-lg p-4 flex justify-center items-center">
                        <!-- This container will be populated by the editable card when editing -->
                    </div>
                    
                    <!-- Hidden theme input that will be updated by JavaScript -->
                    {% with current_theme=preview_theme %}
                        {% if not current_theme and card and card.theme %}
                            {% with current_theme=card.theme %}
                                <input type="hidden" name="theme" id="selected-theme" value="{{ current_theme }}">
                            {% endwith %}
                        {% elif not current_theme %}
                            {% with current_theme='light' %}
                                <input type="hidden" name="theme" id="selected-theme" value="{{ current_theme }}">
                            {% endwith %}
                        {% else %}
                            <input type="hidden" name="theme" id="selected-theme" value="{{ current_theme }}">
                        {% endif %}
                    {% endwith %}
                </div>

                <!-- Hidden sections that were previously visible -->
                <div class="hidden">
                    <!-- Hidden file input to maintain form functionality -->
                    <input type="file" name="{{ form.profile_picture.name }}" id="{{ form.profile_picture.id_for_label }}" hidden>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Removed fetch-based preview update JS for language and theme switching; now handled by HTMX.

    document.addEventListener('DOMContentLoaded', function() {
        // Prevent form submission which causes page refresh
        const cardForm = document.getElementById('card-form');
        cardForm.addEventListener('submit', function(e) {
            const isSubmitButton = e.submitter && e.submitter.type === 'submit' && e.submitter.classList.contains('action-button-primary');
            if (!isSubmitButton) {
                e.preventDefault(); // Only let the form submit when using the save button
            }
        });
        
        // Store the current scroll position
        function saveScrollPosition() {
            window.sessionStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        }
        
        // Restore the scroll position
        function restoreScrollPosition() {
            const savedPosition = window.sessionStorage.getItem('scrollPosition');
            if (savedPosition) {
                window.scrollTo(0, savedPosition);
            }
        }
        
        // Get CSRF token from cookie
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            if (!cookieValue) {
                console.error('CSRF token not found in cookies');
            }
            
            return cookieValue;
        }
        
        // Function to update the card preview with HTMX
        function updateCardPreview() {
            const currentLang = document.getElementById('active_language').value;
            const selectedTheme = document.getElementById('theme-selector').value;
            const messageTextarea = document.getElementById('message');
            
            console.log('Updating preview with theme:', selectedTheme, 'and language:', currentLang);
            
            // Create form data for the update
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', currentLang);
            formData.append('preview_theme', selectedTheme);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message 
            if (messageTextarea) {
                formData.append('message_' + currentLang.toLowerCase(), messageTextarea.value);
            }
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating preview...</div></div>';
            }
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with theme:', selectedTheme);
                    
                    // Update the hidden theme input
                    document.getElementById('selected-theme').value = selectedTheme;
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up language selector handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup for all dropdowns that might be in the DOM
            setupLanguageDropdowns();
            setupThemeDropdowns();
            
            // Set up live preview updates for message changes
            setupMessageTextareaListeners();
            
            // Set up save button handler
            const saveButton = document.getElementById('save-card-button');
            if (saveButton) {
                saveButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('card-form');
                    if (!form) return;
                    
                    // Create a hidden input for save_card if it doesn't exist
                    let saveCardInput = document.getElementById('save_card_input');
                    if (!saveCardInput) {
                        saveCardInput = document.createElement('input');
                        saveCardInput.type = 'hidden';
                        saveCardInput.name = 'save_card';
                        saveCardInput.id = 'save_card_input';
                        form.appendChild(saveCardInput);
                    }
                    saveCardInput.value = 'true';
                    
                    // Show saving indicator
                    const saveText = document.querySelector('.save-text');
                    const originalText = saveText.textContent;
                    saveText.textContent = 'Saving...';
                    document.querySelector('.autosave-status').textContent = 'Saving your E-Card...';
                    
                    // Submit the form
                    form.submit();
                });
            }
            
            // Set up theme dropdowns
            setupThemeDropdowns();
            
            // Apply initial translations based on the current language
            let currentLang = document.getElementById('active_language').value;
            // Ensure language code is lowercase
            currentLang = currentLang.toLowerCase();
            document.getElementById('active_language').value = currentLang;
            console.log('Initial language (lowercase):', currentLang);
            translateUIElements(currentLang);
        });
        
        // Function to set up all language dropdowns in the DOM
        function setupLanguageDropdowns() {
            const dropdowns = document.querySelectorAll('.language-selector-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', handleLanguageChange);
            });
        }
        
        // Function to set up all theme dropdowns
        function setupThemeDropdowns() {
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                selector.addEventListener('change', handleThemeChange);
            });
        }
        
        // Translation dictionary for UI elements
        const translations = {
            'en': {
                'Medical Information': 'Dietary Information',
                'Message': 'Message',
                'Contact': 'Contact',
                'No contact listed.': 'No contact listed.',
                'No message available.': 'No message available.',
                'Autoimmune disorder triggered by gluten': 'Autoimmune disorder triggered by gluten',
                'Can cause severe intestinal damage': 'Can cause severe intestinal damage',
                'Requires strict gluten-free diet': 'Requires strict gluten-free diet',
                'Non-celiac gluten sensitivity': 'Non-celiac gluten sensitivity',
                'Causes discomfort but not intestinal damage': 'Causes discomfort but not intestinal damage',
                'Requires gluten-free diet for symptom control': 'Requires gluten-free diet for symptom control',
                'Immune system reaction to wheat proteins': 'Immune system reaction to wheat proteins',
                'Can cause immediate allergy symptoms': 'Can cause immediate allergy symptoms',
                'May require assistance if severe': 'May require assistance if severe',
                'Requires avoidance of gluten-containing foods': 'Requires avoidance of gluten-containing foods',
                'Needs careful meal preparation': 'Needs careful meal preparation',
                'Profile Picture': 'Profile Picture'
            },
            'es': {
                'Medical Information': 'Información Dietética',
                'Message': 'Mensaje',
                'Contact': 'Contacto',
                'No contact listed.': 'No hay contacto registrado.',
                'No message available.': 'No hay mensaje disponible.',
                'Autoimmune disorder triggered by gluten': 'Trastorno autoinmune desencadenado por el gluten',
                'Can cause severe intestinal damage': 'Puede causar daño intestinal severo',
                'Requires strict gluten-free diet': 'Requiere dieta estricta sin gluten',
                'Non-celiac gluten sensitivity': 'Sensibilidad al gluten no celíaca',
                'Causes discomfort but not intestinal damage': 'Causa malestar pero no daño intestinal',
                'Requires gluten-free diet for symptom control': 'Requiere dieta sin gluten para controlar los síntomas',
                'Immune system reaction to wheat proteins': 'Reacción del sistema inmunológico a las proteínas del trigo',
                'Can cause immediate allergy symptoms': 'Puede causar síntomas alérgicos inmediatos',
                'May require assistance if severe': 'Puede requerir asistencia si es grave',
                'Requires avoidance of gluten-containing foods': 'Requiere evitar alimentos con gluten',
                'Needs careful meal preparation': 'Necesita preparación cuidadosa de comidas',
                'Profile Picture': 'Foto de Perfil'
            },
            'fr': {
                'Medical Information': 'Informations Diététiques',
                'Message': 'Message',
                'Contact': 'Contact',
                'No contact listed.': 'Aucun contact indiqué.',
                'No message available.': 'Aucun message disponible.',
                'Autoimmune disorder triggered by gluten': 'Trouble auto-immun déclenché par le gluten',
                'Can cause severe intestinal damage': 'Peut causer de graves lésions intestinales',
                'Requires strict gluten-free diet': 'Nécessite un régime strict sans gluten',
                'Non-celiac gluten sensitivity': 'Sensibilité au gluten non cœliaque',
                'Causes discomfort but not intestinal damage': 'Provoque de l\'inconfort mais pas de lésions intestinales',
                'Requires gluten-free diet for symptom control': 'Nécessite un régime sans gluten pour contrôler les symptômes',
                'Immune system reaction to wheat proteins': 'Réaction du système immunitaire aux protéines de blé',
                'Can cause immediate allergy symptoms': 'Peut provoquer des symptômes allergiques immédiats',
                'May require assistance if severe': 'Peut nécessiter une assistance si grave',
                'Requires avoidance of gluten-containing foods': 'Exige d\'éviter les aliments contenant du gluten',
                'Needs careful meal preparation': 'Nécessite une préparation soignée des repas',
                'Profile Picture': 'Photo de Profil'
            },
            'de': {
                'Medical Information': 'Diätetische Informationen',
                'Message': 'Nachricht',
                'Contact': 'Kontakt',
                'No contact listed.': 'Kein Kontakt angegeben.',
                'No message available.': 'Keine Nachricht verfügbar.',
                'Autoimmune disorder triggered by gluten': 'Durch Gluten ausgelöste Autoimmunerkrankung',
                'Can cause severe intestinal damage': 'Kann schwere Darmschäden verursachen',
                'Requires strict gluten-free diet': 'Erfordert strenge glutenfreie Diät',
                'Non-celiac gluten sensitivity': 'Nicht-Zöliakie-Glutensensitivität',
                'Causes discomfort but not intestinal damage': 'Verursacht Beschwerden, aber keine Darmschäden',
                'Requires gluten-free diet for symptom control': 'Erfordert glutenfreie Diät zur Symptomkontrolle',
                'Immune system reaction to wheat proteins': 'Immunsystemreaktion auf Weizenproteine',
                'Can cause immediate allergy symptoms': 'Kann sofortige allergische Symptome verursachen',
                'May require assistance if severe': 'Kann bei schweren Fällen Hilfe erfordern',
                'Requires avoidance of gluten-containing foods': 'Erfordert die Vermeidung glutenhaltiger Lebensmittel',
                'Needs careful meal preparation': 'Erfordert sorgfältige Mahlzeitenzubereitung',
                'Profile Picture': 'Profilbild'
            },
            'it': {
                'Medical Information': 'Informazioni Dietetiche',
                'Message': 'Messaggio',
                'Contact': 'Contatto',
                'No contact listed.': 'Nessun contatto elencato.',
                'No message available.': 'Nessun messaggio disponibile.',
                'Autoimmune disorder triggered by gluten': 'Disturbo autoimmune scatenato dal glutine',
                'Can cause severe intestinal damage': 'Può causare gravi danni intestinali',
                'Requires strict gluten-free diet': 'Richiede dieta rigorosamente senza glutine',
                'Non-celiac gluten sensitivity': 'Sensibilità al glutine non celiaca',
                'Causes discomfort but not intestinal damage': 'Causa disagio ma non danni intestinali',
                'Requires gluten-free diet for symptom control': 'Richiede dieta senza glutine per il controllo dei sintomi',
                'Immune system reaction to wheat proteins': 'Reazione del sistema immunitario alle proteine del grano',
                'Can cause immediate allergy symptoms': 'Può causare sintomi allergici immediati',
                'May require assistance if severe': 'Può richiedere assistenza se grave',
                'Requires avoidance of gluten-containing foods': 'Richiede di evitare cibi contenenti glutine',
                'Needs careful meal preparation': 'Richiede preparazione attenta dei pasti',
                'Profile Picture': 'Foto del Profilo'
            },
            'pt': {
                'Medical Information': 'Informações Dietéticas',
                'Message': 'Mensagem',
                'Contact': 'Contato',
                'No contact listed.': 'Nenhum contato listado.',
                'No message available.': 'Nenhuma mensagem disponível.',
                'Autoimmune disorder triggered by gluten': 'Distúrbio autoimune desencadeado pelo glúten',
                'Can cause severe intestinal damage': 'Pode causar danos intestinais graves',
                'Requires strict gluten-free diet': 'Requer dieta rigorosamente sem glúten',
                'Non-celiac gluten sensitivity': 'Sensibilidade ao glúten não celíaca',
                'Causes discomfort but not intestinal damage': 'Causa desconforto mas não danos intestinais',
                'Requires gluten-free diet for symptom control': 'Requer dieta sem glúten para controle dos sintomas',
                'Immune system reaction to wheat proteins': 'Reação do sistema imunológico às proteínas do trigo',
                'Can cause immediate allergy symptoms': 'Pode causar sintomas alérgicos imediatos',
                'May require assistance if severe': 'Pode requerer assistência se grave',
                'Requires avoidance of gluten-containing foods': 'Requer evitar alimentos contendo glúten',
                'Needs careful meal preparation': 'Necessita preparação cuidadosa das refeições',
                'Profile Picture': 'Foto do Perfil'
            },
            'ja': {
                'Medical Information': '食事情報',
                'Message': 'メッセージ',
                'Contact': '連絡先',
                'No contact listed.': '連絡先が登録されていません。',
                'No message available.': 'メッセージがありません。',
                'Autoimmune disorder triggered by gluten': 'グルテンによって引き起こされる自己免疫疾患',
                'Can cause severe intestinal damage': '重篤な腸の損傷を引き起こす可能性があります',
                'Requires strict gluten-free diet': '厳格なグルテンフリー食事が必要',
                'Non-celiac gluten sensitivity': '非セリアック性グルテン過敏症',
                'Causes discomfort but not intestinal damage': '不快感を引き起こしますが腸の損傷はありません',
                'Requires gluten-free diet for symptom control': '症状管理のためグルテンフリー食事が必要',
                'Immune system reaction to wheat proteins': '小麦タンパク質に対する免疫系の反応',
                'Can cause immediate allergy symptoms': '即座にアレルギー症状を引き起こす可能性があります',
                'May require assistance if severe': '重篤な場合は援助が必要な場合があります',
                'Requires avoidance of gluten-containing foods': 'グルテンを含む食品の回避が必要',
                'Needs careful meal preparation': '注意深い食事の準備が必要',
                'Profile Picture': 'プロフィール写真'
            },
            'zh': {
                'Medical Information': '饮食信息',
                'Message': '消息',
                'Contact': '联系人',
                'No contact listed.': '未列出联系人。',
                'No message available.': '没有可用的消息。',
                'Autoimmune disorder triggered by gluten': '由麸质引发的自身免疫性疾病',
                'Can cause severe intestinal damage': '可能导致严重的肠道损伤',
                'Requires strict gluten-free diet': '需要严格的无麸质饮食',
                'Non-celiac gluten sensitivity': '非乳糜泻麸质敏感性',
                'Causes discomfort but not intestinal damage': '引起不适但不会造成肠道损伤',
                'Requires gluten-free diet for symptom control': '需要无麸质饮食来控制症状',
                'Immune system reaction to wheat proteins': '免疫系统对小麦蛋白的反应',
                'Can cause immediate allergy symptoms': '可能引起即时过敏症状',
                'May require assistance if severe': '如果严重可能需要协助',
                'Requires avoidance of gluten-containing foods': '需要避免含麸质的食物',
                'Needs careful meal preparation': '需要仔细的膳食准备',
                'Profile Picture': '个人照片'
            },
            'ko': {
                'Medical Information': '의료 정보',
                'Message': '메시지',
                'Contact': '연락처',
                'No contact listed.': '등록된 연락처가 없습니다.',
                'No message available.': '사용 가능한 메시지가 없습니다.',
                'Autoimmune disorder triggered by gluten': '글루텐에 의해 유발되는 자가면역 질환',
                'Can cause severe intestinal damage': '심각한 장 손상을 일으킬 수 있습니다',
                'Requires strict gluten-free diet': '엄격한 글루텐 프리 식단이 필요합니다',
                'Non-celiac gluten sensitivity': '비셀리악 글루텐 민감성',
                'Causes discomfort but not intestinal damage': '불편함을 유발하지만 장 손상은 없습니다',
                'Requires gluten-free diet for symptom control': '증상 조절을 위해 글루텐 프리 식단이 필요합니다',
                'Immune system reaction to wheat proteins': '밀 단백질에 대한 면역계 반응',
                'Can cause immediate allergy symptoms': '즉각적인 알레르기 증상을 일으킬 수 있습니다',
                'May require assistance if severe': '심각한 경우 도움이 필요할 수 있습니다',
                'Requires avoidance of gluten-containing foods': '글루텐 함유 식품의 회피가 필요합니다',
                'Needs careful meal preparation': '신중한 식사 준비가 필요합니다',
                'Profile Picture': '프로필 사진'
            },
            'ar': {
                'Medical Information': 'المعلومات الطبية',
                'Message': 'رسالة',
                'Contact': 'جهة الاتصال',
                'No contact listed.': 'لا توجد جهة اتصال مدرجة.',
                'No message available.': 'لا توجد رسالة متاحة.',
                'Autoimmune disorder triggered by gluten': 'اضطراب المناعة الذاتية الناجم عن الغلوتين',
                'Can cause severe intestinal damage': 'يمكن أن يسبب ضررًا معويًا شديدًا',
                'Requires strict gluten-free diet': 'يتطلب نظامًا غذائيًا صارمًا خاليًا من الغلوتين',
                'Non-celiac gluten sensitivity': 'حساسية الغلوتين غير السيلياك',
                'Causes discomfort but not intestinal damage': 'يسبب عدم الراحة ولكن ليس ضررًا معويًا',
                'Requires gluten-free diet for symptom control': 'يتطلب نظامًا غذائيًا خاليًا من الغلوتين للسيطرة على الأعراض',
                'Immune system reaction to wheat proteins': 'رد فعل الجهاز المناعي لبروتينات القمح',
                'Can cause immediate allergy symptoms': 'يمكن أن يسبب أعراض حساسية فورية',
                'May require assistance if severe': 'قد يتطلب المساعدة إذا كان شديدًا',
                'Requires avoidance of gluten-containing foods': 'يتطلب تجنب الأطعمة التي تحتوي على الغلوتين',
                'Needs careful meal preparation': 'يحتاج إلى إعداد وجبات بعناية',
                'Profile Picture': 'صورة الملف الشخصي'
            },
            'ru': {
                'Medical Information': 'Медицинская информация',
                'Message': 'Сообщение',
                'Contact': 'Контакт',
                'No contact listed.': 'Контакт не указан.',
                'No message available.': 'Сообщение недоступно.',
                'Autoimmune disorder triggered by gluten': 'Аутоиммунное расстройство, вызванное глютеном',
                'Can cause severe intestinal damage': 'Может вызвать серьезное повреждение кишечника',
                'Requires strict gluten-free diet': 'Требует строгой безглютеновой диеты',
                'Non-celiac gluten sensitivity': 'Нецелиакальная чувствительность к глютену',
                'Causes discomfort but not intestinal damage': 'Вызывает дискомфорт, но не повреждение кишечника',
                'Requires gluten-free diet for symptom control': 'Требует безглютеновой диеты для контроля симптомов',
                'Immune system reaction to wheat proteins': 'Реакция иммунной системы на белки пшеницы',
                'Can cause immediate allergy symptoms': 'Может вызвать немедленные аллергические симптомы',
                'May require assistance if severe': 'Может потребоваться помощь при тяжелом течении',
                'Requires avoidance of gluten-containing foods': 'Требует избегания продуктов, содержащих глютен',
                'Needs careful meal preparation': 'Требует тщательного приготовления пищи',
                'Profile Picture': 'Фотография профиля'
            },
            'hi': {
                'Medical Information': 'चिकित्सा जानकारी',
                'Message': 'संदेश',
                'Contact': 'संपर्क',
                'No contact listed.': 'कोई संपर्क सूचीबद्ध नहीं।',
                'No message available.': 'कोई संदेश उपलब्ध नहीं।',
                'Autoimmune disorder triggered by gluten': 'ग्लूटेन द्वारा ट्रिगर किया गया ऑटोइम्यून विकार',
                'Can cause severe intestinal damage': 'गंभीर आंतों की क्षति का कारण बन सकता है',
                'Requires strict gluten-free diet': 'सख्त ग्लूटेन-फ्री आहार की आवश्यकता है',
                'Non-celiac gluten sensitivity': 'गैर-सीलिएक ग्लूटेन संवेदनशीलता',
                'Causes discomfort but not intestinal damage': 'असुविधा का कारण बनता है लेकिन आंतों की क्षति नहीं',
                'Requires gluten-free diet for symptom control': 'लक्षण नियंत्रण के लिए ग्लूटेन-फ्री आहार की आवश्यकता है',
                'Immune system reaction to wheat proteins': 'गेहूं प्रोटीन के लिए प्रतिरक्षा प्रणाली की प्रतिक्रिया',
                'Can cause immediate allergy symptoms': 'तत्काल एलर्जी के लक्षण पैदा कर सकता है',
                'May require assistance if severe': 'गंभीर होने पर सहायता की आवश्यकता हो सकती है',
                'Requires avoidance of gluten-containing foods': 'ग्लूटेन युक्त खाद्य पदार्थों से बचने की आवश्यकता है',
                'Needs careful meal preparation': 'सावधानीपूर्वक भोजन तैयार करने की आवश्यकता है',
                'Profile Picture': 'प्रोफ़ाइल चित्र'
            }
        };
        
        // Function to translate UI elements based on selected language
        function translateUIElements(langCode) {
            // If translations for this language don't exist, use English as fallback
            const langDict = translations[langCode.toLowerCase()] || translations['en'];
            console.log('Translating UI elements to', langCode, 'with dictionary:', langDict);
            
            // Find all elements with data-i18n attribute and translate them
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langDict[key]) {
                    element.textContent = langDict[key];
                }
            });
            
            console.log('UI elements translated to', langCode);
        }
        
        // Handle language change from dropdown
        function handleLanguageChange(e) {
            // Ensure language is lowercase
            const lang = this.value.toLowerCase();
            const prevLang = document.getElementById('active_language').value.toLowerCase();
            console.log('Language selected:', lang, 'Previous language:', prevLang);
            
            // Don't do anything if the language hasn't changed
            if (lang === prevLang) {
                return;
            }
            
            // For debugging
            console.log('Switching language from', prevLang, 'to', lang);
            
            // Update hidden input
            document.getElementById('active_language').value = lang;
            
            // Update all language selectors to match
            const langSelectors = document.querySelectorAll('.language-selector-dropdown');
            langSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = lang;
                }
            });
            
            // Update language display
            const displayElement = document.getElementById('current-language-display');
            if (displayElement) {
                displayElement.textContent = this.options[this.selectedIndex].text;
            }
                
            // Apply translations immediately for better UX
            translateUIElements(lang);
            
            // Show loading indicator in the card preview
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Translating...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data for language switch
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', lang);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Language switch failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                console.log('Received language switch response');
                
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with language:', lang);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Update the language tabs if they exist
                const languageTabs = document.querySelectorAll('.language-tab');
                if (languageTabs.length > 0) {
                    languageTabs.forEach(tab => {
                        const tabLang = tab.getAttribute('data-lang');
                        if (tabLang === lang) {
                            tab.setAttribute('aria-selected', 'true');
                            tab.classList.add('active-language');
                        } else {
                            tab.setAttribute('aria-selected', 'false');
                            tab.classList.remove('active-language');
                        }
                    });
                }
                
                // Restore scroll position
                window.scrollTo(0, scrollPosition);
            })
            .catch(error => {
                console.error('Error switching language:', error);
                // Restore original content if there was an error
                alert('There was an error switching languages. Please try again.');
            });
            
            // Store the language preference in localStorage for persistence
            localStorage.setItem('preferred_language', lang);
        }
        
        // Handle global language change (from top controls)
        function handleGlobalLanguageChange(lang) {
            // Update all language selectors including the one on the card
            const cardLanguageSelector = document.getElementById('language-selector');
            if (cardLanguageSelector) {
                cardLanguageSelector.value = lang;
                // Trigger the card's language change handler
                const event = new Event('change');
                cardLanguageSelector.dispatchEvent(event);
            } else {
                // Fallback if card selector doesn't exist
                handleLanguageChange.call({value: lang});
            }
        }
        
        // Handle theme change
        function handleThemeChange(e) {
            const theme = this.value;
            console.log('Theme selected:', theme);
            
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Get the current language
            const currentLang = document.getElementById('active_language').value;
            
            // Update all theme selectors to match
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = theme;
                }
            });
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating theme...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data specifically for theme update
            const formData = new FormData();
            formData.append('switch_theme', 'true'); // Changed from switch_language to switch_theme
            formData.append('active_language', currentLang);
            formData.append('preview_theme', theme);
            formData.append('selected_theme', theme); // Add this to ensure the theme is properly saved
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Theme update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Theme updated successfully to:', theme);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                    
                    // Update theme preview buttons
                    updateThemeButtonStates(theme);
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating theme:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Theme update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up message textarea listeners
        function setupMessageTextareaListeners() {
            // Set up real-time message updates on typing
            const messageTextarea = document.getElementById('message');
            if (messageTextarea) {
                // Use input event for immediate feedback
                messageTextarea.addEventListener('input', debounce(function() {
                    const currentLang = document.getElementById('active_language').value;
                    console.log('Message updated for ' + currentLang + ':', this.value.substring(0, 20) + '...');
                    
                    // Create form data specifically for this update
                    const formData = new FormData();
                    formData.append('switch_language', 'true');
                    formData.append('active_language', document.getElementById('active_language').value);
                    formData.append('preview_theme', document.getElementById('selected-theme').value);
                    formData.append('csrfmiddlewaretoken', getCsrfToken());
                    
                    // Add the message content using the correct field name format
                    formData.append('message_' + currentLang.toLowerCase(), this.value);
                    
                    // Send the update request
                    fetch('{% url "message_cards:unified_card_management" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Message update failed: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Create a temporary element to parse the HTML response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract just the card preview content
                        const cardContent = tempDiv.querySelector('.card-inner');
                        if (cardContent) {
                            document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                            console.log('Message updated successfully in preview');
                            
                            // Make sure the dropdown has the correct value
                            const newDropdown = document.querySelector('.language-selector-dropdown');
                            if (newDropdown) {
                                newDropdown.value = currentLang;
                                setupLanguageDropdowns(); // Re-setup events for the new dropdown
                            }
                        } else {
                            console.error('Could not find card preview content in response');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating message in preview:', error);
                    });
                }, 300)); // 300ms debounce is good for typing
                
                // Auto-resize the textarea
                messageTextarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                
                // Initial height adjustment
                messageTextarea.style.height = 'auto';
                messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
            }
        }
        
        // Initialize responsive layout handling
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth < 1024; // lg breakpoint in Tailwind
            const previewSection = document.querySelector('.card-preview-section');
            const formSection = document.querySelector('.form-section:not(.card-preview-section)');
            
            if (previewSection && formSection) {
                if (isMobile) {
                    previewSection.parentNode.parentNode.classList.add('order-2');
                    formSection.parentNode.parentNode.classList.add('order-1');
                } else {
                    previewSection.parentNode.parentNode.classList.remove('order-2');
                    formSection.parentNode.parentNode.classList.remove('order-1');
                    previewSection.parentNode.parentNode.classList.add('order-1');
                    formSection.parentNode.parentNode.classList.add('order-2');
                }
            }
        }
        
        // Initial call
        handleResponsiveLayout();
        
        // Listen for resize events
        window.addEventListener('resize', debounce(function() {
            handleResponsiveLayout();
        }, 250));
        
        // Debounce helper function to limit how often a function runs
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Set theme from global theme buttons
        function setGlobalTheme(theme) {
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Update theme selector on card if it exists
            const cardThemeSelector = document.getElementById('theme-selector');
            if (cardThemeSelector) {
                cardThemeSelector.value = theme;
                // Trigger the card's theme change handler
                const event = new Event('change');
                cardThemeSelector.dispatchEvent(event);
            } else {
                // Fallback if card selector doesn't exist
                handleThemeChange.call({value: theme});
            }
            
            // Update theme button states
            updateThemeButtonStates(theme);
        }
        
        // Update theme preview button states
        function updateThemeButtonStates(activeTheme) {
            const themeButtons = document.querySelectorAll('.theme-button');
            themeButtons.forEach(button => {
                const themeName = button.getAttribute('onclick').match(/setGlobalTheme\('(.+?)'\)/)[1];
                if (themeName === activeTheme) {
                    button.classList.remove('border-transparent', 'hover:border-teal-700');
                    button.classList.add('border-teal-400');
                } else {
                    button.classList.remove('border-teal-400');
                    button.classList.add('border-transparent', 'hover:border-teal-700');
                }
            });
        }
        
        // Setup global selectors functionality
        function setupGlobalSelectors() {
            // Set save button action
            const saveButton = document.getElementById('save-card-button');
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    document.getElementById('save_card_input').value = 'true';
                    document.querySelector('form').submit();
                });
            }
            
            // Initialize hex copy buttons
            initializeHexCopyButtons();
            
            // Fix theme button previews with correct theme colors
            document.querySelectorAll('.theme-preview').forEach(preview => {
                const parent = preview.closest('.theme-button');
                if (!parent) return;
                
                const theme = parent.getAttribute('onclick').match(/setGlobalTheme\('(.+?)'\)/)[1];
                if (theme === 'celio') {
                    preview.style.backgroundColor = '#e2f5f0';
                    preview.querySelector('span').style.color = '#1a4237';
                } else if (theme === 'dark') {
                    preview.style.backgroundColor = '#1a1a1a';
                    preview.querySelector('span').style.color = 'white';
                } else if (theme === 'minimal') {
                    preview.style.backgroundColor = '#f5f5f5';
                    preview.querySelector('span').style.color = '#333333';
                }
            });
            
            // Initialize theme button states
            const currentTheme = document.getElementById('selected-theme').value || 'celio';
            updateThemeButtonStates(currentTheme);
        }
        
        // Hex copy functionality
        function initializeHexCopyButtons() {
            const hexCopyButtons = document.querySelectorAll('.hex-copy-btn');
            const notification = document.getElementById('copy-notification');
            const message = document.getElementById('copy-message');
            
            hexCopyButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent theme selection when clicking hex buttons
                    const hexCode = this.getAttribute('data-hex');
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(hexCode).then(() => {
                        // Show notification
                        message.textContent = `Hex code ${hexCode} copied to clipboard!`;
                        notification.classList.remove('hidden');
                        
                        // Hide notification after 2 seconds
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy hex code:', err);
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = hexCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            message.textContent = `Hex code ${hexCode} copied to clipboard!`;
                        } catch (fallbackErr) {
                            message.textContent = 'Failed to copy hex code';
                        }
                        document.body.removeChild(textArea);
                        notification.classList.remove('hidden');
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    });
                });
            });
        }
        
        // Toggle guide function for mobile-optimized collapsible section
        window.toggleGuide = function() {
            const content = document.getElementById('guide-content');
            const chevron = document.getElementById('guide-chevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        };
        
        // Call setupGlobalSelectors to initialize everything
        setupGlobalSelectors();
    });
</script>
{% endblock %}
