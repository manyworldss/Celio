{% extends 'base.html' %}
{% load static %}
{% load emergency_card_filters %}

{% block title %}{{ page_title }} - Celio{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/emergency_card_themes.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --spruce-950: #0a1613;
        --spruce-900: #0f211c;
        --spruce-800: #14322a;
        --spruce-700: #1a4237;
        --teal-600: #0d9488;
        --teal-500: #14b8a6;
        --teal-400: #2dd4bf;
        --teal-300: #5eead4;
        --teal-200: #99f6e4;
        --teal-100: #ccfbf1;
    }
    
    body {
        background-color: var(--spruce-950);
        color: white;
    }
    
    /* Responsive order */
    @media (max-width: 1024px) {
        .order-1 {
            order: 2;
        }
        
        .order-2 {
            order: 1;
        }
    }
    
    /* Section styling */
    .form-section {
        background-color: var(--spruce-800);
        background-color: rgba(20, 50, 42, 0.2);
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.75rem;
        border: 1px solid rgba(26, 66, 55, 0.5);
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        padding: 0;
        border-bottom: 1px solid rgba(26, 66, 55, 0.7);
        background-color: transparent;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header h2 {
        color: white;
        font-weight: 600;
    }
    
    /* Improved form controls */
    .form-group {
        margin-bottom: 2.25rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--teal-100);
        margin-bottom: 0.75rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        background-color: rgba(20, 50, 42, 0.2);
        color: white;
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
        color: rgba(94, 234, 212, 0.5);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--teal-400);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
    }
    
    .form-textarea {
        min-height: 8rem;
    }
    
    .form-hint {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--teal-300);
    }
    
    .error-text {
        color: #f87171;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Action buttons with improved styling */
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .action-button-primary {
        background-color: var(--teal-600);
        color: white;
        border: none;
    }
    
    .action-button-primary:hover {
        background-color: var(--teal-500);
    }
    
    .action-button-secondary {
        background-color: rgba(20, 50, 42, 0.4);
        color: white;
        border: 1px solid var(--spruce-700);
    }
    
    .action-button-secondary:hover {
        background-color: rgba(20, 50, 42, 0.6);
    }
    
    /* Intro panel */
    .intro-panel {
        background-color: rgba(20, 50, 42, 0.25);
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(26, 66, 55, 0.5);
        margin-bottom: 2rem;
        backdrop-filter: blur(8px);
    }
    
    .intro-panel h3 {
        color: white;
    }
    
    .intro-panel p {
        color: var(--teal-200);
    }
    
    .dismiss-intro {
        color: var(--teal-400);
    }
    
    .dismiss-intro:hover {
        color: var(--teal-300);
    }
    
    /* Language tabs */
    .language-tab {
        color: var(--teal-300);
        border-bottom-color: transparent;
    }
    
    .language-tab[aria-selected="true"] {
        color: white;
        border-bottom-color: var(--teal-400);
    }
    
    .language-tab:hover:not([aria-selected="true"]) {
        color: var(--teal-200);
    }
    
    /* Card preview style */
    #card-preview {
        background-color: var(--spruce-900);
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
    }
    
    /* Spruce gradient background */
    .spruce-gradient-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -10;
        background: var(--spruce-950);
        overflow: hidden;
    }
    
    .spruce-gradient-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.6;
        background: radial-gradient(ellipse at center, var(--spruce-900) 0%, transparent 70%);
    }
    
    .gradient-accent {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
    }
    
    .gradient-accent-1 {
        width: 60vw;
        height: 60vw;
        background: rgba(20, 184, 166, 0.15);
        top: -10%;
        right: -10%;
    }
    
    .gradient-accent-2 {
        width: 40vw;
        height: 40vw;
        background: rgba(45, 212, 191, 0.1);
        bottom: -10%;
        left: -10%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Spruce gradient background -->
<div class="spruce-gradient-bg">
    <div class="spruce-gradient-overlay"></div>
    <div class="gradient-accent gradient-accent-1"></div>
    <div class="gradient-accent gradient-accent-2"></div>
</div>

<div class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white">{{ page_title }}</h1>
            <p class="mt-1 text-sm text-teal-300">Create and customize your emergency medical card.</p>
            
            <!-- Action buttons -->
            <div class="mt-3 flex flex-wrap gap-3">
                <a href="{% url 'emergency_cards:fullscreen_card' %}" class="action-button action-button-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 4l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
                    </svg>
                    View Fullscreen
                </a>
            </div>
        </div>
        
        <form method="POST" enctype="multipart/form-data" id="card-form">
            {% csrf_token %}
            
            <!-- Hidden inputs to track active language and theme -->
            <input type="hidden" name="active_language" id="active_language" value="{{ current_lang }}">
            <input type="hidden" name="selected_theme" id="selected-theme" value="{{ preview_theme|default:card.theme|default:'pastel' }}">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Card Preview (Left Side) -->
                <div class="lg:col-span-5 xl:col-span-4 order-2 lg:order-1">
                    <div class="lg:sticky lg:top-6">
                        <!-- Card Preview Section -->
                        <div class="preview-section flex flex-col h-full">
                            <div class="section-header mb-4">
                                <h2 class="text-xl font-semibold text-white">Card Preview</h2>
                            </div>
                            
                            <!-- Card Preview Instructions -->
                            <div class="card-instructions bg-spruce-800 bg-opacity-30 p-3 rounded-lg mb-4">
                                <p class="text-teal-300 text-sm">Use the controls on the e-Card below to change language, theme, and update your information.</p>
                            </div>
                            </div>
                            
                            <!-- Card Preview Container -->
                            <div id="card-preview-container" class="relative overflow-auto flex-grow bg-white bg-opacity-5 rounded-lg p-4">
                                {% include "emergency_cards/partials/editable_card.html" with card=card preview_theme=preview_theme theme_choices=theme_choices language_choices=language_choices current_lang=current_lang %}
                            </div>
                        </div>
                        
                        <!-- Hidden theme input that will be updated by JavaScript -->
                        <input type="hidden" name="theme" id="selected-theme" value="{{ preview_theme|default:card.theme|default:'minimal' }}">
                    </div>
                </div>
                
                <!-- Form Panels (Right Side) -->
                <div class="lg:col-span-7 xl:col-span-8 order-1 lg:order-2">
                    <!-- Profile Picture -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                            <h2 class="text-lg font-medium text-white">Profile Picture</h2>
                        </div>
                        <div class="form-section-body">
                            <div class="form-group">
                                <h3 class="form-label mb-3">Do you want to add a profile picture? (Optional)</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        {% if card and card.profile_picture %}
                                            <div class="mb-6">
                                                <img src="{{ card.profile_picture.url }}" alt="Current Profile Picture" class="w-32 h-32 rounded-full object-cover border-2 border-deep-teal">
                                            </div>
                                        {% else %}
                                            <div class="mb-6 w-32 h-32 rounded-full bg-gray-100 flex items-center justify-center border border-gray-200">
                                                <svg class="h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                        {% endif %}
                                        
                                        <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                                            Upload or Replace Picture
                                        </label>
                                        <input type="file" name="{{ form.profile_picture.name }}" id="{{ form.profile_picture.id_for_label }}" accept="image/*" 
                                               class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-deep-teal file:text-white hover:file:bg-deep-teal-2">
                                        {% if form.profile_picture.errors %}
                                            <p class="error-text">{{ form.profile_picture.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <div>
                                            <label class="inline-flex items-center mb-3">
                                                <input type="checkbox" name="{{ form.show_profile_pic.name }}" 
                                                       {% if form.show_profile_pic.value %}checked{% endif %}
                                                       class="rounded border-teal-300 text-teal-500 focus:ring-teal-400 h-5 w-5">
                                                <span class="ml-3 text-base text-teal-500 font-medium">Show profile picture on my card</span>
                                            </label>
                                            {% if form.show_profile_pic.errors %}
                                                <p class="error-text">{{ form.show_profile_pic.errors.0 }}</p>
                                            {% endif %}
                                            <p class="text-sm text-teal-200">
                                                A profile picture can help medical personnel identify you in an emergency situation.
                                                Your picture will only appear if you check this option.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- E-Card Usage Instructions -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                            <h2 class="text-lg font-medium text-white">How to Use Your e-Card</h2>
                        </div>
                        <div class="form-section-body">
                            <div class="p-4 bg-teal-900 bg-opacity-20 rounded-lg border border-teal-800">
                                <h3 class="text-teal-300 font-medium mb-3">Using Your e-Card</h3>
                                <ul class="list-disc list-inside text-teal-200 space-y-2">
                                    <li>Edit your information directly on the e-Card by clicking on any field</li>
                                    <li>Change the theme using the theme selector on the card</li>
                                    <li>Switch languages using the language selector on the card</li>
                                    <li>All of your information is stored and will be available when you return</li>
                                    <li>Use the buttons at the top to download or share your card</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Translation Information (Kept as requested) -->
                    {% if is_translated %}
                    <div class="p-2 mb-4 bg-teal-50 text-teal-700 rounded border border-teal-200 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span>You're viewing content in {{ current_lang_display }}. Some content may be machine-translated.</span>
                    </div>
                    {% endif %}
                    
                    <!-- Information about Automatic Translation (Kept as requested) -->
                    <div class="mt-6 p-4 rounded-lg bg-teal-900 bg-opacity-30 border border-teal-800">
                        <h4 class="text-teal-300 font-medium mb-2 flex items-center">
                            <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            About Translations
                        </h4>
                        <p class="text-teal-200 text-sm">
                            Your e-card comes with professional translations in multiple languages. When you switch languages, 
                            all the medical information will be translated to ensure accuracy and clarity in emergency situations.
                        </p>
                    </div>
                    
                            </div>
                        </div>
                    </div>
                    

                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent form submission which causes page refresh
        const cardForm = document.getElementById('card-form');
        cardForm.addEventListener('submit', function(e) {
            const isSubmitButton = e.submitter && e.submitter.type === 'submit' && e.submitter.classList.contains('action-button-primary');
            if (!isSubmitButton) {
                e.preventDefault(); // Only let the form submit when using the save button
            }
        });
        
        // Store the current scroll position
        function saveScrollPosition() {
            window.sessionStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        }
        
        // Restore the scroll position
        function restoreScrollPosition() {
            const savedPosition = window.sessionStorage.getItem('scrollPosition');
            if (savedPosition) {
                window.scrollTo(0, savedPosition);
            }
        }
        
        // Get CSRF token from cookie
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            if (!cookieValue) {
                console.error('CSRF token not found in cookies');
            }
            
            return cookieValue;
        }
        
        // Function to update the card preview with HTMX
        function updateCardPreview() {
            const currentLang = document.getElementById('active_language').value;
            const selectedTheme = document.getElementById('theme-selector').value;
            const messageTextarea = document.getElementById('message');
            
            console.log('Updating preview with theme:', selectedTheme, 'and language:', currentLang);
            
            // Create form data for the update
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', currentLang);
            formData.append('preview_theme', selectedTheme);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message 
            if (messageTextarea) {
                formData.append('message_' + currentLang.toLowerCase(), messageTextarea.value);
            }
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating preview...</div></div>';
            }
            
            // Send the update request
            fetch('{% url "emergency_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with theme:', selectedTheme);
                    
                    // Update the hidden theme input
                    document.getElementById('selected-theme').value = selectedTheme;
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up language selector handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup for all dropdowns that might be in the DOM
            setupLanguageDropdowns();
            setupThemeDropdowns();
            
            // Set up live preview updates for message changes
            setupMessageTextareaListeners();
            
            // Apply initial translations based on the current language
            let currentLang = document.getElementById('active_language').value;
            // Ensure language code is lowercase
            currentLang = currentLang.toLowerCase();
            document.getElementById('active_language').value = currentLang;
            console.log('Initial language (lowercase):', currentLang);
            translateUIElements(currentLang);
        });
        
        // Function to set up all language dropdowns in the DOM
        function setupLanguageDropdowns() {
            const dropdowns = document.querySelectorAll('.language-selector-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', handleLanguageChange);
            });
        }
        
        // Function to set up all theme dropdowns
        function setupThemeDropdowns() {
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                selector.addEventListener('change', handleThemeChange);
            });
        }
        
        // Translation dictionary for UI elements
        const translations = {
            'en': {
                'Medical Information': 'Medical Information',
                'Message': 'Message',
                'Emergency Contact': 'Emergency Contact',
                'No emergency contact listed.': 'No emergency contact listed.',
                'No message available.': 'No message available.',
                'Autoimmune disorder triggered by gluten': 'Autoimmune disorder triggered by gluten',
                'Can cause severe intestinal damage': 'Can cause severe intestinal damage',
                'Requires strict gluten-free diet': 'Requires strict gluten-free diet',
                'Non-celiac gluten sensitivity': 'Non-celiac gluten sensitivity',
                'Causes discomfort but not intestinal damage': 'Causes discomfort but not intestinal damage',
                'Requires gluten-free diet for symptom control': 'Requires gluten-free diet for symptom control',
                'Immune system reaction to wheat proteins': 'Immune system reaction to wheat proteins',
                'Can cause immediate allergy symptoms': 'Can cause immediate allergy symptoms',
                'May require emergency treatment if severe': 'May require emergency treatment if severe',
                'Requires avoidance of gluten-containing foods': 'Requires avoidance of gluten-containing foods',
                'Needs careful meal preparation': 'Needs careful meal preparation',
                'Profile Picture': 'Profile Picture'
            },
            'es': {
                'Medical Information': 'Información Médica',
                'Message': 'Mensaje',
                'Emergency Contact': 'Contacto de Emergencia',
                'No emergency contact listed.': 'No hay contacto de emergencia registrado.',
                'No message available.': 'No hay mensaje disponible.',
                'Autoimmune disorder triggered by gluten': 'Trastorno autoinmune desencadenado por el gluten',
                'Can cause severe intestinal damage': 'Puede causar daño intestinal severo',
                'Requires strict gluten-free diet': 'Requiere dieta estricta sin gluten',
                'Non-celiac gluten sensitivity': 'Sensibilidad al gluten no celíaca',
                'Causes discomfort but not intestinal damage': 'Causa malestar pero no daño intestinal',
                'Requires gluten-free diet for symptom control': 'Requiere dieta sin gluten para controlar los síntomas',
                'Immune system reaction to wheat proteins': 'Reacción del sistema inmunológico a las proteínas del trigo',
                'Can cause immediate allergy symptoms': 'Puede causar síntomas alérgicos inmediatos',
                'May require emergency treatment if severe': 'Puede requerir tratamiento de emergencia si es grave',
                'Requires avoidance of gluten-containing foods': 'Requiere evitar alimentos con gluten',
                'Needs careful meal preparation': 'Necesita preparación cuidadosa de comidas',
                'Profile Picture': 'Foto de Perfil'
            },
            'fr': {
                'Medical Information': 'Informations Médicales',
                'Message': 'Message',
                'Emergency Contact': 'Contact d\'Urgence',
                'No emergency contact listed.': 'Aucun contact d\'urgence indiqué.',
                'No message available.': 'Aucun message disponible.',
                'Autoimmune disorder triggered by gluten': 'Trouble auto-immun déclenché par le gluten',
                'Can cause severe intestinal damage': 'Peut causer de graves lésions intestinales',
                'Requires strict gluten-free diet': 'Nécessite un régime strict sans gluten',
                'Non-celiac gluten sensitivity': 'Sensibilité au gluten non cœliaque',
                'Causes discomfort but not intestinal damage': 'Provoque de l\'inconfort mais pas de lésions intestinales',
                'Requires gluten-free diet for symptom control': 'Nécessite un régime sans gluten pour contrôler les symptômes',
                'Immune system reaction to wheat proteins': 'Réaction du système immunitaire aux protéines de blé',
                'Can cause immediate allergy symptoms': 'Peut provoquer des symptômes allergiques immédiats',
                'May require emergency treatment if severe': 'Peut nécessiter un traitement d\'urgence si grave',
                'Requires avoidance of gluten-containing foods': 'Exige d\'éviter les aliments contenant du gluten',
                'Needs careful meal preparation': 'Nécessite une préparation soignée des repas',
                'Profile Picture': 'Photo de Profil'
            },
            'de': {
                'Medical Information': 'Medizinische Informationen',
                'Message': 'Nachricht',
                'Emergency Contact': 'Notfallkontakt',
                'No emergency contact listed.': 'Kein Notfallkontakt angegeben.',
                'No message available.': 'Keine Nachricht verfügbar.',
                'Autoimmune disorder triggered by gluten': 'Durch Gluten ausgelöste Autoimmunerkrankung',
                'Can cause severe intestinal damage': 'Kann schwere Darmschäden verursachen',
                'Requires strict gluten-free diet': 'Erfordert strenge glutenfreie Diät',
                'Non-celiac gluten sensitivity': 'Nicht-Zöliakie-Glutensensitivität',
                'Causes discomfort but not intestinal damage': 'Verursacht Beschwerden, aber keine Darmschäden',
                'Requires gluten-free diet for symptom control': 'Erfordert glutenfreie Diät zur Symptomkontrolle',
                'Immune system reaction to wheat proteins': 'Immunsystemreaktion auf Weizenproteine',
                'Can cause immediate allergy symptoms': 'Kann sofortige allergische Symptome verursachen',
                'May require emergency treatment if severe': 'Kann bei schweren Fällen eine Notfallbehandlung erfordern',
                'Requires avoidance of gluten-containing foods': 'Erfordert die Vermeidung glutenhaltiger Lebensmittel',
                'Needs careful meal preparation': 'Erfordert sorgfältige Mahlzeitenzubereitung',
                'Profile Picture': 'Profilbild'
            }
        };
        
        // Function to translate UI elements based on selected language
        function translateUIElements(langCode) {
            // If translations for this language don't exist, use English as fallback
            const langDict = translations[langCode.toLowerCase()] || translations['en'];
            console.log('Translating UI elements to', langCode, 'with dictionary:', langDict);
            
            // Find all elements with data-i18n attribute and translate them
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langDict[key]) {
                    element.textContent = langDict[key];
                }
            });
            
            console.log('UI elements translated to', langCode);
        }
        
        // Handle language change from dropdown
        function handleLanguageChange(e) {
            // Ensure language is lowercase
            const lang = this.value.toLowerCase();
            const prevLang = document.getElementById('active_language').value.toLowerCase();
            console.log('Language selected:', lang, 'Previous language:', prevLang);
            
            // Don't do anything if the language hasn't changed
            if (lang === prevLang) {
                return;
            }
            
            // For debugging
            console.log('Switching language from', prevLang, 'to', lang);
            
            // Update hidden input
            document.getElementById('active_language').value = lang;
            
            // Update all language selectors to match
            const langSelectors = document.querySelectorAll('.language-selector-dropdown');
            langSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = lang;
                }
            });
            
            // Update language display
            const displayElement = document.getElementById('current-language-display');
            if (displayElement) {
                displayElement.textContent = this.options[this.selectedIndex].text;
            }
                
            // Apply translations immediately for better UX
            translateUIElements(lang);
            
            // Show loading indicator in the card preview
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Translating...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data for language switch
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', lang);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "emergency_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Language switch failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                console.log('Received language switch response');
                
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with language:', lang);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Update the language tabs if they exist
                const languageTabs = document.querySelectorAll('.language-tab');
                if (languageTabs.length > 0) {
                    languageTabs.forEach(tab => {
                        const tabLang = tab.getAttribute('data-lang');
                        if (tabLang === lang) {
                            tab.setAttribute('aria-selected', 'true');
                            tab.classList.add('active-language');
                        } else {
                            tab.setAttribute('aria-selected', 'false');
                            tab.classList.remove('active-language');
                        }
                    });
                }
                
                // Restore scroll position
                window.scrollTo(0, scrollPosition);
            })
            .catch(error => {
                console.error('Error switching language:', error);
                // Restore original content if there was an error
                alert('There was an error switching languages. Please try again.');
            });
            
            // Store the language preference in localStorage for persistence
            localStorage.setItem('preferred_language', lang);
        }
        
        // Handle theme change
        function handleThemeChange(e) {
            const theme = this.value;
            console.log('Theme selected:', theme);
            
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Get the current language
            const currentLang = document.getElementById('active_language').value;
            
            // Update all theme selectors to match
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = theme;
                }
            });
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating theme...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data specifically for theme update
            const formData = new FormData();
            formData.append('switch_theme', 'true'); // Changed from switch_language to switch_theme
            formData.append('active_language', currentLang);
            formData.append('preview_theme', theme);
            formData.append('selected_theme', theme); // Add this to ensure the theme is properly saved
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "emergency_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Theme update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Theme updated successfully to:', theme);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating theme:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Theme update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up message textarea listeners
        function setupMessageTextareaListeners() {
            // Set up real-time message updates on typing
            const messageTextarea = document.getElementById('message');
            if (messageTextarea) {
                // Use input event for immediate feedback
                messageTextarea.addEventListener('input', debounce(function() {
                    const currentLang = document.getElementById('active_language').value;
                    console.log('Message updated for ' + currentLang + ':', this.value.substring(0, 20) + '...');
                    
                    // Create form data specifically for this update
                    const formData = new FormData();
                    formData.append('switch_language', 'true');
                    formData.append('active_language', document.getElementById('active_language').value);
                    formData.append('preview_theme', document.getElementById('selected-theme').value);
                    formData.append('csrfmiddlewaretoken', getCsrfToken());
                    
                    // Add the message content using the correct field name format
                    formData.append('message_' + currentLang.toLowerCase(), this.value);
                    
                    // Send the update request
                    fetch('{% url "emergency_cards:unified_card_management" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Message update failed: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Create a temporary element to parse the HTML response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract just the card preview content
                        const cardContent = tempDiv.querySelector('.card-inner');
                        if (cardContent) {
                            document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                            console.log('Message updated successfully in preview');
                            
                            // Make sure the dropdown has the correct value
                            const newDropdown = document.querySelector('.language-selector-dropdown');
                            if (newDropdown) {
                                newDropdown.value = currentLang;
                                setupLanguageDropdowns(); // Re-setup events for the new dropdown
                            }
                        } else {
                            console.error('Could not find card preview content in response');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating message in preview:', error);
                    });
                }, 300)); // 300ms debounce is good for typing
                
                // Auto-resize the textarea
                messageTextarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                
                // Initial height adjustment
                messageTextarea.style.height = 'auto';
                messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
            }
        }
        
        // Initialize responsive layout handling
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth < 1024; // lg breakpoint in Tailwind
            const previewSection = document.querySelector('.card-preview-section');
            const formSection = document.querySelector('.form-section:not(.card-preview-section)');
            
            if (previewSection && formSection) {
                if (isMobile) {
                    previewSection.parentNode.parentNode.classList.add('order-2');
                    formSection.parentNode.parentNode.classList.add('order-1');
                } else {
                    previewSection.parentNode.parentNode.classList.remove('order-2');
                    formSection.parentNode.parentNode.classList.remove('order-1');
                    previewSection.parentNode.parentNode.classList.add('order-1');
                    formSection.parentNode.parentNode.classList.add('order-2');
                }
            }
        }
        
        // Initial call
        handleResponsiveLayout();
        
        // Listen for resize events
        window.addEventListener('resize', debounce(function() {
            handleResponsiveLayout();
        }, 250));
        
        // Debounce helper function to limit how often a function runs
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }
    });
</script>
{% endblock %}
