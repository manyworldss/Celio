{% extends 'base.html' %}
{% load static %}
{% load message_card_filters %}

{% block title %}{{ page_title }} - Celio{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/emergency_card_themes.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block extra_css %}
    <style>
        /* Removed inline CSS variables and body styles to avoid conflicts with external CSS */
    
    /* Enhanced Mobile Responsiveness */
    @media (max-width: 1024px) {
        .order-1 {
            order: 2;
        }
        
        .order-2 {
            order: 1;
        }
    }
    
    /* Mobile-first improvements */
    @media (max-width: 640px) {
        .primary-gradient-bg {
            background-attachment: scroll;
        }
        
        /* Improve card visibility on mobile */
        .editable-card {
            max-width: 100%;
            margin: 0 auto;
        }
        
        /* Better spacing for mobile */
        .form-section {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Optimize text sizes for mobile */
        h1 {
            line-height: 1.2;
        }
        
        /* Improve button accessibility on mobile */
        button, .btn {
            min-height: 44px;
            padding: 0.75rem 1rem;
        }
    }
    
    /* Tablet optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
        .max-w-4xl {
            max-width: 90%;
        }
    }
    
    /* Section styling */
    .form-section {
        background-color: rgba(20, 50, 42, 0.3);
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        padding: 1.75rem;
        border: 1px solid rgba(150, 150, 150, 0.7);
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        padding: 0;
        border-bottom: 1px solid rgba(26, 66, 55, 0.7);
        background-color: transparent;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header h2 {
        color: white;
        font-weight: 600;
    }
    
    /* Improved form controls */
    .form-group {
        margin-bottom: 2.25rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        color: white;
        margin-bottom: 0.75rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        background-color: rgba(20, 50, 42, 0.2);
        color: white;
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--teal-400);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
    }
    
    .form-textarea {
        min-height: 8rem;
    }
    
    .form-hint {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--teal-200);
    }
    
    .error-text {
        color: #f87171;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Action buttons with improved styling */
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .action-button-primary {
        background-color: var(--teal-600);
        color: white;
        border: none;
    }
    
    .action-button-primary:hover {
        background-color: var(--teal-500);
    }
    
    .action-button-secondary {
        background-color: rgba(20, 50, 42, 0.4);
        color: white;
        border: 1px solid var(--spruce-700);
    }

    .action-button-secondary:hover {
        background-color: rgba(20, 50, 42, 0.6);
    }
    
    /* Intro panel */
    .intro-panel {
        background-color: rgba(20, 50, 42, 0.25);
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(200, 200, 200, 0.5);
        margin-bottom: 2rem;
        backdrop-filter: blur(8px);
    }
    
    .intro-panel h3 {
        color: white;
    }
    
    .intro-panel p {
        color: var(--teal-200);
    }
    
    .dismiss-intro {
        color: var(--teal-400);
    }
    
    .dismiss-intro:hover {
        color: var(--teal-300);
    }
    
    /* Language tabs */
    .language-tab {
        color: var(--teal-300);
        border-bottom-color: transparent;
    }
    
    .language-tab[aria-selected="true"] {
        color: white;
        border-bottom-color: var(--teal-400);
    }
    
    .language-tab:hover:not([aria-selected="true"]) {
        color: var(--teal-200);
    }
    
    /* Card preview style */
    #card-preview {
        background-color: var(--primary-900);
        border: 1px solid var(--primary-700);
        border-radius: 0.5rem;
    }
    
    /* Travel-themed gradient background */
    .primary-gradient-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -10;
        background: var(--spruce-950);
        overflow: hidden;
    }
    
    .primary-gradient-overlay {
        display: none;
    }
    
    .gradient-accent {
        display: none;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-15px) rotate(90deg); }
    }
    
    @media (max-width: 768px) {
        .gradient-accent {
            animation: floatMobile 8s ease-in-out infinite;
        }
        
        @keyframes floatMobile {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(45deg); }
        }
    }
    
    .gradient-accent-1 {
        width: 50vw;
        height: 50vw;
        background: radial-gradient(circle, rgba(34, 197, 94, 0.25) 0%, rgba(16, 185, 129, 0.15) 50%, transparent 70%);
        top: -15%;
        right: -15%;
        animation-delay: -2s;
    }
    
    .gradient-accent-2 {
        width: 35vw;
        height: 35vw;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(34, 197, 94, 0.12) 50%, transparent 70%);
        bottom: -15%;
        left: -15%;
        animation-delay: -4s;
    }
    
    /* Star emoji animations */
    .star-emoji {
        display: inline-block;
        animation: starTwinkle 2s ease-in-out infinite;
    }
    
    @keyframes starTwinkle {
        0%, 100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
        25% {
            transform: scale(1.2) rotate(5deg);
            opacity: 0.8;
        }
        50% {
            transform: scale(1.1) rotate(-5deg);
            opacity: 1;
        }
        75% {
            transform: scale(1.3) rotate(3deg);
            opacity: 0.9;
        }
    }
    
    /* Stagger the animation for the second star */
    .star-emoji:last-child {
        animation-delay: 1s;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Banner Section -->
<div class="bg-gradient-to-br from-slate-700 via-slate-800 to-slate-900 relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 via-transparent to-purple-900/20"></div>
    <div class="max-w-4xl mx-auto px-6 py-12 relative text-center">
        <div class="mb-6">
            <div class="flex items-center justify-center mb-4">
                <span class="star-emoji text-3xl mr-3">ğŸŒŸ</span>
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white">Celio E-Card! Try it yourself!</h1>
                <span class="star-emoji text-3xl ml-3">ğŸŒŸ</span>
            </div>
            <p class="text-lg sm:text-xl text-gray-300 mb-8">Create your personalized medical card in minutes</p>
        </div>
        
        <div class="flex flex-wrap items-center justify-center gap-8 text-gray-300">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium">Quick Setup</span>
            </div>
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium">Multi-Language</span>
            </div>
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium">Always Secure</span>
            </div>
        </div>
        
        <p class="text-gray-400 mt-8 text-sm max-w-2xl mx-auto">Perfect for travelers, people with allergies, and anyone who wants to communicate their medical needs clearly</p>
    </div>
</div>

<!-- Primary gradient background -->
<div class="primary-gradient-bg">
        <div class="primary-gradient-overlay"></div>
    <div class="gradient-accent gradient-accent-1"></div>
    <div class="gradient-accent gradient-accent-2"></div>
</div>

<div class="min-h-screen py-4 sm:py-6 lg:py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header - Mobile Optimized -->
        <div class="mb-6 sm:mb-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-2 sm:mb-4 tracking-tight">{{ page_title }}</h1>
                <p class="text-sm sm:text-base lg:text-lg text-teal-300 px-4">Create your personalized e-card for safe travel and dining</p>
            </div>
            
            <!-- Interactive E-Card Section -->
            <div class="mb-6">
                <!-- Card Container with Mobile-First Design -->
                <div class="flex justify-center px-4">
                    <div class="w-full max-w-sm sm:max-w-md">
                        {% include "emergency_cards/partials/editable_card.html" with card=card preview_theme=preview_theme language_choices=language_choices current_lang=current_lang is_preview=True %}
                    </div>
                </div>
                
                <!-- Quick Action Hint -->
                <div class="text-center mt-4">
                    <p class="text-xs sm:text-sm text-teal-400 flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.122 2.122"></path>
                        </svg>
                        <span>Tap any field above to start editing</span>
                    </p>
                </div>
            </div>
                
                <!-- Quick Guide - Mobile Optimized -->
                <div class="max-w-4xl mx-auto mb-8">
                    <!-- Collapsible Guide Section -->
                    <div class="bg-gradient-to-br from-spruce-700/50 to-spruce-800/30 rounded-xl border border-spruce-600/30 backdrop-blur-sm overflow-hidden">
                        <button type="button" 
                                onclick="toggleGuide()" 
                                class="w-full p-4 sm:p-6 flex items-center justify-between text-left hover:bg-spruce-700/30 transition-all duration-300">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg sm:text-xl font-semibold text-white">How to Use Your E-Card</h3>
                                    <p class="text-sm text-purple-300 mt-1">Quick setup guide â€¢ Tap to expand</p>
                                </div>
                            </div>
                            <svg id="guide-chevron" class="w-5 h-5 text-purple-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div id="guide-content" class="hidden border-t border-spruce-600/50">
                            <div class="p-4 sm:p-6">
                                <!-- Mobile-First Step Cards -->
                                <div class="space-y-4">
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            1
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Edit Your Information</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Tap any field on the card above to customize your medical details</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            2
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Choose Language & Theme</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Select your preferred language and visual style</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start space-x-3 p-3 sm:p-4 bg-spruce-700/30 rounded-lg border border-spruce-600/30">
                                        <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                            3
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="text-white font-medium text-sm sm:text-base">Save & Use</h4>
                                            <p class="text-purple-200 text-xs sm:text-sm mt-1">Save your card and show it to restaurants, medical staff, or anyone who needs to understand your dietary restrictions</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Benefits -->
                                <div class="mt-6 pt-4 border-t border-spruce-600/30">
                                    <h4 class="text-white font-medium text-sm mb-3">Why Use an E-Card?</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs sm:text-sm">
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Clear communication in any language</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Always accessible on your phone</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Professional medical format</span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-purple-200">
                                            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Perfect for travel & dining</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>

        
        <form method="POST" enctype="multipart/form-data" id="card-form" hx-post="{% url 'message_cards:unified_card_management' %}" hx-swap="none" hx-trigger="none">
            {% csrf_token %}
            
            <!-- Hidden inputs to track active language and theme -->
            <input type="hidden" name="active_language" id="active_language" value="{{ current_lang }}">
            {% with current_theme=preview_theme %}
                {% if not current_theme and card and card.theme %}
                    {% with current_theme=card.theme %}
                        <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                    {% endwith %}
                {% elif not current_theme %}
                    {% with current_theme='light' %}
                        <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                    {% endwith %}
                {% else %}
                    <input type="hidden" name="selected_theme" id="selected-theme" value="{{ current_theme }}">
                {% endif %}
            {% endwith %}
            <input type="hidden" name="save_card" id="save_card_input" value="false">
            

                </div> <!-- End of hidden sections -->

                <!-- Card Container (Full Screen) -->
                <div class="card-fullscreen-container max-w-4xl mx-auto">
                    
                    <!-- Card Preview Container (full-width) -->
                    <div id="card-preview-container" class="relative overflow-hidden bg-white bg-opacity-5 rounded-lg p-4 flex justify-center items-center">
                        <!-- This container will be populated by the editable card when editing -->
                    </div>
                    
                    <!-- Hidden theme input that will be updated by JavaScript -->
                    {% with current_theme=preview_theme %}
                        {% if not current_theme and card and card.theme %}
                            {% with current_theme=card.theme %}
                                <input type="hidden" name="theme" id="selected-theme" value="{{ current_theme }}">
                            {% endwith %}
                        {% elif not current_theme %}
                            {% with current_theme='light' %}
                                <input type="hidden" name="theme" id="selected-theme" value="{{ current_theme }}">
                            {% endwith %}
                        {% else %}
                            <input type="hidden" name="theme" id="selected-theme" value="{{ current_theme }}">
                        {% endif %}
                    {% endwith %}
                </div>

                <!-- Hidden sections that were previously visible -->
                <div class="hidden">
                    <!-- Hidden file input to maintain form functionality -->
                    <input type="file" name="{{ form.profile_picture.name }}" id="{{ form.profile_picture.id_for_label }}" hidden>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Removed fetch-based preview update JS for language and theme switching; now handled by HTMX.

    document.addEventListener('DOMContentLoaded', function() {
        // Prevent form submission which causes page refresh
        const cardForm = document.getElementById('card-form');
        cardForm.addEventListener('submit', function(e) {
            const isSubmitButton = e.submitter && e.submitter.type === 'submit' && e.submitter.classList.contains('action-button-primary');
            if (!isSubmitButton) {
                e.preventDefault(); // Only let the form submit when using the save button
            }
        });
        
        // Store the current scroll position
        function saveScrollPosition() {
            window.sessionStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        }
        
        // Restore the scroll position
        function restoreScrollPosition() {
            const savedPosition = window.sessionStorage.getItem('scrollPosition');
            if (savedPosition) {
                window.scrollTo(0, savedPosition);
            }
        }
        
        // Get CSRF token from cookie
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            if (!cookieValue) {
                console.error('CSRF token not found in cookies');
            }
            
            return cookieValue;
        }
        
        // Function to update the card preview with HTMX
        function updateCardPreview() {
            const currentLang = document.getElementById('active_language').value;
            const selectedTheme = document.getElementById('theme-selector').value;
            const messageTextarea = document.getElementById('message');
            
            console.log('Updating preview with theme:', selectedTheme, 'and language:', currentLang);
            
            // Create form data for the update
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', currentLang);
            formData.append('preview_theme', selectedTheme);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message 
            if (messageTextarea) {
                formData.append('message_' + currentLang.toLowerCase(), messageTextarea.value);
            }
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating preview...</div></div>';
            }
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with theme:', selectedTheme);
                    
                    // Update the hidden theme input
                    document.getElementById('selected-theme').value = selectedTheme;
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up language selector handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup for all dropdowns that might be in the DOM
            setupLanguageDropdowns();
            setupThemeDropdowns();
            
            // Set up live preview updates for message changes
            setupMessageTextareaListeners();
            
            // Set up save button handler
            const saveButton = document.getElementById('save-card-button');
            if (saveButton) {
                saveButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('card-form');
                    if (!form) return;
                    
                    // Create a hidden input for save_card if it doesn't exist
                    let saveCardInput = document.getElementById('save_card_input');
                    if (!saveCardInput) {
                        saveCardInput = document.createElement('input');
                        saveCardInput.type = 'hidden';
                        saveCardInput.name = 'save_card';
                        saveCardInput.id = 'save_card_input';
                        form.appendChild(saveCardInput);
                    }
                    saveCardInput.value = 'true';
                    
                    // Show saving indicator
                    const saveText = document.querySelector('.save-text');
                    const originalText = saveText.textContent;
                    saveText.textContent = 'Saving...';
                    document.querySelector('.autosave-status').textContent = 'Saving your E-Card...';
                    
                    // Submit the form
                    form.submit();
                });
            }
            
            // Set up theme dropdowns
            setupThemeDropdowns();
            
            // Apply initial translations based on the current language
            let currentLang = document.getElementById('active_language').value;
            // Ensure language code is lowercase
            currentLang = currentLang.toLowerCase();
            document.getElementById('active_language').value = currentLang;
            console.log('Initial language (lowercase):', currentLang);
            translateUIElements(currentLang);
        });
        
        // Function to set up all language dropdowns in the DOM
        function setupLanguageDropdowns() {
            const dropdowns = document.querySelectorAll('.language-selector-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', handleLanguageChange);
            });
        }
        
        // Function to set up all theme dropdowns
        function setupThemeDropdowns() {
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                selector.addEventListener('change', handleThemeChange);
            });
        }
        
        // Translation dictionary for UI elements
        const translations = {
            'en': {
                'Medical Information': 'Dietary Information',
                'Message': 'Message',
                'Contact': 'Contact',
                'No contact listed.': 'No contact listed.',
                'No message available.': 'No message available.',
                'Autoimmune disorder triggered by gluten': 'Autoimmune disorder triggered by gluten',
                'Can cause severe intestinal damage': 'Can cause severe intestinal damage',
                'Requires strict gluten-free diet': 'Requires strict gluten-free diet',
                'Non-celiac gluten sensitivity': 'Non-celiac gluten sensitivity',
                'Causes discomfort but not intestinal damage': 'Causes discomfort but not intestinal damage',
                'Requires gluten-free diet for symptom control': 'Requires gluten-free diet for symptom control',
                'Immune system reaction to wheat proteins': 'Immune system reaction to wheat proteins',
                'Can cause immediate allergy symptoms': 'Can cause immediate allergy symptoms',
                'May require assistance if severe': 'May require assistance if severe',
                'Requires avoidance of gluten-containing foods': 'Requires avoidance of gluten-containing foods',
                'Needs careful meal preparation': 'Needs careful meal preparation',
                'Profile Picture': 'Profile Picture'
            },
            'es': {
                'Medical Information': 'InformaciÃ³n DietÃ©tica',
                'Message': 'Mensaje',
                'Contact': 'Contacto',
                'No contact listed.': 'No hay contacto registrado.',
                'No message available.': 'No hay mensaje disponible.',
                'Autoimmune disorder triggered by gluten': 'Trastorno autoinmune desencadenado por el gluten',
                'Can cause severe intestinal damage': 'Puede causar daÃ±o intestinal severo',
                'Requires strict gluten-free diet': 'Requiere dieta estricta sin gluten',
                'Non-celiac gluten sensitivity': 'Sensibilidad al gluten no celÃ­aca',
                'Causes discomfort but not intestinal damage': 'Causa malestar pero no daÃ±o intestinal',
                'Requires gluten-free diet for symptom control': 'Requiere dieta sin gluten para controlar los sÃ­ntomas',
                'Immune system reaction to wheat proteins': 'ReacciÃ³n del sistema inmunolÃ³gico a las proteÃ­nas del trigo',
                'Can cause immediate allergy symptoms': 'Puede causar sÃ­ntomas alÃ©rgicos inmediatos',
                'May require assistance if severe': 'Puede requerir asistencia si es grave',
                'Requires avoidance of gluten-containing foods': 'Requiere evitar alimentos con gluten',
                'Needs careful meal preparation': 'Necesita preparaciÃ³n cuidadosa de comidas',
                'Profile Picture': 'Foto de Perfil'
            },
            'fr': {
                'Medical Information': 'Informations DiÃ©tÃ©tiques',
                'Message': 'Message',
                'Contact': 'Contact',
                'No contact listed.': 'Aucun contact indiquÃ©.',
                'No message available.': 'Aucun message disponible.',
                'Autoimmune disorder triggered by gluten': 'Trouble auto-immun dÃ©clenchÃ© par le gluten',
                'Can cause severe intestinal damage': 'Peut causer de graves lÃ©sions intestinales',
                'Requires strict gluten-free diet': 'NÃ©cessite un rÃ©gime strict sans gluten',
                'Non-celiac gluten sensitivity': 'SensibilitÃ© au gluten non cÅ“liaque',
                'Causes discomfort but not intestinal damage': 'Provoque de l\'inconfort mais pas de lÃ©sions intestinales',
                'Requires gluten-free diet for symptom control': 'NÃ©cessite un rÃ©gime sans gluten pour contrÃ´ler les symptÃ´mes',
                'Immune system reaction to wheat proteins': 'RÃ©action du systÃ¨me immunitaire aux protÃ©ines de blÃ©',
                'Can cause immediate allergy symptoms': 'Peut provoquer des symptÃ´mes allergiques immÃ©diats',
                'May require assistance if severe': 'Peut nÃ©cessiter une assistance si grave',
                'Requires avoidance of gluten-containing foods': 'Exige d\'Ã©viter les aliments contenant du gluten',
                'Needs careful meal preparation': 'NÃ©cessite une prÃ©paration soignÃ©e des repas',
                'Profile Picture': 'Photo de Profil'
            },
            'de': {
                'Medical Information': 'DiÃ¤tetische Informationen',
                'Message': 'Nachricht',
                'Contact': 'Kontakt',
                'No contact listed.': 'Kein Kontakt angegeben.',
                'No message available.': 'Keine Nachricht verfÃ¼gbar.',
                'Autoimmune disorder triggered by gluten': 'Durch Gluten ausgelÃ¶ste Autoimmunerkrankung',
                'Can cause severe intestinal damage': 'Kann schwere DarmschÃ¤den verursachen',
                'Requires strict gluten-free diet': 'Erfordert strenge glutenfreie DiÃ¤t',
                'Non-celiac gluten sensitivity': 'Nicht-ZÃ¶liakie-GlutensensitivitÃ¤t',
                'Causes discomfort but not intestinal damage': 'Verursacht Beschwerden, aber keine DarmschÃ¤den',
                'Requires gluten-free diet for symptom control': 'Erfordert glutenfreie DiÃ¤t zur Symptomkontrolle',
                'Immune system reaction to wheat proteins': 'Immunsystemreaktion auf Weizenproteine',
                'Can cause immediate allergy symptoms': 'Kann sofortige allergische Symptome verursachen',
                'May require assistance if severe': 'Kann bei schweren FÃ¤llen Hilfe erfordern',
                'Requires avoidance of gluten-containing foods': 'Erfordert die Vermeidung glutenhaltiger Lebensmittel',
                'Needs careful meal preparation': 'Erfordert sorgfÃ¤ltige Mahlzeitenzubereitung',
                'Profile Picture': 'Profilbild'
            },
            'it': {
                'Medical Information': 'Informazioni Dietetiche',
                'Message': 'Messaggio',
                'Contact': 'Contatto',
                'No contact listed.': 'Nessun contatto elencato.',
                'No message available.': 'Nessun messaggio disponibile.',
                'Autoimmune disorder triggered by gluten': 'Disturbo autoimmune scatenato dal glutine',
                'Can cause severe intestinal damage': 'PuÃ² causare gravi danni intestinali',
                'Requires strict gluten-free diet': 'Richiede dieta rigorosamente senza glutine',
                'Non-celiac gluten sensitivity': 'SensibilitÃ  al glutine non celiaca',
                'Causes discomfort but not intestinal damage': 'Causa disagio ma non danni intestinali',
                'Requires gluten-free diet for symptom control': 'Richiede dieta senza glutine per il controllo dei sintomi',
                'Immune system reaction to wheat proteins': 'Reazione del sistema immunitario alle proteine del grano',
                'Can cause immediate allergy symptoms': 'PuÃ² causare sintomi allergici immediati',
                'May require assistance if severe': 'PuÃ² richiedere assistenza se grave',
                'Requires avoidance of gluten-containing foods': 'Richiede di evitare cibi contenenti glutine',
                'Needs careful meal preparation': 'Richiede preparazione attenta dei pasti',
                'Profile Picture': 'Foto del Profilo'
            },
            'pt': {
                'Medical Information': 'InformaÃ§Ãµes DietÃ©ticas',
                'Message': 'Mensagem',
                'Contact': 'Contato',
                'No contact listed.': 'Nenhum contato listado.',
                'No message available.': 'Nenhuma mensagem disponÃ­vel.',
                'Autoimmune disorder triggered by gluten': 'DistÃºrbio autoimune desencadeado pelo glÃºten',
                'Can cause severe intestinal damage': 'Pode causar danos intestinais graves',
                'Requires strict gluten-free diet': 'Requer dieta rigorosamente sem glÃºten',
                'Non-celiac gluten sensitivity': 'Sensibilidade ao glÃºten nÃ£o celÃ­aca',
                'Causes discomfort but not intestinal damage': 'Causa desconforto mas nÃ£o danos intestinais',
                'Requires gluten-free diet for symptom control': 'Requer dieta sem glÃºten para controle dos sintomas',
                'Immune system reaction to wheat proteins': 'ReaÃ§Ã£o do sistema imunolÃ³gico Ã s proteÃ­nas do trigo',
                'Can cause immediate allergy symptoms': 'Pode causar sintomas alÃ©rgicos imediatos',
                'May require assistance if severe': 'Pode requerer assistÃªncia se grave',
                'Requires avoidance of gluten-containing foods': 'Requer evitar alimentos contendo glÃºten',
                'Needs careful meal preparation': 'Necessita preparaÃ§Ã£o cuidadosa das refeiÃ§Ãµes',
                'Profile Picture': 'Foto do Perfil'
            },
            'ja': {
                'Medical Information': 'é£Ÿäº‹æƒ…å ±',
                'Message': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                'Contact': 'é€£çµ¡å…ˆ',
                'No contact listed.': 'é€£çµ¡å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚',
                'No message available.': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
                'Autoimmune disorder triggered by gluten': 'ã‚°ãƒ«ãƒ†ãƒ³ã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã‚‹è‡ªå·±å…ç–«ç–¾æ‚£',
                'Can cause severe intestinal damage': 'é‡ç¯¤ãªè…¸ã®æå‚·ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
                'Requires strict gluten-free diet': 'å³æ ¼ãªã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼é£Ÿäº‹ãŒå¿…è¦',
                'Non-celiac gluten sensitivity': 'éã‚»ãƒªã‚¢ãƒƒã‚¯æ€§ã‚°ãƒ«ãƒ†ãƒ³éæ•ç—‡',
                'Causes discomfort but not intestinal damage': 'ä¸å¿«æ„Ÿã‚’å¼•ãèµ·ã“ã—ã¾ã™ãŒè…¸ã®æå‚·ã¯ã‚ã‚Šã¾ã›ã‚“',
                'Requires gluten-free diet for symptom control': 'ç—‡çŠ¶ç®¡ç†ã®ãŸã‚ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼é£Ÿäº‹ãŒå¿…è¦',
                'Immune system reaction to wheat proteins': 'å°éº¦ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã«å¯¾ã™ã‚‹å…ç–«ç³»ã®åå¿œ',
                'Can cause immediate allergy symptoms': 'å³åº§ã«ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
                'May require assistance if severe': 'é‡ç¯¤ãªå ´åˆã¯æ´åŠ©ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™',
                'Requires avoidance of gluten-containing foods': 'ã‚°ãƒ«ãƒ†ãƒ³ã‚’å«ã‚€é£Ÿå“ã®å›é¿ãŒå¿…è¦',
                'Needs careful meal preparation': 'æ³¨æ„æ·±ã„é£Ÿäº‹ã®æº–å‚™ãŒå¿…è¦',
                'Profile Picture': 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ'
            },
            'zh': {
                'Medical Information': 'é¥®é£Ÿä¿¡æ¯',
                'Message': 'æ¶ˆæ¯',
                'Contact': 'è”ç³»äºº',
                'No contact listed.': 'æœªåˆ—å‡ºè”ç³»äººã€‚',
                'No message available.': 'æ²¡æœ‰å¯ç”¨çš„æ¶ˆæ¯ã€‚',
                'Autoimmune disorder triggered by gluten': 'ç”±éº¸è´¨å¼•å‘çš„è‡ªèº«å…ç–«æ€§ç–¾ç—…',
                'Can cause severe intestinal damage': 'å¯èƒ½å¯¼è‡´ä¸¥é‡çš„è‚ é“æŸä¼¤',
                'Requires strict gluten-free diet': 'éœ€è¦ä¸¥æ ¼çš„æ— éº¸è´¨é¥®é£Ÿ',
                'Non-celiac gluten sensitivity': 'éä¹³ç³œæ³»éº¸è´¨æ•æ„Ÿæ€§',
                'Causes discomfort but not intestinal damage': 'å¼•èµ·ä¸é€‚ä½†ä¸ä¼šé€ æˆè‚ é“æŸä¼¤',
                'Requires gluten-free diet for symptom control': 'éœ€è¦æ— éº¸è´¨é¥®é£Ÿæ¥æ§åˆ¶ç—‡çŠ¶',
                'Immune system reaction to wheat proteins': 'å…ç–«ç³»ç»Ÿå¯¹å°éº¦è›‹ç™½çš„ååº”',
                'Can cause immediate allergy symptoms': 'å¯èƒ½å¼•èµ·å³æ—¶è¿‡æ•ç—‡çŠ¶',
                'May require assistance if severe': 'å¦‚æœä¸¥é‡å¯èƒ½éœ€è¦ååŠ©',
                'Requires avoidance of gluten-containing foods': 'éœ€è¦é¿å…å«éº¸è´¨çš„é£Ÿç‰©',
                'Needs careful meal preparation': 'éœ€è¦ä»”ç»†çš„è†³é£Ÿå‡†å¤‡',
                'Profile Picture': 'ä¸ªäººç…§ç‰‡'
            },
            'ko': {
                'Medical Information': 'ì˜ë£Œ ì •ë³´',
                'Message': 'ë©”ì‹œì§€',
                'Contact': 'ì—°ë½ì²˜',
                'No contact listed.': 'ë“±ë¡ëœ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.',
                'No message available.': 'ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.',
                'Autoimmune disorder triggered by gluten': 'ê¸€ë£¨í…ì— ì˜í•´ ìœ ë°œë˜ëŠ” ìê°€ë©´ì—­ ì§ˆí™˜',
                'Can cause severe intestinal damage': 'ì‹¬ê°í•œ ì¥ ì†ìƒì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤',
                'Requires strict gluten-free diet': 'ì—„ê²©í•œ ê¸€ë£¨í… í”„ë¦¬ ì‹ë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤',
                'Non-celiac gluten sensitivity': 'ë¹„ì…€ë¦¬ì•… ê¸€ë£¨í… ë¯¼ê°ì„±',
                'Causes discomfort but not intestinal damage': 'ë¶ˆí¸í•¨ì„ ìœ ë°œí•˜ì§€ë§Œ ì¥ ì†ìƒì€ ì—†ìŠµë‹ˆë‹¤',
                'Requires gluten-free diet for symptom control': 'ì¦ìƒ ì¡°ì ˆì„ ìœ„í•´ ê¸€ë£¨í… í”„ë¦¬ ì‹ë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤',
                'Immune system reaction to wheat proteins': 'ë°€ ë‹¨ë°±ì§ˆì— ëŒ€í•œ ë©´ì—­ê³„ ë°˜ì‘',
                'Can cause immediate allergy symptoms': 'ì¦‰ê°ì ì¸ ì•Œë ˆë¥´ê¸° ì¦ìƒì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤',
                'May require assistance if severe': 'ì‹¬ê°í•œ ê²½ìš° ë„ì›€ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤',
                'Requires avoidance of gluten-containing foods': 'ê¸€ë£¨í… í•¨ìœ  ì‹í’ˆì˜ íšŒí”¼ê°€ í•„ìš”í•©ë‹ˆë‹¤',
                'Needs careful meal preparation': 'ì‹ ì¤‘í•œ ì‹ì‚¬ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤',
                'Profile Picture': 'í”„ë¡œí•„ ì‚¬ì§„'
            },
            'ar': {
                'Medical Information': 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©',
                'Message': 'Ø±Ø³Ø§Ù„Ø©',
                'Contact': 'Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
                'No contact listed.': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ù…Ø¯Ø±Ø¬Ø©.',
                'No message available.': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©.',
                'Autoimmune disorder triggered by gluten': 'Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù…Ù†Ø§Ø¹Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© Ø§Ù„Ù†Ø§Ø¬Ù… Ø¹Ù† Ø§Ù„ØºÙ„ÙˆØªÙŠÙ†',
                'Can cause severe intestinal damage': 'ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ³Ø¨Ø¨ Ø¶Ø±Ø±Ù‹Ø§ Ù…Ø¹ÙˆÙŠÙ‹Ø§ Ø´Ø¯ÙŠØ¯Ù‹Ø§',
                'Requires strict gluten-free diet': 'ÙŠØªØ·Ù„Ø¨ Ù†Ø¸Ø§Ù…Ù‹Ø§ ØºØ°Ø§Ø¦ÙŠÙ‹Ø§ ØµØ§Ø±Ù…Ù‹Ø§ Ø®Ø§Ù„ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„ØºÙ„ÙˆØªÙŠÙ†',
                'Non-celiac gluten sensitivity': 'Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØºÙ„ÙˆØªÙŠÙ† ØºÙŠØ± Ø§Ù„Ø³ÙŠÙ„ÙŠØ§Ùƒ',
                'Causes discomfort but not intestinal damage': 'ÙŠØ³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø§Ø­Ø© ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³ Ø¶Ø±Ø±Ù‹Ø§ Ù…Ø¹ÙˆÙŠÙ‹Ø§',
                'Requires gluten-free diet for symptom control': 'ÙŠØªØ·Ù„Ø¨ Ù†Ø¸Ø§Ù…Ù‹Ø§ ØºØ°Ø§Ø¦ÙŠÙ‹Ø§ Ø®Ø§Ù„ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„ØºÙ„ÙˆØªÙŠÙ† Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶',
                'Immune system reaction to wheat proteins': 'Ø±Ø¯ ÙØ¹Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ù†Ø§Ø¹ÙŠ Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª Ø§Ù„Ù‚Ù…Ø­',
                'Can cause immediate allergy symptoms': 'ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ³Ø¨Ø¨ Ø£Ø¹Ø±Ø§Ø¶ Ø­Ø³Ø§Ø³ÙŠØ© ÙÙˆØ±ÙŠØ©',
                'May require assistance if severe': 'Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´Ø¯ÙŠØ¯Ù‹Ø§',
                'Requires avoidance of gluten-containing foods': 'ÙŠØªØ·Ù„Ø¨ ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØºÙ„ÙˆØªÙŠÙ†',
                'Needs careful meal preparation': 'ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¬Ø¨Ø§Øª Ø¨Ø¹Ù†Ø§ÙŠØ©',
                'Profile Picture': 'ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ'
            },
            'ru': {
                'Medical Information': 'ĞœĞµĞ´Ğ¸Ñ†Ğ¸Ğ½ÑĞºĞ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ',
                'Message': 'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ',
                'Contact': 'ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚',
                'No contact listed.': 'ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½.',
                'No message available.': 'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾.',
                'Autoimmune disorder triggered by gluten': 'ĞÑƒÑ‚Ğ¾Ğ¸Ğ¼Ğ¼ÑƒĞ½Ğ½Ğ¾Ğµ Ñ€Ğ°ÑÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾, Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ³Ğ»ÑÑ‚ĞµĞ½Ğ¾Ğ¼',
                'Can cause severe intestinal damage': 'ĞœĞ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ€ÑŒĞµĞ·Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞºĞ¸ÑˆĞµÑ‡Ğ½Ğ¸ĞºĞ°',
                'Requires strict gluten-free diet': 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ±ĞµĞ·Ğ³Ğ»ÑÑ‚ĞµĞ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ¸ĞµÑ‚Ñ‹',
                'Non-celiac gluten sensitivity': 'ĞĞµÑ†ĞµĞ»Ğ¸Ğ°ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğº Ğ³Ğ»ÑÑ‚ĞµĞ½Ñƒ',
                'Causes discomfort but not intestinal damage': 'Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¸ÑĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞºĞ¸ÑˆĞµÑ‡Ğ½Ğ¸ĞºĞ°',
                'Requires gluten-free diet for symptom control': 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ±ĞµĞ·Ğ³Ğ»ÑÑ‚ĞµĞ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ¸ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ ÑĞ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ğ¾Ğ²',
                'Immune system reaction to wheat proteins': 'Ğ ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ¸Ğ¼Ğ¼ÑƒĞ½Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ½Ğ° Ğ±ĞµĞ»ĞºĞ¸ Ğ¿ÑˆĞµĞ½Ğ¸Ñ†Ñ‹',
                'Can cause immediate allergy symptoms': 'ĞœĞ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ğ»Ğ»ĞµÑ€Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑĞ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹',
                'May require assistance if severe': 'ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ñ€Ğ¸ Ñ‚ÑĞ¶ĞµĞ»Ğ¾Ğ¼ Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğ¸',
                'Requires avoidance of gluten-containing foods': 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ², ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‰Ğ¸Ñ… Ğ³Ğ»ÑÑ‚ĞµĞ½',
                'Needs careful meal preparation': 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ‚Ñ‰Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¸Ñ‰Ğ¸',
                'Profile Picture': 'Ğ¤Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ'
            },
            'hi': {
                'Medical Information': 'à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',
                'Message': 'à¤¸à¤‚à¤¦à¥‡à¤¶',
                'Contact': 'à¤¸à¤‚à¤ªà¤°à¥à¤•',
                'No contact listed.': 'à¤•à¥‹à¤ˆ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¸à¥‚à¤šà¥€à¤¬à¤¦à¥à¤§ à¤¨à¤¹à¥€à¤‚à¥¤',
                'No message available.': 'à¤•à¥‹à¤ˆ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¨à¤¹à¥€à¤‚à¥¤',
                'Autoimmune disorder triggered by gluten': 'à¤—à¥à¤²à¥‚à¤Ÿà¥‡à¤¨ à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤Ÿà¥à¤°à¤¿à¤—à¤° à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾ à¤‘à¤Ÿà¥‹à¤‡à¤®à¥à¤¯à¥‚à¤¨ à¤µà¤¿à¤•à¤¾à¤°',
                'Can cause severe intestinal damage': 'à¤—à¤‚à¤­à¥€à¤° à¤†à¤‚à¤¤à¥‹à¤‚ à¤•à¥€ à¤•à¥à¤·à¤¤à¤¿ à¤•à¤¾ à¤•à¤¾à¤°à¤£ à¤¬à¤¨ à¤¸à¤•à¤¤à¤¾ à¤¹à¥ˆ',
                'Requires strict gluten-free diet': 'à¤¸à¤–à¥à¤¤ à¤—à¥à¤²à¥‚à¤Ÿà¥‡à¤¨-à¤«à¥à¤°à¥€ à¤†à¤¹à¤¾à¤° à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ à¤¹à¥ˆ',
                'Non-celiac gluten sensitivity': 'à¤—à¥ˆà¤°-à¤¸à¥€à¤²à¤¿à¤à¤• à¤—à¥à¤²à¥‚à¤Ÿà¥‡à¤¨ à¤¸à¤‚à¤µà¥‡à¤¦à¤¨à¤¶à¥€à¤²à¤¤à¤¾',
                'Causes discomfort but not intestinal damage': 'à¤…à¤¸à¥à¤µà¤¿à¤§à¤¾ à¤•à¤¾ à¤•à¤¾à¤°à¤£ à¤¬à¤¨à¤¤à¤¾ à¤¹à¥ˆ à¤²à¥‡à¤•à¤¿à¤¨ à¤†à¤‚à¤¤à¥‹à¤‚ à¤•à¥€ à¤•à¥à¤·à¤¤à¤¿ à¤¨à¤¹à¥€à¤‚',
                'Requires gluten-free diet for symptom control': 'à¤²à¤•à¥à¤·à¤£ à¤¨à¤¿à¤¯à¤‚à¤¤à¥à¤°à¤£ à¤•à¥‡ à¤²à¤¿à¤ à¤—à¥à¤²à¥‚à¤Ÿà¥‡à¤¨-à¤«à¥à¤°à¥€ à¤†à¤¹à¤¾à¤° à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ à¤¹à¥ˆ',
                'Immune system reaction to wheat proteins': 'à¤—à¥‡à¤¹à¥‚à¤‚ à¤ªà¥à¤°à¥‹à¤Ÿà¥€à¤¨ à¤•à¥‡ à¤²à¤¿à¤ à¤ªà¥à¤°à¤¤à¤¿à¤°à¤•à¥à¤·à¤¾ à¤ªà¥à¤°à¤£à¤¾à¤²à¥€ à¤•à¥€ à¤ªà¥à¤°à¤¤à¤¿à¤•à¥à¤°à¤¿à¤¯à¤¾',
                'Can cause immediate allergy symptoms': 'à¤¤à¤¤à¥à¤•à¤¾à¤² à¤à¤²à¤°à¥à¤œà¥€ à¤•à¥‡ à¤²à¤•à¥à¤·à¤£ à¤ªà¥ˆà¤¦à¤¾ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥ˆ',
                'May require assistance if severe': 'à¤—à¤‚à¤­à¥€à¤° à¤¹à¥‹à¤¨à¥‡ à¤ªà¤° à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾ à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ à¤¹à¥‹ à¤¸à¤•à¤¤à¥€ à¤¹à¥ˆ',
                'Requires avoidance of gluten-containing foods': 'à¤—à¥à¤²à¥‚à¤Ÿà¥‡à¤¨ à¤¯à¥à¤•à¥à¤¤ à¤–à¤¾à¤¦à¥à¤¯ à¤ªà¤¦à¤¾à¤°à¥à¤¥à¥‹à¤‚ à¤¸à¥‡ à¤¬à¤šà¤¨à¥‡ à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ à¤¹à¥ˆ',
                'Needs careful meal preparation': 'à¤¸à¤¾à¤µà¤§à¤¾à¤¨à¥€à¤ªà¥‚à¤°à¥à¤µà¤• à¤­à¥‹à¤œà¤¨ à¤¤à¥ˆà¤¯à¤¾à¤° à¤•à¤°à¤¨à¥‡ à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ à¤¹à¥ˆ',
                'Profile Picture': 'à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤šà¤¿à¤¤à¥à¤°'
            }
        };
        
        // Function to translate UI elements based on selected language
        function translateUIElements(langCode) {
            // If translations for this language don't exist, use English as fallback
            const langDict = translations[langCode.toLowerCase()] || translations['en'];
            console.log('Translating UI elements to', langCode, 'with dictionary:', langDict);
            
            // Find all elements with data-i18n attribute and translate them
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langDict[key]) {
                    element.textContent = langDict[key];
                }
            });
            
            console.log('UI elements translated to', langCode);
        }
        
        // Handle language change from dropdown
        function handleLanguageChange(e) {
            // Ensure language is lowercase
            const lang = this.value.toLowerCase();
            const prevLang = document.getElementById('active_language').value.toLowerCase();
            console.log('Language selected:', lang, 'Previous language:', prevLang);
            
            // Don't do anything if the language hasn't changed
            if (lang === prevLang) {
                return;
            }
            
            // For debugging
            console.log('Switching language from', prevLang, 'to', lang);
            
            // Update hidden input
            document.getElementById('active_language').value = lang;
            
            // Update all language selectors to match
            const langSelectors = document.querySelectorAll('.language-selector-dropdown');
            langSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = lang;
                }
            });
            
            // Update language display
            const displayElement = document.getElementById('current-language-display');
            if (displayElement) {
                displayElement.textContent = this.options[this.selectedIndex].text;
            }
                
            // Apply translations immediately for better UX
            translateUIElements(lang);
            
            // Show loading indicator in the card preview
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Translating...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data for language switch
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', lang);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Language switch failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                console.log('Received language switch response');
                
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with language:', lang);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Update the language tabs if they exist
                const languageTabs = document.querySelectorAll('.language-tab');
                if (languageTabs.length > 0) {
                    languageTabs.forEach(tab => {
                        const tabLang = tab.getAttribute('data-lang');
                        if (tabLang === lang) {
                            tab.setAttribute('aria-selected', 'true');
                            tab.classList.add('active-language');
                        } else {
                            tab.setAttribute('aria-selected', 'false');
                            tab.classList.remove('active-language');
                        }
                    });
                }
                
                // Restore scroll position
                window.scrollTo(0, scrollPosition);
            })
            .catch(error => {
                console.error('Error switching language:', error);
                // Restore original content if there was an error
                alert('There was an error switching languages. Please try again.');
            });
            
            // Store the language preference in localStorage for persistence
            localStorage.setItem('preferred_language', lang);
        }
        
        // Handle global language change (from top controls)
        function handleGlobalLanguageChange(lang) {
            // Update all language selectors including the one on the card
            const cardLanguageSelector = document.getElementById('language-selector');
            if (cardLanguageSelector) {
                cardLanguageSelector.value = lang;
                // Trigger the card's language change handler
                const event = new Event('change');
                cardLanguageSelector.dispatchEvent(event);
            } else {
                // Fallback if card selector doesn't exist
                handleLanguageChange.call({value: lang});
            }
        }
        
        // Handle theme change
        function handleThemeChange(e) {
            const theme = this.value;
            console.log('Theme selected:', theme);
            
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Get the current language
            const currentLang = document.getElementById('active_language').value;
            
            // Update all theme selectors to match
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                if (selector !== this) {
                    selector.value = theme;
                }
            });
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating theme...</div></div>';
            }
            
            // Save current scroll position
            const scrollPosition = window.scrollY;
            
            // Create form data specifically for theme update
            const formData = new FormData();
            formData.append('switch_theme', 'true'); // Changed from switch_language to switch_theme
            formData.append('active_language', currentLang);
            formData.append('preview_theme', theme);
            formData.append('selected_theme', theme); // Add this to ensure the theme is properly saved
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Send the update request
            fetch('{% url "message_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Theme update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Theme updated successfully to:', theme);
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                    setupThemeDropdowns();
                    
                    // Update theme preview buttons
                    updateThemeButtonStates(theme);
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating theme:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Theme update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up message textarea listeners
        function setupMessageTextareaListeners() {
            // Set up real-time message updates on typing
            const messageTextarea = document.getElementById('message');
            if (messageTextarea) {
                // Use input event for immediate feedback
                messageTextarea.addEventListener('input', debounce(function() {
                    const currentLang = document.getElementById('active_language').value;
                    console.log('Message updated for ' + currentLang + ':', this.value.substring(0, 20) + '...');
                    
                    // Create form data specifically for this update
                    const formData = new FormData();
                    formData.append('switch_language', 'true');
                    formData.append('active_language', document.getElementById('active_language').value);
                    formData.append('preview_theme', document.getElementById('selected-theme').value);
                    formData.append('csrfmiddlewaretoken', getCsrfToken());
                    
                    // Add the message content using the correct field name format
                    formData.append('message_' + currentLang.toLowerCase(), this.value);
                    
                    // Send the update request
                    fetch('{% url "message_cards:unified_card_management" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Message update failed: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Create a temporary element to parse the HTML response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract just the card preview content
                        const cardContent = tempDiv.querySelector('.card-inner');
                        if (cardContent) {
                            document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                            console.log('Message updated successfully in preview');
                            
                            // Make sure the dropdown has the correct value
                            const newDropdown = document.querySelector('.language-selector-dropdown');
                            if (newDropdown) {
                                newDropdown.value = currentLang;
                                setupLanguageDropdowns(); // Re-setup events for the new dropdown
                            }
                        } else {
                            console.error('Could not find card preview content in response');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating message in preview:', error);
                    });
                }, 300)); // 300ms debounce is good for typing
                
                // Auto-resize the textarea
                messageTextarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                
                // Initial height adjustment
                messageTextarea.style.height = 'auto';
                messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
            }
        }
        
        // Initialize responsive layout handling
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth < 1024; // lg breakpoint in Tailwind
            const previewSection = document.querySelector('.card-preview-section');
            const formSection = document.querySelector('.form-section:not(.card-preview-section)');
            
            if (previewSection && formSection) {
                if (isMobile) {
                    previewSection.parentNode.parentNode.classList.add('order-2');
                    formSection.parentNode.parentNode.classList.add('order-1');
                } else {
                    previewSection.parentNode.parentNode.classList.remove('order-2');
                    formSection.parentNode.parentNode.classList.remove('order-1');
                    previewSection.parentNode.parentNode.classList.add('order-1');
                    formSection.parentNode.parentNode.classList.add('order-2');
                }
            }
        }
        
        // Initial call
        handleResponsiveLayout();
        
        // Listen for resize events
        window.addEventListener('resize', debounce(function() {
            handleResponsiveLayout();
        }, 250));
        
        // Debounce helper function to limit how often a function runs
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Set theme from global theme buttons
        function setGlobalTheme(theme) {
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Update theme selector on card if it exists
            const cardThemeSelector = document.getElementById('theme-selector');
            if (cardThemeSelector) {
                cardThemeSelector.value = theme;
                // Trigger the card's theme change handler
                const event = new Event('change');
                cardThemeSelector.dispatchEvent(event);
            } else {
                // Fallback if card selector doesn't exist
                handleThemeChange.call({value: theme});
            }
            
            // Update theme button states
            updateThemeButtonStates(theme);
        }
        
        // Update theme preview button states
        function updateThemeButtonStates(activeTheme) {
            const themeButtons = document.querySelectorAll('.theme-button');
            themeButtons.forEach(button => {
                const themeName = button.getAttribute('onclick').match(/setGlobalTheme\('(.+?)'\)/)[1];
                if (themeName === activeTheme) {
                    button.classList.remove('border-transparent', 'hover:border-teal-700');
                    button.classList.add('border-teal-400');
                } else {
                    button.classList.remove('border-teal-400');
                    button.classList.add('border-transparent', 'hover:border-teal-700');
                }
            });
        }
        
        // Setup global selectors functionality
        function setupGlobalSelectors() {
            // Set save button action
            const saveButton = document.getElementById('save-card-button');
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    document.getElementById('save_card_input').value = 'true';
                    document.querySelector('form').submit();
                });
            }
            
            // Initialize hex copy buttons
            initializeHexCopyButtons();
            
            // Fix theme button previews with correct theme colors
            document.querySelectorAll('.theme-preview').forEach(preview => {
                const parent = preview.closest('.theme-button');
                if (!parent) return;
                
                const theme = parent.getAttribute('onclick').match(/setGlobalTheme\('(.+?)'\)/)[1];
                if (theme === 'celio') {
                    preview.style.backgroundColor = 'var(--spruce-950)';
                    preview.querySelector('span').style.color = 'var(--teal-200)';
                } else if (theme === 'dark') {
                    preview.style.backgroundColor = '#1a1a1a';
                    preview.querySelector('span').style.color = 'white';
                } else if (theme === 'minimal') {
                    preview.style.backgroundColor = '#f5f5f5';
                    preview.querySelector('span').style.color = '#333333';
                }
            });
            
            // Initialize theme button states
            const currentTheme = document.getElementById('selected-theme').value || 'celio';
            updateThemeButtonStates(currentTheme);
        }
        
        // Hex copy functionality
        function initializeHexCopyButtons() {
            const hexCopyButtons = document.querySelectorAll('.hex-copy-btn');
            const notification = document.getElementById('copy-notification');
            const message = document.getElementById('copy-message');
            
            hexCopyButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent theme selection when clicking hex buttons
                    const hexCode = this.getAttribute('data-hex');
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(hexCode).then(() => {
                        // Show notification
                        message.textContent = `Hex code ${hexCode} copied to clipboard!`;
                        notification.classList.remove('hidden');
                        
                        // Hide notification after 2 seconds
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy hex code:', err);
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = hexCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            message.textContent = `Hex code ${hexCode} copied to clipboard!`;
                        } catch (fallbackErr) {
                            message.textContent = 'Failed to copy hex code';
                        }
                        document.body.removeChild(textArea);
                        notification.classList.remove('hidden');
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    });
                });
            });
        }
        
        // Toggle guide function for mobile-optimized collapsible section
        window.toggleGuide = function() {
            const content = document.getElementById('guide-content');
            const chevron = document.getElementById('guide-chevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        };
        
        // Call setupGlobalSelectors to initialize everything
        setupGlobalSelectors();
    });
</script>
{% endblock %}
