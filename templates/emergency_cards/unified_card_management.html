{% extends 'base.html' %}
{% load static %}
{% load emergency_card_filters %}

{% block title %}{{ page_title }} - Celio{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/emergency_card_themes.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --spruce-950: #0a1613;
        --spruce-900: #0f211c;
        --spruce-800: #14322a;
        --spruce-700: #1a4237;
        --teal-600: #0d9488;
        --teal-500: #14b8a6;
        --teal-400: #2dd4bf;
        --teal-300: #5eead4;
        --teal-200: #99f6e4;
        --teal-100: #ccfbf1;
    }
    
    body {
        background-color: var(--spruce-950);
        color: white;
    }
    
    /* Responsive order */
    @media (max-width: 1024px) {
        .order-1 {
            order: 2;
        }
        
        .order-2 {
            order: 1;
        }
    }
    
    /* Section styling */
    .form-section {
        background-color: var(--spruce-800);
        background-color: rgba(20, 50, 42, 0.2);
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.75rem;
        border: 1px solid rgba(26, 66, 55, 0.5);
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        padding: 0;
        border-bottom: 1px solid rgba(26, 66, 55, 0.7);
        background-color: transparent;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header h2 {
        color: white;
        font-weight: 600;
    }
    
    /* Improved form controls */
    .form-group {
        margin-bottom: 2.25rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--teal-100);
        margin-bottom: 0.75rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        background-color: rgba(20, 50, 42, 0.2);
        color: white;
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
        color: rgba(94, 234, 212, 0.5);
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--teal-400);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
    }
    
    .form-textarea {
        min-height: 8rem;
    }
    
    .form-hint {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--teal-300);
    }
    
    .error-text {
        color: #f87171;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Action buttons with improved styling */
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .action-button-primary {
        background-color: var(--teal-600);
        color: white;
        border: none;
    }
    
    .action-button-primary:hover {
        background-color: var(--teal-500);
    }
    
    .action-button-secondary {
        background-color: rgba(20, 50, 42, 0.4);
        color: white;
        border: 1px solid var(--spruce-700);
    }
    
    .action-button-secondary:hover {
        background-color: rgba(20, 50, 42, 0.6);
    }
    
    /* Intro panel */
    .intro-panel {
        background-color: rgba(20, 50, 42, 0.25);
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(26, 66, 55, 0.5);
        margin-bottom: 2rem;
        backdrop-filter: blur(8px);
    }
    
    .intro-panel h3 {
        color: white;
    }
    
    .intro-panel p {
        color: var(--teal-200);
    }
    
    .dismiss-intro {
        color: var(--teal-400);
    }
    
    .dismiss-intro:hover {
        color: var(--teal-300);
    }
    
    /* Language tabs */
    .language-tab {
        color: var(--teal-300);
        border-bottom-color: transparent;
    }
    
    .language-tab[aria-selected="true"] {
        color: white;
        border-bottom-color: var(--teal-400);
    }
    
    .language-tab:hover:not([aria-selected="true"]) {
        color: var(--teal-200);
    }
    
    /* Card preview style */
    #card-preview {
        background-color: var(--spruce-900);
        border: 1px solid var(--spruce-700);
        border-radius: 0.5rem;
    }
    
    /* Spruce gradient background */
    .spruce-gradient-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -10;
        background: var(--spruce-950);
        overflow: hidden;
    }
    
    .spruce-gradient-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.6;
        background: radial-gradient(ellipse at center, var(--spruce-900) 0%, transparent 70%);
    }
    
    .gradient-accent {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
    }
    
    .gradient-accent-1 {
        width: 60vw;
        height: 60vw;
        background: rgba(20, 184, 166, 0.15);
        top: -10%;
        right: -10%;
    }
    
    .gradient-accent-2 {
        width: 40vw;
        height: 40vw;
        background: rgba(45, 212, 191, 0.1);
        bottom: -10%;
        left: -10%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Spruce gradient background -->
<div class="spruce-gradient-bg">
    <div class="spruce-gradient-overlay"></div>
    <div class="gradient-accent gradient-accent-1"></div>
    <div class="gradient-accent gradient-accent-2"></div>
</div>

<div class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white">{{ page_title }}</h1>
            <p class="mt-1 text-sm text-teal-300">Create and customize your emergency medical card.</p>
            
            <!-- Action buttons -->
            <div class="mt-3 flex flex-wrap gap-3">
                <a href="{% url 'emergency_cards:fullscreen_card' %}" class="action-button action-button-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 4l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
                    </svg>
                    View Fullscreen
                </a>
                <a href="{% url 'emergency_cards:download_card' %}" class="action-button action-button-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download Card
                </a>
                <a href="{% url 'emergency_cards:share_card' %}" class="action-button action-button-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    Share Card
                </a>
            </div>
        </div>
        
        <form method="POST" enctype="multipart/form-data" id="card-form">
            {% csrf_token %}
            
            <!-- Hidden input to track active language -->
            <input type="hidden" name="active_language" id="active_language" value="{{ current_lang }}">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Card Preview (Left Side) -->
                <div class="lg:col-span-5 xl:col-span-4 order-2 lg:order-1">
                    <div class="lg:sticky lg:top-6">
                        <!-- Card Preview Section -->
                        <div class="preview-section flex flex-col h-full">
                            <div class="section-header mb-4">
                                <h2 class="text-xl font-semibold text-white">Card Preview</h2>
                            </div>
                            
                            <!-- Card Controls Outside Card -->
                            <div class="card-controls flex flex-wrap gap-4 bg-spruce-800 bg-opacity-30 p-3 rounded-lg mb-4">
                                <!-- Language Selector -->
                                <div class="language-control flex-1">
                                    <label for="language-selector" class="block text-sm font-medium text-teal-300 mb-1">Language</label>
                                    <select id="language-selector" class="language-selector-dropdown w-full bg-white text-gray-800 rounded-md px-3 py-2 border border-spruce-600 focus:ring-2 focus:ring-teal-500">
                                        {% for lang_code, lang_name in language_choices %}
                                        <option value="{{ lang_code }}" {% if current_lang == lang_code %}selected{% endif %}>{{ lang_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Theme Selector -->
                                <div class="theme-control flex-1">
                                    <label for="theme-selector" class="block text-sm font-medium text-teal-300 mb-1">Theme</label>
                                    <select id="theme-selector" class="theme-selector-dropdown w-full bg-white text-gray-800 rounded-md px-3 py-2 border border-spruce-600 focus:ring-2 focus:ring-teal-500">
                                        <option value="pastel" {% if preview_theme == 'pastel' or card.theme == 'pastel' %}selected{% endif %}>Pastel Theme</option>
                                        <option value="luxury" {% if preview_theme == 'luxury' or card.theme == 'luxury' %}selected{% endif %}>Luxury Theme</option>
                                        <option value="medical" {% if preview_theme == 'medical' or card.theme == 'medical' %}selected{% endif %}>Medical Theme</option>
                                        {% for theme_code, theme_name in theme_choices %}
                                            {% if theme_code != 'pastel' and theme_code != 'luxury' and theme_code != 'medical' %}
                                            <option value="{{ theme_code }}" {% if preview_theme == theme_code or card.theme == theme_code %}selected{% endif %}>{{ theme_name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Card Preview Container -->
                            <div id="card-preview-container" class="relative overflow-auto flex-grow bg-white bg-opacity-5 rounded-lg p-4">
                                {% include "emergency_cards/partials/clean_preview.html" %}
                            </div>
                        </div>
                        
                        <!-- Hidden theme input that will be updated by JavaScript -->
                        <input type="hidden" name="theme" id="selected-theme" value="{{ card.theme|default:'minimal' }}">
                    </div>
                </div>
                
                <!-- Form Panels (Right Side) -->
                <div class="lg:col-span-7 xl:col-span-8 order-1 lg:order-2">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                            <h2 class="text-lg font-medium text-white">Basic Information</h2>
                        </div>
                        <div class="form-section-body">
                            <!-- User's Full Name -->
                            <div class="form-group mb-6">
                                <label for="user_name" class="form-label">
                                    Your Full Name
                                </label>
                                <input type="text" 
                                       name="user_name" 
                                       id="user_name" 
                                       value="{{ card.user_name|default:user.get_full_name }}"
                                       class="form-input"
                                       placeholder="John Doe"
                                       hx-post="{% url 'emergency_cards:unified_card_management' %}"
                                       hx-trigger="change delay:500ms"
                                       hx-target="#card-preview"
                                       hx-include="#active_language">
                                <p class="form-hint">This will be displayed on your emergency card.</p>
                            </div>
                            
                            <!-- Medical Condition -->
                            <div class="form-group">
                                <label for="{{ form.condition.id_for_label }}" class="form-label">
                                    What is your medical condition?
                                </label>
                                <select name="{{ form.condition.name }}" id="{{ form.condition.id_for_label }}"
                                        class="form-select"
                                        hx-post="{% url 'emergency_cards:unified_card_management' %}"
                                        hx-trigger="change"
                                        hx-target="#card-preview"
                                        hx-include="#active_language">
                                    {% for value, text in form.condition.field.choices %}
                                        <option value="{{ value }}" {% if form.condition.value == value %}selected{% endif %}>
                                            {{ text }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <p class="form-hint">This will be prominently displayed on your emergency card.</p>
                                {% if form.condition.errors %}
                                    <p class="error-text">{{ form.condition.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <!-- Profile Picture -->
                            <div class="form-group mt-8">
                                <h3 class="form-label mb-3">Do you want to add a profile picture? (Optional)</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        {% if card and card.profile_picture %}
                                            <div class="mb-6">
                                                <img src="{{ card.profile_picture.url }}" alt="Current Profile Picture" class="w-32 h-32 rounded-full object-cover border-2 border-deep-teal">
                                            </div>
                                        {% else %}
                                            <div class="mb-6 w-32 h-32 rounded-full bg-gray-100 flex items-center justify-center border border-gray-200">
                                                <svg class="h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                        {% endif %}
                                        
                                        <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                                            Upload or Replace Picture
                                        </label>
                                        <input type="file" name="{{ form.profile_picture.name }}" id="{{ form.profile_picture.id_for_label }}" accept="image/*" 
                                               class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-deep-teal file:text-white hover:file:bg-deep-teal-2">
                                        {% if form.profile_picture.errors %}
                                            <p class="error-text">{{ form.profile_picture.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <div>
                                            <label class="inline-flex items-center mb-3">
                                                <input type="checkbox" name="{{ form.show_profile_pic.name }}" 
                                                       {% if form.show_profile_pic.value %}checked{% endif %}
                                                       class="rounded border-teal-300 text-teal-500 focus:ring-teal-400 h-5 w-5">
                                                <span class="ml-3 text-base text-teal-500 font-medium">Show profile picture on my card</span>
                                            </label>
                                            {% if form.show_profile_pic.errors %}
                                                <p class="error-text">{{ form.show_profile_pic.errors.0 }}</p>
                                            {% endif %}
                                            <p class="text-sm text-teal-200">
                                                A profile picture can help medical personnel identify you in an emergency situation.
                                                Your picture will only appear if you check this option.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medical Message -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-4">
                            <h2 class="text-lg font-medium text-white">Your Emergency Message</h2>
                        </div>
                        
                        <!-- Translation Information -->
                        {% if is_translated %}
                        <div class="p-2 mb-4 bg-teal-50 text-teal-700 rounded border border-teal-200 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                            </svg>
                            <span>You're viewing content in {{ current_lang_display }}. Some content may be machine-translated.</span>
                        </div>
                        {% endif %}
                        
                        <!-- Predefined Message Section -->
                        <div class="mb-4">
                            <h3 class="text-md font-medium text-teal-200 mb-2">Standard Medical Information</h3>
                            <div class="p-3 bg-gray-50 rounded-md border border-gray-200 text-gray-700">
                                {% if card and card.condition %}
                                    <p>{{ card.get_message|linebreaksbr }}</p>
                                {% else %}
                                    <p class="text-gray-500 italic">Medical information will appear here based on your selected condition.</p>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-300 mt-1">This standard message is professionally translated into all supported languages.</p>
                        </div>
                        
                        <!-- Custom Note -->
                        <div class="mb-6">
                            <h3 class="text-md font-medium text-teal-200 mb-2">Personal Note (Optional)</h3>
                            <textarea id="custom_note" name="custom_note" class="w-full h-24 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white text-gray-800"
                                      placeholder="Add any personal details you'd like to include on your emergency card...">{{ card.get_custom_note|default:'' }}</textarea>
                            <p class="text-sm text-gray-300 mt-1">This personal note will be automatically translated when you switch languages.</p>
                        </div>
                    </div>
                    
                    <!-- Emergency Contact -->
                    <div class="form-section">
                        <div class="form-section-header border-b border-gray-200 pb-3 mb-6">
                            <h2 class="text-lg font-medium text-white">Emergency Contact Information</h2>
                        </div>
                        <div class="form-section-body">
                            <p class="text-base text-teal-200 mb-8">
                                Who should be contacted in case of an emergency? This information will be displayed on your card.
                            </p>
                            
                            <div class="space-y-12">
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label">
                                        Contact Name
                                    </label>
                                    <input type="text" name="{{ form.emergency_contact_name.name }}" id="{{ form.emergency_contact_name.id_for_label }}" 
                                           value="{{ form.emergency_contact_name.value|default:'' }}"
                                           placeholder="Enter the full name of your emergency contact"
                                           class="form-input"
                                           hx-post="{% url 'emergency_cards:validate_field' %}"
                                           hx-trigger="blur"
                                           hx-target="#emergency_contact_name_error"
                                           hx-swap="innerHTML"
                                           hx-vals='{"field_name": "emergency_contact_name"}'>
                                    <div id="emergency_contact_name_error" class="error-text">
                                        {% if form.emergency_contact_name.errors %}
                                            {{ form.emergency_contact_name.errors.0 }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_relationship.id_for_label }}" class="form-label">
                                        Relationship to You
                                    </label>
                                    <input type="text" name="{{ form.emergency_contact_relationship.name }}" id="{{ form.emergency_contact_relationship.id_for_label }}" 
                                           value="{{ form.emergency_contact_relationship.value|default:'' }}"
                                           placeholder="Example: Spouse, Parent, Sibling, Friend"
                                           class="form-input"
                                           hx-post="{% url 'emergency_cards:validate_field' %}"
                                           hx-trigger="blur"
                                           hx-target="#emergency_contact_relationship_error"
                                           hx-swap="innerHTML"
                                           hx-vals='{"field_name": "emergency_contact_relationship"}'>
                                    <div id="emergency_contact_relationship_error" class="error-text">
                                        {% if form.emergency_contact_relationship.errors %}
                                            {{ form.emergency_contact_relationship.errors.0 }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label">
                                        Phone Number
                                    </label>
                                    <input type="tel" name="{{ form.emergency_contact_phone.name }}" id="{{ form.emergency_contact_phone.id_for_label }}" 
                                           value="{{ form.emergency_contact_phone.value|default:'' }}"
                                           placeholder="+1 (555) 123-4567"
                                           class="form-input"
                                           hx-post="{% url 'emergency_cards:validate_field' %}"
                                           hx-trigger="blur"
                                           hx-target="#emergency_contact_phone_error"
                                           hx-swap="innerHTML"
                                           hx-vals='{"field_name": "emergency_contact_phone"}'>
                                    <div id="emergency_contact_phone_error" class="error-text">
                                        {% if form.emergency_contact_phone.errors %}
                                            {{ form.emergency_contact_phone.errors.0 }}
                                        {% endif %}
                                    </div>
                                    <p class="form-hint">Include country code if needed (e.g., +1 for US and Canada)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex justify-end pt-6 pb-12">
                        <button type="submit" class="action-button action-button-primary text-base px-8 py-4">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save My Emergency Card
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent form submission which causes page refresh
        const cardForm = document.getElementById('card-form');
        cardForm.addEventListener('submit', function(e) {
            const isSubmitButton = e.submitter && e.submitter.type === 'submit' && e.submitter.classList.contains('action-button-primary');
            if (!isSubmitButton) {
                e.preventDefault(); // Only let the form submit when using the save button
            }
        });
        
        // Store the current scroll position
        function saveScrollPosition() {
            window.sessionStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);
        }
        
        // Restore the scroll position
        function restoreScrollPosition() {
            const savedPosition = window.sessionStorage.getItem('scrollPosition');
            if (savedPosition) {
                window.scrollTo(0, savedPosition);
            }
        }
        
        // Get CSRF token from cookie
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            if (!cookieValue) {
                console.error('CSRF token not found in cookies');
            }
            
            return cookieValue;
        }
        
        // Function to update the card preview with HTMX
        function updateCardPreview() {
            const currentLang = document.getElementById('active_language').value;
            const selectedTheme = document.getElementById('theme-selector').value;
            const messageTextarea = document.getElementById('message');
            
            console.log('Updating preview with theme:', selectedTheme, 'and language:', currentLang);
            
            // Create form data for the update
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', currentLang);
            formData.append('preview_theme', selectedTheme);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message 
            if (messageTextarea) {
                formData.append('message_' + currentLang.toLowerCase(), messageTextarea.value);
            }
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating preview...</div></div>';
            }
            
            // Send the update request
            fetch('{% url "emergency_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully with theme:', selectedTheme);
                    
                    // Update the hidden theme input
                    document.getElementById('selected-theme').value = selectedTheme;
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up language selector handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup for all dropdowns that might be in the DOM
            setupLanguageDropdowns();
            setupThemeDropdowns();
            
            // Set up live preview updates for message changes
            setupMessageTextareaListeners();
        });
        
        // Function to set up all language dropdowns in the DOM
        function setupLanguageDropdowns() {
            const dropdowns = document.querySelectorAll('.language-selector-dropdown');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', handleLanguageChange);
            });
        }
        
        // Function to set up all theme dropdowns
        function setupThemeDropdowns() {
            const themeSelectors = document.querySelectorAll('.theme-selector-dropdown');
            themeSelectors.forEach(selector => {
                selector.addEventListener('change', handleThemeChange);
            });
        }
        
        // Handle language change from dropdown
        function handleLanguageChange(e) {
            const lang = this.value;
            const prevLang = document.getElementById('active_language').value;
            console.log('Language selected:', lang, 'Previous language:', prevLang);
            
            // Don't do anything if the language hasn't changed
            if (lang === prevLang) {
                return;
            }
            
            // Update the textarea name to match the previous language (since we're sending the current content)
            const messageTextarea = document.getElementById('message');
            if (messageTextarea) {
                messageTextarea.name = 'message_' + prevLang.toLowerCase();
            }
            
            // Update hidden input
            document.getElementById('active_language').value = lang;
            
            // Update language display
            document.getElementById('current-language-display').textContent = 
                this.options[this.selectedIndex].text;
            
            // Show loading indicator in the card preview
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Translating...</div></div>';
            }
            
            // Update card preview - create a new FormData object for each request
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', lang);
            formData.append('previous_language', prevLang); // Send the previous language for translation
            formData.append('preview_theme', document.getElementById('selected-theme').value);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message to the form data
            if (messageTextarea) {
                formData.append('message_' + prevLang.toLowerCase(), messageTextarea.value);
            }
            
            // Make a direct fetch request for language change
            fetch('{% url "emergency_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Language switch failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Language updated successfully to:', lang);
                    
                    // Make sure the dropdown has the correct value
                    const newDropdown = document.querySelector('.language-selector-dropdown');
                    if (newDropdown) {
                        newDropdown.value = lang;
                        setupLanguageDropdowns(); // Re-setup events for the new dropdown
                    }
                    
                    // Update the message textarea with the translated content
                    const messageElement = tempDiv.querySelector('.message-content');
                    if (messageElement && messageTextarea) {
                        const translatedText = messageElement.getAttribute('data-message-text') || '';
                        messageTextarea.value = translatedText;
                        messageTextarea.name = 'message_' + lang.toLowerCase();
                        console.log('Updated textarea with translated message for', lang);
                        
                        // Show the translation indicator
                        const translationIndicator = document.getElementById('translation-indicator');
                        if (translationIndicator) {
                            translationIndicator.classList.remove('hidden');
                            
                            // Hide the indicator after 5 seconds
                            setTimeout(() => {
                                translationIndicator.classList.add('hidden');
                            }, 5000);
                        }
                        
                        // Auto-resize the textarea to fit the new content
                        messageTextarea.style.height = 'auto';
                        messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
                    }
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating language:', error);
                
                // Show error message in the preview
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Translation error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Handle theme change
        function handleThemeChange(e) {
            const theme = this.value;
            console.log('Theme selected:', theme);
            
            // Update hidden input
            document.getElementById('selected-theme').value = theme;
            
            // Update card preview with new theme
            updateCardPreview();
        }
        
        // Function to update card preview when theme changes
        function updateCardPreview() {
            const currentLang = document.getElementById('active_language').value;
            const selectedTheme = document.getElementById('selected-theme').value;
            const messageTextarea = document.getElementById('message');
            
            // Create form data for the update
            const formData = new FormData();
            formData.append('switch_language', 'true');
            formData.append('active_language', currentLang);
            formData.append('preview_theme', selectedTheme);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Add the current message 
            if (messageTextarea) {
                formData.append('message_' + currentLang.toLowerCase(), messageTextarea.value);
            }
            
            // Show loading indicator
            const cardPreviewContainer = document.getElementById('card-preview-container');
            if (cardPreviewContainer) {
                cardPreviewContainer.classList.add('loading');
                cardPreviewContainer.innerHTML = '<div class="loading-indicator flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-teal-500"></div><div class="ml-3 text-teal-300">Updating preview...</div></div>';
            }
            
            // Send the update request
            fetch('{% url "emergency_cards:unified_card_management" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview update failed: ' + response.statusText);
                }
                return response.text();
            })
            .then(html => {
                // Create a temporary element to parse the HTML response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract just the card preview content
                const cardContent = tempDiv.querySelector('.card-inner');
                if (cardContent) {
                    document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                    console.log('Preview updated successfully');
                    
                    // Refresh event handlers for any new elements
                    setupLanguageDropdowns();
                } else {
                    console.error('Could not find card preview content in response');
                }
                
                // Restore scroll position if needed
                setTimeout(restoreScrollPosition, 50);
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                
                // Show error message
                if (cardPreviewContainer) {
                    cardPreviewContainer.innerHTML = `
                        <div class="error-message p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                            <p class="font-bold">Update error</p>
                            <p>${error.message}</p>
                            <button class="mt-2 px-3 py-1 bg-red-700 text-white rounded text-sm" 
                                    onclick="window.location.reload()">Reload page</button>
                        </div>
                    `;
                }
            });
        }
        
        // Set up message textarea listeners
        function setupMessageTextareaListeners() {
            // Set up real-time message updates on typing
            const messageTextarea = document.getElementById('message');
            if (messageTextarea) {
                // Use input event for immediate feedback
                messageTextarea.addEventListener('input', debounce(function() {
                    const currentLang = document.getElementById('active_language').value;
                    console.log('Message updated for ' + currentLang + ':', this.value.substring(0, 20) + '...');
                    
                    // Create form data specifically for this update
                    const formData = new FormData();
                    formData.append('switch_language', 'true');
                    formData.append('active_language', document.getElementById('active_language').value);
                    formData.append('preview_theme', document.getElementById('selected-theme').value);
                    formData.append('csrfmiddlewaretoken', getCsrfToken());
                    
                    // Add the message content using the correct field name format
                    formData.append('message_' + currentLang.toLowerCase(), this.value);
                    
                    // Send the update request
                    fetch('{% url "emergency_cards:unified_card_management" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Message update failed: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Create a temporary element to parse the HTML response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract just the card preview content
                        const cardContent = tempDiv.querySelector('.card-inner');
                        if (cardContent) {
                            document.getElementById('card-preview-container').innerHTML = cardContent.outerHTML;
                            console.log('Message updated successfully in preview');
                            
                            // Make sure the dropdown has the correct value
                            const newDropdown = document.querySelector('.language-selector-dropdown');
                            if (newDropdown) {
                                newDropdown.value = currentLang;
                                setupLanguageDropdowns(); // Re-setup events for the new dropdown
                            }
                        } else {
                            console.error('Could not find card preview content in response');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating message in preview:', error);
                    });
                }, 300)); // 300ms debounce is good for typing
                
                // Auto-resize the textarea
                messageTextarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                
                // Initial height adjustment
                messageTextarea.style.height = 'auto';
                messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
            }
        }
        
        // Initialize responsive layout handling
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth < 1024; // lg breakpoint in Tailwind
            const previewSection = document.querySelector('.card-preview-section');
            const formSection = document.querySelector('.form-section:not(.card-preview-section)');
            
            if (previewSection && formSection) {
                if (isMobile) {
                    previewSection.parentNode.parentNode.classList.add('order-2');
                    formSection.parentNode.parentNode.classList.add('order-1');
                } else {
                    previewSection.parentNode.parentNode.classList.remove('order-2');
                    formSection.parentNode.parentNode.classList.remove('order-1');
                    previewSection.parentNode.parentNode.classList.add('order-1');
                    formSection.parentNode.parentNode.classList.add('order-2');
                }
            }
        }
        
        // Initial call
        handleResponsiveLayout();
        
        // Listen for resize events
        window.addEventListener('resize', debounce(function() {
            handleResponsiveLayout();
        }, 250));
        
        // Debounce helper function to limit how often a function runs
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }
    });
</script>
{% endblock %}
